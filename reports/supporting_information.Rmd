---
title: "Supporting Information: A dynamic fleet model of U.S light-duty vehicle lightweighting and associated greenhouse gas emissions from 2016-2050"
bibliography: bib_si_paper1_ford.bib
link-citations: no
csl: environmental-science-and-technology.csl
output:
  word_document:
    reference_docx: reference_style_rmarkedown.docx
fig_caption: TRUE
---
*Alexandre Milovanoff^a^, Hyung Chul Kim^b^, Robert De Kleine^b^, Timothy J. Wallington^b^, I. Daniel Posen^a^, Heather L. MacLean^a,c^  
^a^: Department of Civil & Mineral Engineering, University of Toronto, 35 St. George Street, Toronto, Ontario, M5S 1A4 Canada  
^b^: Materials & Manufacturing R&A Department, Ford Motor Company, Dearborn, Michigan 48121-2053, United States  
^c^: Department of Chemical Engineering & Applied Chemistry, University of Toronto, 200 College Street, Toronto, Ontario, M5S 3E5 Canada  
Corresponding Author: alexandre.milovanoff@mail.utoronto.ca*  


```{r setup, include=FALSE}
fig_num<-0
tab_num<-0
fig_name<-TRUE
tab_name<-TRUE
knitr::opts_chunk$set(
	echo = FALSE,
	fig.keep = "all",
	fig.show = "asis",
	message = FALSE,
	warning = FALSE,
	dev='png',
	dpi=300
)
knitr::opts_knit$set(root.dir = '../')

#Libraries
library(knitr)
library(ggplot2)
library(cowplot)
library(RColorBrewer)
library(scales)
library(ggrepel)
library(ggthemes)
library(readxl)
library(scales)
library(reshape2)
#Defines the themes of the plots
theme_milovanoff <- function(base_size=14, base_family="Helvetica",legend_position="bottom") {
  theme_tmp<-theme_foundation(base_size=base_size, base_family=base_family)+
    theme(plot.title = element_text(face = "bold",size = rel(1.2), hjust = 0.5),
          text = element_text(),
          panel.background = element_rect(colour = NA),
          plot.background = element_rect(colour = NA),
          panel.border = element_rect(colour = NA),
          axis.title = element_text(face = "bold",size = rel(1)),
          axis.title.y = element_text(angle=90,vjust = 0),
          axis.title.x = element_text(vjust = 0.5),
          axis.text = element_text(), 
          axis.line = element_line(colour="black"),
          axis.ticks = element_line(),
          panel.grid.major = element_line(colour="#f0f0f0"),
          panel.grid.minor = element_blank(),
          legend.key = element_rect(colour = NA),
          legend.key.height = unit(0.4, "cm"),
          legend.key.width = unit(0.4, "cm"),
          legend.margin = margin(t=0.1,r=0.1,b=0.1,l=0.1, "cm"),
          legend.text = element_text(),
          legend.spacing.x = unit(0.2, "cm"),
          legend.spacing.y = unit(0.2, "cm"),
          plot.margin=unit(c(5,5,5,5),"mm"),
          strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
          strip.text = element_text(face="bold"),
          panel.spacing.x = unit(0.2, "cm"),
          panel.spacing.y =unit(0.2, "cm")
    )
  if (legend_position=="bottom"){
    theme_tmp<-theme_tmp+
      theme(legend.box = "vertical",
            legend.box.just = "top",
            legend.position = "bottom",
            legend.direction = "horizontal",
            legend.title = element_text(face="italic",rel(1.1),hjust=0.5))
  } else if (legend_position=="right"){
    theme_tmp<-theme_tmp+
      theme(legend.box = "vertical",
            legend.box.just = "left",
            legend.position = "right",
            legend.direction = "vertical",
            legend.title = element_text(face="italic",rel(1.1),hjust=0))
  }
  return(theme_tmp)
}
palette_milovanoff <- c("#0072B2", "#ec7014","#009E73","#ef3b2c","#662506","#56B4E9","#fdb462","#CC79A7","#999999","#c51b7d","#D55E00","#F0E442","#E69F00")
colorblind_f_palette1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
scale_fill_milovanoff <- function(...){
  discrete_scale("fill","milovanoff",manual_pal(values = palette_milovanoff), ...)
  
}

scale_colour_milovanoff <- function(...){
  discrete_scale("colour","milovanoff",manual_pal(values = palette_milovanoff), ...)
  
}
```


This document provides a detailed description of the model developed in the paper "A dynamic fleet model of U.S light-duty vehicle lightweighting and associated greenhouse gas emissions from 2016-2050" (sections 1-5), followed by additional model results (section 6) and discussion (section 7). In addition, a GitHub repository is accessible free of charge that contains all inputs, codes and numerical results associated with this study (https://github.com/amilovanoff/est_milovanoff_et_al_2018).  


#Acronyms

AEO: Annual Energy Outlook   
BEV: Battery Electric Vehicle     
CNG: Compressed Natural Gas Internal Combustion Engine Vehicle  
FCV: Fuel Cell Vehicle   
FFV: Flex-Fuel Internal Combustion Engine Vehicle    
FRV: Fuel Reduction Value  
GHG: Greenhouse Gas  
HEV: Hybrid Electric Vehicle   
HSS/AHSS: High Strength Steel and Advanced High Strength Steel  
ICEV-D: Diesel Internal Combustion Engine Vehicle  
ICEV-G: Gasoline Internal Combustion Engine Vehicle  
LCA: Life Cycle Assessment  
LDV: Light-duty Vehicle  
PHEV: Plug-in Hybrid Electric Vehicle    
VKT: Vehicle Kilometers Travelled  

#SI.1 The FLAME model framework

A fleet-based life cycle model, the FLAME model (Fleet Life cycle Assessment and Material-flow Estimation) is developed for the U.S. light-duty fleet from 2016 to 2050. Four modules (vehicle, fleet, automotive material flow and LCA modules) are developed and are linked to comprise the FLAME model (Figure SI.`r fig_num+1`). The vehicle module establishes the historical and projected vehicle characteristics by vehicle type. The vehicle module includes the lightweighting submodule that simulates the vehicle characteristics for different lightweighting scenarios for 2016 onwards. The fleet module calculates the annual fleet stock and fleet kilometers traveled by vehicle type and age, and finally the associated fleet fuel use. Then, the automotive material flow module annually estimates the quantity of recovered material available from scrapped vehicles, along with consumption of primary and secondary (recycled) materials for new vehicle production. Finally, the LCA module couples outputs from all other modules with fuel and material emission factors to calculate the annual life cycle GHG emissions of the light-duty vehicle fleet.    

```{r model_framework}
fig_cap="The FLAME Model Framework"
fig_num<-fig_num+1
```

![`r paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)`](figures_reports/modele_framework.png)

The modules are detailed in the following sections.  

#SI.2 Vehicle module


##SI.2.1 Description of vehicle technologies and categories

The vehicle module associates to all vehicle types a material composition, a curb weight and a fuel consumption value for every year considered in the study.  
There are eight vehicle technologies considered in this study and two of them (i.e., BEV and PHEV) are dissociated into short range and long range. Table SI.`r tab_num+1` contains the technical descriptions of the considered technologies.  
```{r techno_description}
technology_description <-read_excel("reports/tables_SI_paper1.xlsx",sheet = "technology_type", skip = 1)
technology_description[is.na(technology_description)]<-""
tab_cap="Vehicle technology descriptions"
tab_num=tab_num+1
knitr::kable(technology_description,
             row.names = FALSE,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```

In addition, the light-duty vehicles are divided into two size categories, car and the light truck, in accordance with the U.S. Environmental Protection Agency (U.S. EPA) definitions [@UnitedStatesEnvironmentalProtectionAgency2016]. Table SI.`r tab_num+1` contains the description of the classes.

```{r size_description}
size_description <-read_excel("reports/tables_SI_paper1.xlsx",sheet = "size", skip = 1)
size_description[is.na(size_description)]<-""
tab_cap="Vehicle category descriptions (U.S. EPA, 2016)"
tab_num=tab_num+1
knitr::kable(size_description,
             row.names = FALSE,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```

In total, there are twenty-four vehicle types in this model (i.e., twelve vehicle technology categories with BEV and PHEV divided into short- and long-range. Each vehicle technology category is dissociated into two size categories). In this report, vehicle technology refers to the powertrain technology, the vehicle type refers to the combination of vehicle technology and size category

##SI.2.2 Historical vehicle attributes

###SI.2.2.1 Historical average curb weights

The curb weight is defined as the total weight of the operational vehicle without passenger or cargo loads. The average curb weights by vehicle type are derived from the U.S. EPA [@UnitedStatesEnvironmentalProtectionAgency2016], the Oak Ridge National Laboratory [@Davis2016] and the Argonne National Laboratory through the GREET model [@ArgonneNationalLaboratory2017].

The historical sales-weighted average curb weights of HEV, ICEV-D and ICEV-G cars and light-trucks from 1975 to 2015 are taken from the appendix E of the fuel economy trends report of the U.S. EPA [@UnitedStatesEnvironmentalProtectionAgency2016] (Figure SI.`r fig_num+1`).  

```{r conv_curb_weight_hist, fig.width=6,fig.height=3, fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap), }
#Input files
Fleet_wgt_75to15 <- read.csv("inputs/fleet_wgt_75to15.csv", stringsAsFactors = FALSE, check.names = FALSE)
lbs_to_kg<-0.45359237
#Format data
Fleet_wgt<-melt(Fleet_wgt_75to15, id=colnames(Fleet_wgt_75to15)[1:4], variable.name = "Year")
Fleet_wgt$Year<-as.numeric(as.character(Fleet_wgt$Year))

plot_dt<-na.omit(subset(Fleet_wgt,Source=="EPA"&value!=0&Technology!="Glo"&Size!="LDV"))
plot_dt$value<-plot_dt$value*lbs_to_kg

#Plot
ggplot(plot_dt)+
  geom_line(aes(x=Year,y=value, colour=Technology, linetype=Size),
            size=1.2)+
  labs(y="Curb weight (kg)")+
  scale_colour_milovanoff()+
  scale_linetype(guide=guide_legend(title=NULL))+
  scale_x_continuous(expand=c(0,0))+
  theme_milovanoff(legend_position="right")+
  theme(axis.title.x = element_blank())

fig_cap="Historical sales weighted average curb weights from EPA"
fig_num<-fig_num+1
```

The historical sales-weighted average curb weights of the other technologies (e.g., CNG, FFV, FCV, PHEV, and BEV) are not available in the report and are taken with the following assumptions:

*   Historical FFV and CNG curb weights are assumed to be equal to the historical average global curb weights of the vehicle categories, i.e. car or light truck.
*   The average curb weights of PHEV, BEV and FCV for the two categories are derived from the GREET model [@ArgonneNationalLaboratory2017] and are assumed to be constant before 2015. The underlying assumptions are described in the following sections.  

###SI.2.2.2 Component weight distributions

For modeling purposes, the vehicles are divided into 10 components. The sum of those components corresponds to the vehicle curb weight. In this study, the average component weight distributions by vehicle type are elicited for two purposes. The first one is to estimate the average curb weights of PHEV, BEV and FCV for cars and light trucks. And the second one is to allow the lightweighting submodule to perform component-specific lightweighting. The following sections describe the assumptions to obtain the component weight distributions by vehicle type in 2015. Table SI.`r tab_num+1` contains the technical descriptions of the components and subcomponents.  

```{r component_description}
comp_description <-read_excel("reports/tables_SI_paper1.xlsx",sheet = "veh_component_description", skip = 1)
comp_description[is.na(comp_description)]<-""

tab_cap="Component and subcomponent descriptions"
tab_num=tab_num+1
knitr::kable(comp_description,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```


The components weights are estimated based on assumptions taken from the GREET model 2017 version [@ArgonneNationalLaboratory2017] and the "Cradle-to-Grave Lifecycle Analysis of U.S. Light-duty Vehicle-fuel Pathways" developed by the Argonne National Laboratory [@Elgowainy2016]. The following data and assumptions are regarded:

*  The GREET model provides component weight distributions by vehicle type. For ICEV-G, ICEV-D, CNG, FFV and HEV, the component weight distributions are estimated from the GREET weight distributions proportionally adjusted to the 2015-model-year sales weighted average curb weight described in Figure SI.`r fig_num`.
*  For PHEV20, PHEV40, BEV100, BEV300 and FCV, the curb weights are taken from the GREET model. The GREET model offers three values according to three vehicle sizes: Car, Sport Utility Vehicle (SUV) and Pick-Up Truck (PUT). By default in the model, the curb weights of the "Car" and "Light truck" categories equal that of SUV and PUT in the GREET model, respectively. Otherwise, curb weights of cars taken from the GREET model would be lower than the 2015-model-year sales weighted average curb weight of cars from the U.S. EPA. This would create a discrepancy between conventional and alternative vehicles (i.e., PHEV, BEV and FCV) as current alternative vehicles are on average heavier than conventional vehicles [@Elgowainy2016]. The sensitivity of this assumption is assessed in the sensitivity analysis.
*  The weight for fluids, Battery Lead-Acid and Wheels are taken directly from the GREET model for the different technologies.
*  If the vehicle includes an EV battery (i.e., for HEV, BEV, PHEV and FCV), the weight of the EV battery is calculated from the power or capacity of the battery and the energy density of the battery type and the cathode material considered. Energy densities are derived from GREET. Figure SI.`r fig_num+1` presents the EV Battery energy densities in kWh of electricity per kg of battery for BEV or kW of electric power per kg of battery for FCV and PHEV. As default setting, the Lithium-ion battery using $LiMn_2O_4$ as cathode material (named LI_ion LMO in the Figureand surrounded in black) is considered in FCV, HEV, PHEV and BEV. Moreover, split-PHEV is the considered technology for PHEV. Power split hybrid architectures consist of at least on power split device that creates a mechanical and electrical connections with the wheels.    

```{r assum_bat,fig.width=8,fig.height = 4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#input files
vehicle_technology <- read.csv("inputs/vehicle_technology.csv", stringsAsFactors = FALSE, check.names = FALSE)
bat_fc_dt<-read.csv("inputs/GREET_bat&FC_2017.csv", stringsAsFactors = FALSE, check.names = FALSE)
plot_dt<-bat_fc_dt[bat_fc_dt$Subcomponent=="EV Battery"
                   &bat_fc_dt$Data=="Energy density",]
plot_dt[plot_dt$`Battery type`=="Li_ion LMO","default"]<-"yes"
ggplot(plot_dt)+
  geom_col(aes(x=`Battery type`,y=`2015`,fill=Technology),
           position="dodge")+
  geom_col(data=subset(plot_dt,default=="yes"),
           aes(x=`Battery type`,y=`2015`,colour="Default"),
           fill="transparent",
           colour="black",
           size=1.5,
           position="dodge")+
  facet_wrap(~paste(Technology,Unit), scales="free")+
  labs(y="kWh/kg or kW/kg",x=NULL)+
  theme_milovanoff()+
  scale_fill_milovanoff()+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        axis.title.x = element_blank(),
        legend.box.margin = margin(t=-1,unit="cm"))

fig_num<-fig_num+1
fig_cap<-"Specific power and energy for different battery types and vehicle technologies. Source: GREET 2017"
```


*  For vehicle types that are not range-specific (i.e., for HEV and FCV), the power capacity of the battery is taken directly from GREET. Otherwise, the range-specific BEVs and PHEVs use the battery capacities derived from the fueleconomy.org dataset of 2016 model year vehicles [@fueleconomy]. By default, we consider the sales weighted battery capacity by vehicle type by defining BEV100 vehicles up to 150 miles, and PHEV20 up to 25 miles. We build a sensitivity analysis by considering the maximum and minimum battery capacities of the available 2016 model year vehicles. We present in Figure SI.`r fig_num+1` the default battery capacity and low and high ranges.  


```{r eb_bat_cap,fig.width=6,fig.height = 3,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
fleet_i_ev_bat <- do.call(read_simulation_f,list(function_tbc="fleet_i_ev_bat_f",sim_tbc="sim1",dts_names="fleet_i_ev_bat"))
plot_col <- subset(fleet_i_ev_bat,Case=="Default",select=-c(ev_bat_size_mdl,Case))
plot_col[,"y_min"] <- subset(fleet_i_ev_bat,Case=="Low")[,"Capacity"]
plot_col[,"y_max"] <- subset(fleet_i_ev_bat,Case=="High")[,"Capacity"]
#Format
plot_col$Technology[plot_col$Technology=="HEV"] <- "HEV (kW)"


ggplot(plot_col)+
  geom_col(aes(x=Technology,y=Capacity,fill=Technology),
           position="dodge")+
  geom_errorbar(aes(x=Technology,ymin=y_min,ymax=y_max),
              position = "dodge",
              width = 0.5, #Control width of the limit bar
              size=1.2)+
  coord_flip()+
  facet_wrap(~Size, scales="free_x")+
  labs(y="kWh or kW",x=NULL)+
  theme_milovanoff(legend_position = "bottom")+
  scale_fill_milovanoff(guide=guide_legend(nrow=1,title=NULL))

fig_num<-fig_num+1
fig_cap<-"Power and energy battery capacities by vehicle type with bounding values. Sources: GREET 2017 and fueleconomy.org"
```

*  Then, we calculate the EV battery weights from the power capacity and the energy densities previously presented. Figure SI.`r fig_num+1` contains the EV battery weights for the default settings of the model along with the other components weights by vehicle type in 2016.  

```{r compo_wgt,fig.width=7,fig.height=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
fleet_i_comp_wgt_f_res <- do.call(fun_res_f,list(fun_name="fleet_i_comp_wgt_f",fast_mode="y"))
plot_col <- fleet_i_comp_wgt_f_res[["fleet_compo_wgt"]]

#Plot
ggplot(subset(plot_col,Component!="Total"))+
  geom_col(aes(x=Technology,y=Weight,fill=Component))+
  facet_wrap(~Size)+
  labs(y="Weight (kg)")+
  theme_milovanoff()+
  scale_y_continuous(expand=c(0.01,0))+
  scale_fill_milovanoff(name=NULL)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=40,vjust=1,hjust=1))
#ggsave(paste0("Rplots/comp_subc_wgt.png"))

fig_cap="Component weight distribution by vehicle type"
fig_num<-fig_num+1
```


###SI.2.2.3 Historical average material composition


Obtaining the historical average material composition by vehicle type is necessary for two purposes. The first one is to build the 2015 average material composition values that are used in the lightweighting submodule. The second one is the build the 1980-2014 average material composition values for the Automotive Material Flow module. As vehicles are taken off the road after few years (see section SI.3.1.1), the annual quantity of scrapped and recovered materials is based on the quantity of scrapped vehicles and their associated average material compositions. The maximum vehicle age considered is 30 years, therefore the material composition values are built from 1980.  
In this study, six materials or material categories are considered: High strength steel and advanced high strength steel (HSS/AHSS), cast iron, mild steel and other steels, wrought aluminum, cast aluminum and others. For years before 2015, the historical material compositions of light-duty vehicles are taken from the Transportation Energy Data book (TEDB) produced by the Oak Ridge National Laboratory [@Davis2016]. Then, starting in 2015, we build the material compositions explicitly by subcomponent in the lightweighting submodule.  

From the Transportation Energy Data book (TEDB)[@Davis2016], we take the following assumptions:

*  The share of wrought and cast aluminum components in the conventional light-duty vehicles from 1980 to 2014 are taken from Ducker Worldwide [@DuckerWorldwide2017] (i.e., 28.7% of aluminum is wrought and 71.3% is cast).
*  Due to lack of data before 1995, we adapt the average material composition by vehicle with the relative content of aluminum by vehicle from 1980 to 1994 provided by Ducker Worldwide [@DuckerWorldwide2017] and by scaling proportionally the other material categories.  

Then, the average material composition of the light-duty vehicles in 2015 is updated from the latest Ducker Worldwide's study [@DuckerWorldwide2017] with the following steps:

*  Another Ducker Worldwide's study [@DuckerWorldwide2015] indicates that between 2010 and 2013, the HSS/AHSS content increased by 10% per year. To obtain the HSS/AHSS content, it is assumed that the same increase occurred between 2014 and 2015. The rest of steel is considered as "Mild steel and other steels".  

Figure SI.`r fig_num+1` shows the relative material composition of conventional vehicles from 1980 to 2015.
 
```{r vehicle_mat_comp_80to15, fig.width=6,fig.height=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Input files
mat_comp_80to15<-read.csv("inputs/fleet_mat_comp_80to15.csv",stringsAsFactors = FALSE,check.names = FALSE)
#Format data
ids_names<-colnames(mat_comp_80to15)[!grepl(pattern="[[:digit:]]{1}",colnames(mat_comp_80to15))]
plot_col<-melt(mat_comp_80to15, id=ids_names, variable.name = "Year")
plot_col$Year<-as.numeric(as.character(plot_col$Year))
plot_col<-subset(plot_col,Technology=="ICEV-G"&Size=="Car"&Material!="Total")

ggplot(plot_col)+ 
  geom_col(aes(x=Year,y=value,fill=Material),
           position="fill")+ 
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     breaks=seq(0,1,0.25),
                     labels=seq(0,100,25)) +
  labs(y="Material Composition (%)",x=NULL)+
  theme_milovanoff()+
  scale_fill_milovanoff(name=NULL)

fig_num<-fig_num+1
fig_cap="Relative average material composition of U.S. light-duty conventional vehicles from 1980 to 2015"
```


The previous data concern the global light-duty fleet and therefore apply mostly to conventional vehicles (i.e., ICEV-G). They are not representative of all vehicle types. In addition, the material compositions by vehicle components is necessary in the lightweighting submodule. To build the technology-specific material compositions by component, we do the following steps:

*  Each vehicle type is divided into components and subcomponents based on the component weight distributions previously described and the subcomponent weight distributions provided by the Argonne National Laboratory [@Elgowainy2016].
*  In a first iteration, the subcomponent material compositions from the Argonne National Laboratory [@Elgowainy2016] are used to build the material compositions by vehicle type.
*  However, the results from the first iteration are not coherent with the 2015 average material composition of the conventional vehicles acquired from TEDB and Ducker Worldwide. Therefore, some of the subcomponent material compositions are updated in order to match the two material compositions in 2015. The adjustments apply the following assumptions:
    +  The subcomponent and component weights by vehicle type are kept constant.
    +  The aluminum content in the body subcomponent is updated based on Ducker Worlwide [@DuckerWorldwide2017]. It is assumed that 12% of the net aluminum content of ICEV-G Car is in the body subcomponent mainly made out of wrought components. This adjustment proportionally reduces the "Mild steel and other steels" content of the body subcomponent to achieve the same subcomponent weight.
    +  The aluminum content in the transmission subcomponent is updated based on Ducker Worlwide [@DuckerWorldwide2017]. It is assumed that 19% of the net aluminum content of ICEV-G Car is in the transmission subcomponent mainly made out of cast components. This adjustment proportionally reduces the "Mild steel and other steels" content of the transmission subcomponent to achieve the same subcomponent weight.
    +  The aluminum content in the interior subcomponent is updated based on Ducker Worlwide [@DuckerWorldwide2017]. It is assumed that 10% of the net aluminum content of ICEV-G Car is in the interior subcomponent mainly made out of cast components. This adjustment proportionally reduces the "Mild steel and other steels" content of the interior subcomponent to achieve the same subcomponent weight.
    +  The aluminum content in the chassis subcomponent is updated based on Ducker Worlwide [@DuckerWorldwide2017]. It is assumed that 8% of the net aluminum content of ICEV-G Car is in the chassis subcomponent mainly made out of cast components. This adjustment proportionally reduces the "Cast Iron" content of the chassis subcomponent to achieve the same subcomponent weight.
    +  The aluminum content in the wheel subcomponent is updated by assuming that all the net "Mild steel and other steels" content is substituted by Cast aluminum [@DuckerWorldwide2017].
    +  The aluminum contents in all the other subcomponents are adjusted to match the net cast aluminum content of 2015 average material composition of the conventional vehicles by multiplying the subcomponents' cast aluminum content with an adjustment factor. This adjustment proportionally reduces the "Mild steel and other steels" content of all the adjusted subcomponents to achieve the same subcomponent weights.
    +  The Cast Iron contents by subcomponent are adjusted to match the net cast iron content of 2015 average material composition of the conventional vehicles by multiplying the subcomponents' cast iron content with an adjustment factor. This adjustment proportionally reduces the "Mild steel and other steels" content of all the adjusted subcomponents to achieve the same subcomponent weights.
    +  50% of "Mild steel and other steels" content in body and exterior subcomponents is assumed to be "HSS/AHSS" [@DuckerWorldwide2015].
    +  The rest of "HSS/AHSS" content is estimated to be in the chassis subcomponent. This adjustment proportionally decreases the "Mild steel and other steels" content in the chassis subcomponent to achieve the same subcomponent weight.
    +  The "Mild steel and other steels" content is adjusted to match the net "Mild steel and other steels" content of 2015 average material composition of the conventional vehicles by multiplying the subcomponents' "Mild steel and other steels" content with an adjustment factor. This adjustment changes the "other" content of all the adjusted components.
*  Finally, a second iteration of the material compositions is conducted from the updated subcomponent material compositions.  

The outputs of the previous steps are the material composition by subcomponents for all vehicle types. Figure SI.`r fig_num+1` presents the aggregated material composition by vehicle type in 2015.

```{r mat_comp_2015,fig.width=6,fig.height=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
fleet_mc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_mc_proj_f",fast_mode="y"))
fleet_mt_comp<-fleet_mc_proj_f_res[["fleet_mt_comp_proj"]]

plot_col<-subset(fleet_mt_comp,Scenario=="BAU"&Material!="Total")


ggplot(plot_col)+
  geom_col(aes(x=Technology,y=`2015`,fill=Material))+
  facet_wrap(~Size)+
  labs(y="Weight (kg)")+
  theme_milovanoff(legend_position = "bottom")+
  scale_y_continuous(expand=c(0.01,0))+
  scale_fill_milovanoff(name=NULL)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=40,vjust=1,hjust=1))

fig_num<-fig_num+1
fig_cap="Average material composition by vehicle type in 2015"
```

 
###SI.2.2.4 Historical fuel consumption values

Vehicles are propelled by a fuel. However, vehicle technologies use different powertrain technologies and fuels. This section describes the fuels associated with the different technologies and the assumptions to obtain the historical fuel consumption values by vehicle type (i.e., from 1980 to 2015).  

Table SI.`r tab_num+1` shows the type of fuel used by vehicle technology. We assume that fuel blends such as E10 (10% ethanol and 90% gasoline) and E85 (85% ethanol and 15% gasoline). This assumption leads to overestimating ethanol volumes as flex-fuel vehicles do not always use E85.     

```{r fuel_description}
fuel_description <-read_excel("reports/tables_SI_paper1.xlsx",sheet = "fuel", skip = 0)
fuel_description[is.na(fuel_description)]<-""
tab_cap="Fuel type description"
tab_num=tab_num+1
knitr::kable(fuel_description,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```


A fuel consumption value corresponds to the quantity of fuel used to propel a vehicle on a defined distance. The reference unit is L/100km for fuels quantified in L and kWh/100km for electricity. The following assumptions and sources are used to obtain the historical fuel consumption values by vehicle type:

*  For ICEV-G and ICEV-D Car and Light-truck, the U.S. EPA provides the annual sales-weighted average fuel consumption values by vehicle type in the appendix E ("Fuel Economy Data Stratified by Vehicle Type and Weight Class") of the Fuel Economy trends report [-@UnitedStatesEnvironmentalProtectionAgency2016]. The adjusted combined values based on the 5-cycle driving tests are used.
*  For BEV and PHEV Car and Light-truck, the model-specific fuel consumption values provided by the U.S. EPA and the U.S. Department of Energy in the fueleconomy.gov website [@fueleconomy] are combined with estimated annual sales of BEV and PHEV vehicles by model found on the Green Car Reports website [@Klippenstein] to create the annual sales weighted average fuel consumption by vehicle type. Only the values of 2015 are considered to adjust some discrepancies in some previous year data. Similarly, the adjusted combined data based on the 5-cycle driving tests are considered.
*  PHEV operates in two different modes: CD which means Charge depleting and CS which means charge sustained. In the CD mode, the battery provides most of the time the electricity to the traction motor to provide mechanical torque and propel the vehicle. However, depending on the type of transmission and engine (i.e., series VS split PHEV), this mode can operate on a blend of E10 and electricity or only on electricity. In the CS mode, only E10 is used. In this model, the two modes are considered and the underlying assumption is that the CD mode consumes only electricity and the CS mode consumes only E10. Therefore, two fuel consumption values are developed for PHEV Cars and Light trucks.
*  For the other vehicle types (i.e., CNG, FCV, FFV, HEV Car and Light-truck), the historical fuel consumption values provided by the VISION model [@Zhou2014] are used.  

Figure SI.`r fig_num+1` presents the historical fuel consumption values by vehicle type from 1980 to 2015. The missing data represent the absence of the vehicle types in the fleet. 

```{r hist_fc, fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=7,fig.height=4}
source("outputs/functions/read_f.R")
fleet_fc_hist_f_res <- do.call(fun_res_f,list(fun_name="fleet_fc_hist_f",fast_mode="y"))
fleet_fc_hist<-fleet_fc_hist_f_res[["fleet_fc_hist"]]

#Format PHEV modes
fleet_fc_hist$Technology[fleet_fc_hist$Technology=="PHEV20" & fleet_fc_hist$`Fuel type`=="Gasoline"]<- "PHEV20 (CS)"
fleet_fc_hist$Technology[fleet_fc_hist$Technology=="PHEV20" & fleet_fc_hist$`Fuel type`=="Electricity"]<- "PHEV20 (CD)"
fleet_fc_hist$Technology[fleet_fc_hist$Technology=="PHEV40" & fleet_fc_hist$`Fuel type`=="Gasoline"]<- "PHEV40 (CS)"
fleet_fc_hist$Technology[fleet_fc_hist$Technology=="PHEV40" & fleet_fc_hist$`Fuel type`=="Electricity"]<- "PHEV40 (CD)"
#Format fuel 
fleet_fc_hist[fleet_fc_hist=="Gasoline"]<-"E10"
fleet_fc_hist[fleet_fc_hist=="Ethanol"]<-"E85"
#Plot
plot_dt<-subset(fleet_fc_hist,Technology!="FCV")
ggplot(plot_dt)+
  geom_line(aes(x=Year,y=Value,linetype=Size,color=Technology),
            size=1.3)+
  facet_wrap(~paste(`Fuel type`,Unit),scales="free_y")+
  labs(y="Fuel Consumption (L or kWh/100km)",x=NULL)+
  theme_milovanoff()+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name=NULL)+
  scale_linetype(name=NULL)+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        legend.background = element_blank(),
        legend.box.background = element_blank(),
        legend.box="vertical",
        legend.box.just="left",
        legend.position = c(0.85,0.2),
        legend.key.width=unit(0.5,"cm"),
        legend.spacing=unit(0,"cm"))+
  guides(color= guide_legend(order=1,ncol=2),
         linetype = guide_legend(order=2,ncol=2,title.hjust=0.5))


fig_num<-fig_num+1
fig_cap<-"Historical fuel consumption values by vehicle type"
```

The following table shows the fuel consumption values in 2015 by vehicle type. Those values are used in the lightweighting submodule.

```{r table_fc_2015}
#RUN previous chunk
table_dt<-subset(fleet_fc_hist,Year==2015)
colnames(table_dt)[2]<-"Category"
tab_cap="Fuel consumption values by vehicle type in 2015"
tab_num=tab_num+1
knitr::kable(table_dt,
             digits = 1,
             row.names = FALSE,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```

####Utility factor for PHEV

The utility factor for PHEV provides the percentage of distance traveled on CD mode. Combined with fuel consumption values on CD and CS mode, the quantity of E10 and electricity used per 100 km can be estimated. In this model, we consider the interconnection between the utility factor and the all-electric range of the PHEV as outlined by Bradley et al. [@Bradley2010]. In that perspective, the relation provided by the GREET model [@ArgonneNationalLaboratory2017] is considered:

$$UF=-7.73E^{-09}*Range^4+2.63E^{-06}*Range^3-3.7E^{-04}*Range^2+2.66E^{-02}*Range$$
With $UF$ the utility factor on CD mode ($0<UF<1$) and $Range$ the all-electric range of PHEV in miles.

The aggregated fuel consumption values of PHEV become:

$${FC}_{fuel,PHEV,c,y}={FC}_{fuel,PHEV,c,y,CD mode}*{UF}_{PHEV,c,y}+{FC}_{fuel,PHEV,c,y,CS mode}*(1-{UF}_{PHEV,c,y})$$
With $FC_{fuel,PHEV,c,y}$ the fuel consumption on the fuel type "fuel" for vehicle category "c" at year "y", $CD mode$ indicates the fuel consumption on this fuel in CD model and $CS mode$ in CS mode; $UF_{PHEV,c,y}$ is the utility factor on CD mode. As a reminder, it is assumed that $FC_{Electricity,PHEV,c,y,CS mode}=0$ and $FC_{Gasoline,PHEV,c,y,CD mode}=0$.
 
##SI.2.3 Projected vehicle attributes: The lightweighting submodule

The purpose of the lightweighting submodule is to project from 2015 to 2050 the vehicle attributes previously acquired from 1980 to 2015. Those projections are based on different lightweighting scenarios and projections of fuel consumption improvements. 

Four lightweighting scenarios are built. The Steel Intensive and Aluminum Intensive scenarios derive from the eponymous scenarios of Modaresi et al. [-@Modaresi2014] and the "Aluminum Maximum" scenario derives from the "Aluminum Extreme" scenario of Modaresi et al. [-@Modaresi2014]. They essentially focused on two widely used lightweight materials on the short and medium term: HSS/AHSS and aluminum. They are applied to all vehicle types and consist of a set of subcomponent-specific material replacement rates and material substitution factors of replaced and replacing materials. The lightweighting scenarios are compared with a “No Lightweighting” scenario which considers a constant set of material composition and curb weight for all vehicle types based on the 2015 values. Finally, the Adapted Aluminum Maximum scenario combines the Aluminum Maximum scenario for conventional vehicles, the Aluminum Intensive scenario for hybrid vehicles and the “No Lightweighting” scenario for battery-electric vehicles. This scenario explores the potential lack of interests for manufacturers to lightweight alternative vehicles and is justified from the small fuel reduction values for lightweighting highly-efficient alternative vehicles [@Kim2016]. Once the lightweight material replacements are implemented, a set of secondary weight changes are iteratively applied to obtain the final annual average curb weight by vehicle type. Then, the annual overall weight savings directly influence the vehicle fuel consumption values through fuel reduction values (FRVs). Finally, annual fuel consumption improvements are applied to the projected fuel consumption values. The following sections describe the projected curb weight savings, and the associated fuel consumption values.  

###SI.2.3.1 Curb weight changes associated with vehicle lightweighting, battery technological improvements and feature content

The lightweighting scenarios are constructed from the subcomponent material composition and weight by vehicle type in 2015, a set of defined subcomponent-specific material replacement rates, material substitution factors of the replaced and replacing materials and secondary weight changes.
  
```{r fleet_mc_lw_f_def}
source("outputs/functions/read_f.R")
fleet_mc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_mc_proj_f",fast_mode="y"))
```
  
####Replacement rates

The Steel Intensive, Aluminum Intensive and Aluminum Maximum scenarios are built from three different sets of replacement rates. These scenarios are derived from Modaresi et al. [-@Modaresi2014]. For each scenario, the replacement rates correspond to the fraction of original materials, i.e. the replaced materials, replaced by lightweight materials, i.e. the replacing materials. The replacement rates are subcomponent-specific but not vehicle type specific in the three previous scenarios. The Adapted Aluminum Maximum scenario is derived from the three previous scenarios by combining the Aluminum Maximum scenario for conventional vehicles (i.e., ICEV-G, ICEV-D, FFV and CNG), the Aluminum Intensive scenario for hybrid vehicles (i.e., HEV and PHEV) and the “No Lightweighting” scenario for battery-electric vehicles (BEV and FCV). The Adapted Aluminum Maximum is therefore vehicle technology specific. The replacements are assumed to occur with a constant rate from 2016 to 2030 in the default case. Therefore, the full lightweighted designs are obtained in 2030. The following table provides the descriptions of the replacement rates, replaced and replacing materials by lightweighting scenario.
 
```{r lightweighting_scenario_description}
lw_description <-read_excel("reports/tables_SI_paper1.xlsx",sheet = "lightweighting_scenario", skip = 0)
lw_description[is.na(lw_description)]<-""
tab_cap="Lightweighting scenario description from Modaresi et al."
tab_num=tab_num+1
knitr::kable(lw_description,
             digits = 1,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
``` 
  
####Substitution factors
  
The previous replacement rates determine the final weight of the replaced material. However, they do not define the final weight of the replacing material and therefore of the subcomponent. The mass ratio of the lightweight material that substituted the replaced material is called substitution factor. A substitution factor for a pair of replaced material ($RedMat$) and replacing material ($RingMat$) in a specific subcomponent is defined as the mass ratio of the new material $M_{RingMat}$ to the substitued material $M_{RedMat}$ as shown in the following equation. 
    
$$SF_{RedMat,RingMat,Comp} = \frac{M_{RingMat}}{M_{RedMat}}$$
    
The substitution factors depend on the component in which the substitution occurs as well as the replacing and replaced materials. In this study, a literature review of substitution factors is done from the following sources: "DOE Report" [-@U.S.DepartmentofEnergy2013], "Malen"[-@Malen2011], "Sullivan" [-@Sullivan1995], "Geyer" [-@Geyer2008], "NHTSA and EPA" and "Expert" through the literature review conducted by Kelly et al. [-@Kelly2015] and "Modaresi" from Modaresi et al. [-@Modaresi2014]. It should be noted that the substitution ratios collected by Kelly et al. [-@Kelly2015] contain only one value for "Steel to AHSS" substitution factor in Chassis (i.e., 0.44). To expand the substitution factor literature review on this component (i.e., chassis), the reports reviewed by Kelly et al. [-@Kelly2015], a report from U.S. DOT and NHTSA [-@Singh2012] and a report from the U.S. EPA [-@UnitedStatesEnvironmentalProtectionAgency2012], are reviewed for the chassis component. Figure SI.`r fig_num+1` compiles the values of the acquired substitution factors.  
 
```{r subs_fac,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=7,fig.height=4}
#Input files
sub_fac_dt <- read.csv("inputs/substitution_factor.csv", stringsAsFactors = FALSE, check.names = FALSE)
lw_mat_tbc<-c("HSS/AHSS","Cast Aluminum","Wrought Aluminum")
plot_dt<-subset(sub_fac_dt,`Replaced material`!="HSS"&`Replacing material`%in%lw_mat_tbc)
#Format data
ggplot(plot_dt)+
  geom_point(aes(x=Component,y=`Substitution ratio`,colour = `Replacing material`,shape=`Replacing material`))+ 
  facet_wrap(~`Replaced material`,scales="free_x",nrow=1)+
  theme_milovanoff()+
  scale_colour_milovanoff(name="Replacing Material")+
  scale_shape(name="Replacing Material")+
  theme(axis.title.x=element_blank(),
        axis.text.x = element_text(angle=40,vjust=1,hjust=1))
  
#ggsave("Rplots/sub_fac.png", plot = q,width = 30, height = 20, units = "cm")

fig_cap="Substitution factors for different replaced materials"
fig_num=fig_num+1
```
 
As outlined in Figure SI.`r fig_num`, there are a variety of substitution factors even for a specific set of component, replaced and replacing materials. By default in this model, the substitution factors are aggregated by mean for a set of replaced, replacing materials and subcomponent. However, if no substitution factor is available for one set of parameters, the substitution factor used is derived from either the component that includes the subcomponent or from a general category. Figure SI.`r fig_num+1` contains the set of substitution factors used by default and the minimum and maximum values used in the sensitivity analysis.  
  
```{r sub_fac_used,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=8.5,fig.height=4}
#Extract and compile simulation
source("outputs/functions/read_f.R")
sub_fac_used<-do.call(read_simulation_f,list(function_tbc="fleet_mc_proj_f",sim_tbc="sim1",dts_names="sub_fac_used"))
#Format plot
sub_fac_used$`Substitution factor`<-as.numeric(sub_fac_used$`Substitution factor`)
sub_fac_used<-unique(subset(sub_fac_used,select=-Year))
sub_fac_used$`Replaced material`[grep("steel",sub_fac_used$`Replaced material`)]<-"Steel"
plot_dt<-sub_fac_used[sub_fac_used$sub_fac_fun=="mean",]
colnames(plot_dt)[colnames(plot_dt)=="Substitution factor"]<-"mean"
plot_dt[,"min"]<-sub_fac_used[sub_fac_used$sub_fac_fun=="min","Substitution factor"]
plot_dt[,"max"]<-sub_fac_used[sub_fac_used$sub_fac_fun=="max","Substitution factor"]
ggplot(plot_dt)+
  geom_col(aes(x=Component,y=mean,fill=Component),
           position="dodge")+
  geom_errorbar(aes(x=Component,ymin=min,ymax=max),
                width=0.5,
                size=1.2)+
  facet_grid(~paste(`Replaced material`,"\n to \n",`Replacing material`),scales="free_x",space="free_x")+
  theme_milovanoff()+
  scale_fill_milovanoff(name="Component",guide=guide_legend(nrow=3))+
  scale_y_continuous(expand=c(0.01,0))+
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        strip.text = element_text(size=8),
        panel.spacing.x = unit(0.1, "cm"))

fig_cap="Substitution factors by replaced material and component with bounding values."
fig_num=fig_num+1
```

####Primary savings  
From the replacement rates and the substitution factors, the final (i.e., in 2030 by default) weights of the replaced material ($M_{RedMat}$) and replacing material ($M_{RingMat}$) in component $c$ and lightweighting scenario $i$ can be obtained with the following equation: 
    
$$M_{RedMat,c, 2030, i} = M_{Red_Mat, c, 2015} \times (1-\sum_{RingMat} {RepRates}_{RedMat, RingMat, c, i})$$
    
$$M_{RingMat, c, 2030, i} = M_{RingMat, c, 2015} + \sum_{RedMat} {RepRates}_{RedMat, RingMat, c, i}  \times M_{Red_Mat, c, 2015} \times {SF}_{RedMat, RingMat, c}$$
    
with $M_{RedMat,c, 2030, i}$ the mass of the replaced material, $M_{RingMat, c, 2030, i}$ the mass of the replacing material, ${RepRates}_{RedMat, RingMat, c, i}$ the replacement rate of the replaced material $RedMat$ by the replacing material $RingMat$ and ${SF}_{RedMat, RingMat, c}$ the substitution factor of the replaced material $RedMat$ by the replacing material $RingMat$ in the component $c$ and the scenario $i$.

Once all primary material replacements have occurred, the material substitutions defined in the previous scenarios offer primary savings. Figure SI.`r fig_num+1` summarizes the achieved primary savings by vehicle type and lightweighting scenario in 2030 in the default case. As a reminder, from 2015 to 2030, the new model-year vehicles possess gradual primary savings by assuming linear lightweighting.
  
```{r prim_mass_sav,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=9, fig.height=5}
source("outputs/functions/read_f.R")
fleet_mc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_mc_proj_f",fast_mode="y"))
pr_svg <- fleet_mc_proj_f_res[["pr_svg"]]

cum_pr_svg<-pr_svg
for (r in 1:nrow(pr_svg)){
  cum_pr_svg[r,as.character(2016:2030)]<-cumsum(t(pr_svg[r,as.character(2016:2030)]))
}
plot_dt<-subset(cum_pr_svg,Subcomponent!="Total"&!Scenario%in%c("BAU","Adapted Aluminum Maximum")&`2030`!=0)
#Format
lwscen_order <- c("Aluminum Maximum","Aluminum Intensive","Steel Intensive")
plot_dt$Scenario <- factor(plot_dt$Scenario,levels=lwscen_order)
ggplot(plot_dt)+
      geom_col(aes(x=Technology,y=`2030`,fill=Subcomponent))+
      facet_grid(Size~`Scenario`)+
      labs(x=NULL,y="Primary mass savings (kg)")+
      theme_milovanoff(legend_position = "bottom")+
      scale_fill_milovanoff(name="Component")+
      theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1))

fig_cap="Primary mass savings by vehicle type and lightweighting scenario"
fig_num=fig_num+1
```
 
 
####Feature content
Many factors influence the curb weight of light-duty vehicles. For example, MacKenzie et al. [-@Mackenzie2014] determined that reductions in vehicle weight due to technological improvements were offset by increasing feature contents (i.e., optional, safety and emissions equipment) and functionalities in the past. In the future, it is expected that features and functionalities will keep on increasing due, for example, to the increasing automation of vehicles [@Wadud2016]. To account for this factor, we implement an annual vehicle weight increase due to feature contents based on MacKenzie et al. [-@Mackenzie2014] estimations with the following assumptions:

*  MacKenzie et al. [-@Mackenzie2014] estimated that features added a total of 109 kg to cars weight from 1975 to 2010, without secondary weight savings, or around 3 kg per year.
*  We assume that cars and light-trucks follow the same trends with the same estimates. In addition, we assume that all technologies are subject to the changes and in all lightweighting scenarios.
*  We assume the feature content weight increases to occur in the vehicle interior and in the "other" material category.
*  By default in the model, we assume an annual increase due to feature contents of 3 kg per year in all cars and light-trucks from 2016 onwards. We assess the sensitivity of this factor by creating a scenario without any feature content increases (i.e., o kg per year) and a scenario with double feature content increases (i.e., 6 kg per year).    


####Battery resizing 
  
For electric vehicles, the battery is a significant component which could be resized due to overall weight changes or technological advances. In this model, the batteries of electric vehicles are annually resized based on the previous-year range of the electric vehicles, the annual weight changes due to primary savings, increasing feature contents and some technological changes, such as improvements in fuel consumption values and battery technologies. In the following sections, we use the term "primary battery resizing"" to refer to resizing due to technological improvements and "secondary battery resizing"" to refer to resizing due to weight changes that influence the vehicle electric range. This section applies to BEV100, BEV300, PHEV20 and PHEV40. The steps are:  

*  The previous-year range of the electric vehicle is estimated from the weight of the EV battery and the previous-year energy density of the battery type.  
    
$$Range_{y-1} = \frac{{WT}_{Bat,y-1} \times {ED}_{Bat,y-1}}{{FC}_{y-1}/100} \times \eta_{Bat}$$
with $Range$ the range in km, $WT_{Bat}$ the weight of the battery in kg, $ED_{Bat,y-1}$ the previous-year specific energy of the battery in kWh/kg, $FC$ the fuel consumption in kWh/100km and $\eta_{Bat}$ is the usable energy from the battery. $\eta_{Bat}$ is 90% for BEV and PHEV.
    
*  The fuel consumption at year "y" ${FC}_{y}$ is estimated with the weight changes and the fuel consumption improvements as described later in the report.
*  The range at year "y" of the electric vehicle is estimated using the updated fuel consumption ${FC}_{y-1}$ and the updated specific energy density of the battery. It is assumed that the energy densities of the battery types presented previously are doubled by 2030 as stated by Elgowainy et al. [-@Elgowainy2016]. Those improvements are assumed to occur linearly from 2015 to 2030.  
    
$${Range}_{y} = \frac{{WT}_{Bat,y-1} \times {ED}_{Bat,y}}{{FC}_{y}/100} \times \eta_{Bat}$$
    
$$WT_{Bat,y} = \frac{({Range}_{y} + {RR}_{bat} \times ({Range}_{y-1}-{Range}_{y})) \times {FC}_{y}/100}{{ED}_{Bat,y} \times \eta_{Bat}}$$ 
with $RR_{bat}$ a resizing ratio for battery. The value is in between 0% and 100% and the default value is 100%. It means that 100% of the weight changes are assumed to change the battery size in order to keep the same electric range of the specific vehicle technology. We evaluate the sensitivity of this factor by assuming 50% of resizing ratio for battery in the sensitivity analysis, meaning that 50% of the weight savings are used to increase the electric range.   
The steps to account for primary and secondary battery resizing are iteratively applied as described below.  
    
####Secondary weight changes
  
The primary weight changes associated with the material substitution, the feature content increases, and the battery resizing due to technological improvements imply secondary weight changes in the different components and subcomponents. These secondary weight changes are component-specific as the weight and size of some components are determined by the need to bear other components.

A method developed by Alonso et al. [-@Alonso2012] is used in this study to partially determine the secondary weight changes. However, because of the limitations of the empirical analysis conducted and the lack of alternative vehicles in their method, the secondary weight changes of the components that have an influence on the performance of the vehicles, such as acceleration time and maximal speed, are not evaluated by the method of Alonso et al. Instead, a method developed by MacKenzie et al. [-@MacKenzie2012] is used to account for powertrain resizing. In addition, secondary battery resizing occurs to offset to changes in fuel consumptions leading to changes in vehicle attributes such as electric range.  
  
#####Secondary weight changes without powertrain resizing
  
Alonso et al. [-@Alonso2012] use subcomponent mass influence coefficients $\gamma_c$ which represents the rate of mass change in the subcomponent per primary mass change of the vehicle. The sum of the subcomponent mass influence coefficients $\gamma_t$ is a first estimate of the secondary weight changes associated with the primary mass change. However, this first estimate does not include the secondary weight changes of the other components. Hence, a mass subcomponent decompounding coefficient $\Gamma_c$ is defined as the final rate of mass change in the subcomponent per primary mass change of the vehicle. In the same manner, the sum of the subcomponent mass decompounding coefficients $\Gamma_t$ quantifies the total secondary weight changes without powertrain resizing.
    
$$M_{final,c}=M_{primary,c}-({PWC}_{tot} \times \Gamma_c)$$
with $M_{final,c}$ the final subcomponent mass with the secondary weight changes, $M_{primary,c}$ the subcomponent mass before secondary weight changes but with primary weight changes, ${PWC}_{tot}$ the total primary weight changes associated with the material substitution, feature weight content increases and battery resizing, $\Gamma_c$ the mass decompounding coefficient of the subcomponent $c$.
    
The secondary weight changes coefficients used in this method are derived from Alonso et al. [-@Alonso2012] with the following adaptations:

*  Alonso et al. [-@Alonso2012] provide a unique mass influence coefficient for the subcomponent "tires and wheels". Each coefficient is divided by two to create the mass influence coefficient of the subcomponents "Tires", and "Wheels".
*  The mass influence and decompounding coefficients of the components that are included in the powertrain are not considered. It therefore reduces the overall mass decompounding effect.

The following table describes the considered components and mass influence coefficients.  
 
```{r sms_coef}
#Input files
sms_coef <- read.csv("inputs/Alonso_sms_coef.csv", stringsAsFactors = FALSE, check.names = FALSE)
table_dt<-sms_coef[sms_coef$Component!="Powertrain",c(1,2,4)]

tab_cap="Mass influence coefficients by subcomponent"
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap),
             row.names = FALSE)
```
    
All the considered technologies include the previous subcomponents. Therefore, the sum of the subcomponent mass decompounding coefficients $\Gamma_t$ is `r format(sum(sms_coef[sms_coef$Component!="Powertrain","Mass influence coef - mean"])/(1-sum(sms_coef[sms_coef$Component!="Powertrain","Mass influence coef - mean"])),digits = 2)`. This means that for 1 kg of primary weight changes, `r format(sum(sms_coef[sms_coef$Component!="Powertrain","Mass influence coef - mean"])/(1-sum(sms_coef[sms_coef$Component!="Powertrain","Mass influence coef - mean"])),digits = 2)` kg of secondary weight changes is achieved without powertrain or secondary battery resizing. This also means that 1 kg of secondary weight changes due to battery or powertrain resizing leads to `r format(sum(sms_coef[sms_coef$Component!="Powertrain","Mass influence coef - mean"])/(1-sum(sms_coef[sms_coef$Component!="Powertrain","Mass influence coef - mean"])),digits = 2)` kg of secondary weight changes in some components.  

Figure SI.`r fig_num+1` presents the secondary weight changes without powertrain and secondary battery resizing due to primary material substitution in the different lightweighting scenarios. As explained later, the results are obtained when the method is iteratively applied and account for the effects of powertrain and secondary battery resizing on secondary weight changes but not the direct powertrain and secondary battery resizing weight changes.    

```{r sec_mass_sav_lw,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap), fig.width=9, fig.height=5}
source("outputs/functions/read_f.R")
fleet_mc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_mc_proj_f",fast_mode="y"))
sec_svg <- subset(fleet_mc_proj_f_res[["sec_svg"]])
#cum_sec_svg is the cumulative mass savings from 2015 to 2030
cum_sec_svg <- sec_svg
for (r in 1:nrow(sec_svg)){
  cum_sec_svg[r,as.character(2016:2030)]<-cumsum(t(sec_svg[r,as.character(2016:2030)]))
}
plot_dt <- subset(cum_sec_svg,Subcomponent!="Total"&!Scenario%in%c("Adapted Aluminum Maximum")&`2030`!=0)[,c("Scenario","Size","Technology","Subcomponent","2030")]
#Recalculate the changes to compare with BAU
for (r in 1:nrow(plot_dt)){
  plot_dt[r,"2030"] <- plot_dt[r,"2030"]-subset(plot_dt,Scenario=="BAU" & Size==plot_dt[r,"Size"] & Technology==plot_dt[r,"Technology"] & Subcomponent==plot_dt[r,"Subcomponent"])[,"2030"]
}
#Format
lwscen_order <- c("Aluminum Maximum","Aluminum Intensive","Steel Intensive")
plot_dt$Scenario <- factor(plot_dt$Scenario,levels=lwscen_order)
plot_dt$Subcomponent<-factor(plot_dt$Subcomponent,levels=unique(plot_dt$Subcomponent))
ggplot(subset(plot_dt,Scenario%in%lwscen_order))+
        geom_col(aes(x=Technology,y=`2030`,fill=Subcomponent)) +
        facet_grid(Size~`Scenario`,scales="free") +
        labs(x=NULL,y="Cumulative secondary weight changes (kg)")+
        theme_milovanoff(legend_position="right")+
        scale_fill_milovanoff(breaks=unique(plot_dt$Subcomponent),
                              guide=guide_legend(title=NULL,reverse=TRUE))+
        theme(axis.text.x = element_text(size=10,angle=40,vjust=1,hjust=1))

fig_cap="2016-2030 Cumulative secondary weight changes without powertrain and battery resizing due to primary material substitution by lightweighting scenario and subcomponent"
fig_num=fig_num+1
```
  
    
#####Secondary weight changes associated with powertrain resizing
  
Vehicle performances, such as acceleration performance, are determined by the engine power, the vehicle weight, the body type and other powertrain characteristics. Thus, changes in the vehicle curb weight imply changes in the vehicle performances. Therefore, at similar performances, a lightweighted vehicle has a downsized engine compared to the conventional version [@Ward2017]. This engine downsizing increases the weight savings.  
To account for powertrain resizing, a study developed by MacKenzie et al. [-@MacKenzie2012] is used. It analyses a set of linear regression models for acceleration times, on the basis of engine power, vehicle weight and other powertrain characteristics. The regression results are used and adapted to account for changes in engine peak power from changes in vehicle mass. This method is used by Luk et al. [-@Luk2017]. The equation derived from MacKenzie et al. [-@MacKenzie2012] is:  
    
$$ln(ACC)=\beta_0+ \beta_1 \times ln(P) + \beta_2 \times ln(WT) + \beta_3 \times ln(D) + \beta_4 \times [ln(P)]^2 + \epsilon$$
  
with $ACC$ the acceleration time (i.e., times from 0 to 48 or 97 km/h or times from 72 to 105 km/h), $P$ the engine peak power, $WT$ the vehicle curb weight, $D$ the engine displacement,-$\epsilon$ a set of variables and parameter estimates that are kept unchanged for a specific technology. The attributes include number of transmission speeds, transmission type, drive type, body style, or engine type.

MacKenzie et al. [-@MacKenzie2012] developed the previous model from an empirical analysis of more than 1000 vehicles. If one wants to obtain the engine peak power change for a specific weight change with an equivalent acceleration time, the equation becomes:
  
$ln({ACC}_{lw}) = ln({ACC}_i)$
  
$\beta_0+ \beta_1 \times ln(P_{lw}) + \beta_2 \times ln(WT_{lw}) + \beta_3 \times ln(D_{lw}) + \beta_4 \times [ln(P_{lw})]^2 + \epsilon_{lw} = \beta_0+ \beta_1 \times ln(P_i) + \beta_2 \times ln(WT_i) + \beta_3 \times ln(D_i) + \beta_4 \times [ln(P_i)]^2 + \epsilon_i$
  
$\beta_1 \times ln(P_{lw} / P_i) + \beta_2 \times ln(WT_{lw} / WT_i) + \beta_3 \times ln(D_{lw} / D_i) + \beta_4 \times ([ln(P_{lw})]^2 -[ln(P_i)]^2)+ \epsilon_{lw} - \epsilon_i = 0$
 
with $X_i$ and $X_{lw}$ representing the values of the attribute $X$ before $i$ and after $lw$ the mass savings.
  
If the vehicle performance and the powertrain characteristics are kept unchanged, then $D_{lw}=D_{i}$ and $\epsilon_{lw}=\epsilon_{i}$.

The equation can be simplified as follows:
  
$\beta_4 \times [ln(P_{lw})]^2 + \beta_1 \times ln(P_{lw}) + \beta_2 \times ln(WT_{lw} / WT_i) - \beta_1 \times ln(P_i)-\beta_4 \times [ln(P_i)]^2 = 0$

If the only unknown is $P_{lw}$, the expression is a polynomial equation in $ln(P_{lw})$ which gives two real solutions if 
  
$\beta_1^2 - 4 \times \beta_4 \times (\beta_2 \times ln(WT_{lw} / WT_i) - \beta_1 \times ln(P_i)-\beta_4 \times [ln(P_i)]^2) > 0$
    
The regression estimates calculated by MacKenzie et al. [-@MacKenzie2012] are depicted in the following table. The acceleration time from 0 to 97 km/h is considered.

```{r MacKenzie_coef}
#Input files
MK_coef_techno <- read.csv("inputs/MacKenzie_coef_techno.csv",stringsAsFactors = FALSE,  check.names = FALSE)
table_dt<-t(MK_coef_techno[1,c(6:8)])

tab_cap="Regression estimates for equations from MacKenzie et al."
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap),
             col.names = "Estimate")
```
  
The regression model differentiates the different technologies by adding dummy variables, although only gasoline, diesel and hybrid electric engine types are considered. Hence, it is assumed that the previous equations hold for all the technologies. The model is used with the following steps:

*  The peak power is the sum of the peak power of the engine in ICEV-G, ICEV-D, FFV and CNG, of the engine and the traction motor in PHEV, of the engine and the traction Battery in HEV and of the traction motor in BEV and FCV. No distinction is made for peak power of engine or traction motor even though they possess different characteristics such as different torque distribution.  
  
$$P=P_{Engine}+P_{Traction Motor}$$
  
*  The initial engine, traction motor or traction battery peak power is assumed from the component's weight, a fixed mass value if applicable, and the energy density of the component (in kW per kg): 
  
$$P_{c,i}=(WT_{c,i} - FM_{c}) \times ED_{c}$$
  
Where $c$ is the component (i.e., engine, traction Battery or traction motor), $P_{i}$ the initial peak power (kW),$WT_{i}$ the initial weight (kg),$FM$ the fixed mass (kg) and $ED$ the energy density (kW/kg). Energy density values are derived from the FastSim model [@Brooker2015] and are depicted in the following table. The energy densities are not technology specific. The following table also contains the fixed-mass values.  
```{r energy_density, echo=FALSE, message=FALSE, warning=FALSE}
#Input files
bat_fc_dt<-read.csv("inputs/GREET_bat&FC_2017.csv", stringsAsFactors = FALSE, check.names = FALSE)
table_dt<-subset(bat_fc_dt,!Data%in%c("Usable Energy","Series-PHEV")&Subcomponent!="EV Battery",select=c(Unit,Subcomponent,Technology,Data,`2015`))
table_dt$`2015`<-format(table_dt$`2015`,digits=2)

tab_cap="Energy density and Fixed-mass values"
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap),
             row.names = FALSE)
```
    
*  Once the resized overall peak power is calculated using MacKenzie et al. [-@MacKenzie2012] equations, the engine, traction battery and traction motor peak powers are proportionally resized.  
    
$$P_{c,lw}=P_{c,i} \times \frac{P_{lw}}{P_i}$$
    
*  The resized component's weight (engine, traction battery and/or traction motor) is obtained using the same energy density as previously described.  
    
$$WT_{c,lw}=FM_{c} + \frac{P_{c,lw}}{ED_{c}}$$
    
*  Then, some components are considered as power-dependent by vehicle technology and are resized accordingly. The following table shows the list of power-dependent component.    
```{r pw_dep_compo, echo=FALSE, message=FALSE, warning=FALSE}
#Input files
table_dt <-read_excel("reports/tables_SI_paper1.xlsx",sheet = "Mackenzie_components", skip = 0)
tab_cap="Power-dependent components by technology"
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```
    
The power-dependent components are proportionally resized using the same ratio $\frac{P_{lw}}{P_i}$ and considering the fixed-mass value.
  
$$WT_{c,lw}=FM_{c} + (WT_{c,i} - FM_{c}) \times \frac{P_{lw}}{P_i}$$
    
Figure SI.`r fig_num+1` shows the results of the powertrain resizing weight changes due to lightweighting once all primary and secondary weight changes are applied iteratively as described below. Results Figure SI.`r fig_num+1` do not account for feature content weight increases and primary battery resizing due to technological improvements.     

```{r pwt_mass_sav_lw,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap), fig.width=9, fig.height=5}
source("outputs/functions/read_f.R")
fleet_mc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_mc_proj_f",fast_mode="y"))
pwt_svg <- subset(fleet_mc_proj_f_res[["pwt_svg"]])
#cum_pwt_svg is the cumulative mass savings from 2015 to 2030
cum_pwt_svg <- pwt_svg
for (r in 1:nrow(pwt_svg)){
  cum_pwt_svg[r,as.character(2016:2030)]<-cumsum(t(pwt_svg[r,as.character(2016:2030)]))
}
plot_dt <- subset(cum_pwt_svg,Subcomponent!="Total"&!Scenario%in%c("Adapted Aluminum Maximum")&`2030`!=0)[,c("Scenario","Size","Technology","Subcomponent","2030")]
#Recalculate the changes to compare with BAU
for (r in 1:nrow(plot_dt)){
  plot_dt[r,"2030"] <- plot_dt[r,"2030"]-subset(plot_dt,Scenario=="BAU" & Size==plot_dt[r,"Size"] & Technology==plot_dt[r,"Technology"] & Subcomponent==plot_dt[r,"Subcomponent"])[,"2030"]
}
#Format
lwscen_order <- c("Aluminum Maximum","Aluminum Intensive","Steel Intensive")
plot_dt$Scenario <- factor(plot_dt$Scenario,levels=lwscen_order)
plot_dt$Subcomponent<-factor(plot_dt$Subcomponent,levels=unique(plot_dt$Subcomponent))
ggplot(subset(plot_dt,Scenario%in%lwscen_order))+
        geom_col(aes(x=Technology,y=`2030`,fill=Subcomponent)) +
        facet_grid(Size~`Scenario`,scales="free") +
        labs(x=NULL,y="Cumulative secondary weight changes (kg)")+
        theme_milovanoff(legend_position="right")+
        scale_fill_milovanoff(breaks=unique(plot_dt$Subcomponent),
                              guide=guide_legend(title=NULL,reverse=TRUE))+
        theme(axis.text.x = element_text(size=10,angle=40,vjust=1,hjust=1))

fig_cap="2016-2030 Cumulative secondary weight changes associated with powertrain resizing due to primary material substitution by lightweighting scenario and subcomponent"
fig_num=fig_num+1
```

  
Finally, the material compositions of the resized components are adjusted according to the resizing weight ratio.  
  
####Iterative weight changes  
  
The Alonso et al. [-@Alonso2012] model accounts for iterative secondary weight changes with the mass decompounding effects. However, the previous powertrain and secondary battery resizing methods do not account for the infinite iteration of the secondary weight changes. Indeed, resizing the powertrain implies more weight changes in some components that could further reduce or increase the size of the powertrain. To account for those compounding effects, the developed methods for battery resizing, powertrain resizing and secondary weight changes are iteratively applied. This approach is similar to the method developed by Lewis et al. [-@Lewis2014a]. The cut-off value that determines the end of the iterative secondary weight changes is 0.5 kg, it means that iterative secondary weight changes, powertrain and battery resizing are applied while the weight changes are higher than 0.5 kg between two runs. Figure SI.`r fig_num+1` provides an illustration of the method. This method is applied annually to the vehicle type as primary and battery weight changes occur annually.  

```{r iterative_model}
fig_cap="Primary and secondary weight changes iterative method"
fig_num<-fig_num+1
```



![`r paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)`](figures_reports/prim_sec_svg.png)

The mathematical model of the iterative weight changes can be described with the following parameters and equations. $PS_{y}$ is the primary weight saving associated with the material susbtitution at year $y$ in kg. $BS_{y}[WS]$ is a function that returns the weights savings associated with the battery resizing from an original weight savings $WS$. $BS_{y}$ also includes the battery resizing associated with the technological improvements. $PwtS_{y}[WS]$ is a function that returns the secondary weight changes associated with the weight saving $WS$ exclusively associated with the powertrain resizing using MacKenzie et al. [-@MacKenzie2012] method. $SS_{Alonso}[WS]$ is the function that returns the secondary weight saving associated with the weight saving $WS$ without powertrain resizing using Alonso et al. [-@Alonso2012] method. $SS_{Alonso}$ includes the compounding effects of the secondary weight changes while $PwtS_{y}$ and $BS_{y}$ do not include the compounding effects of the secondary weight changes. The iteration to get the final curb weight $CW_{f,y}$ at year y correspond to the following series:
  
$CW_{1,y} = CW_{f,y-1} - PS_{y}$ 
  
$CW_{2,y} = CW_{1,y} - BS_{y}[PS_{y}]$
  
$CW_{3,y} = CW_{2,y} - PwtS_{y}[CW_{f,y-1} - CW_{2,y}]$
  
$CW_{4,y} = CW_{3,y} - SS_{Alonso}[CW_{f,y-1} - CW_{3,y}]$
    
.  
    
$CW_{j,y} = CW_{j-1,y} - BS_{y}[CW_{j-3,y} - CW_{j-1,y}]$
  
$CW_{j+1,y} = CW_{j,y} - PwtS_{y}[CW_{j-2,y} - CW_{j,y}]$
  
$CW_{j+2,y} = CW_{j+1,y} - SS_{Alonso}[CW_{j-1,y} - CW_{j+1,y}]$
  
The iteration runs while $CW_{j,y}-CW_{j+2,y}>0.5 kg$.  
    
Finally, from the previous subcomponent mass savings, the subcomponent material compositions are adapted to the new mass by keeping the same relative material content.  
Application of the iterative weight changes method is shown in Figure SI.`r fig_num+1` to the feature content increases. Our initial assumption is that 3 kg of new features are added annually to the vehicle curb weights. These increasing feature contents lead to secondary weight changes, powertrain and secondary battery resizing and Figure SI.`r fig_num+1` shows the resulting weight changes in the impacted components for relevant vehicle technologies. We note that cars and light trucks possess the same weight changes, according to our previous assumptions, but the different technologies possess slightly different results due to different powertrain characteristics.    

```{r tot_wgt_changes_ftr,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap), fig.width=6, fig.height=3}
source("outputs/functions/read_f.R")
bat_svg <- do.call(read_simulation_f,list(function_tbc="fleet_mc_proj_f",sim_tbc="sim3",dts_names="bat_svg"))
sec_svg <- do.call(read_simulation_f,list(function_tbc="fleet_mc_proj_f",sim_tbc="sim3",dts_names="sec_svg"))
pwt_svg <- do.call(read_simulation_f,list(function_tbc="fleet_mc_proj_f",sim_tbc="sim3",dts_names="pwt_svg"))
#cum_ftr_wgt is the cumulative weight from 2015 to 2030 due to feature content
cum_ftr_wgt <- subset(rbind(bat_svg,sec_svg,pwt_svg),Subcomponent!="Total"&Scenario%in%c("BAU")&`2030`!=0&Size=="Car"&Technology%in%c("BEV300","FFV","HEV","ICEV-G","PHEV40"))

for (r in 1:nrow(cum_ftr_wgt)){
  cum_ftr_wgt[r,as.character(2016:2050)]<-cumsum(t(cum_ftr_wgt[r,as.character(2016:2050)]))
}
ids_names<-colnames(cum_ftr_wgt)[!grepl(pattern="[[:digit:]]{1}",colnames(cum_ftr_wgt))]
plot_dt <- subset(melt(cum_ftr_wgt, id.vars = ids_names,variable.name = "Year"),Subcomponent!="Total")
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_dt),c("value")),response = "value")
plot_area<-aggregate(data = plot_dt,agg.formula,FUN=sum)
plot_area$Year <- as.numeric(as.character(plot_area$Year))
#Format
plot_area$Subcomponent<-factor(plot_area$Subcomponent,levels=unique(plot_dt$Subcomponent))
ggplot(subset(plot_area,Year%in%c(2030,2050)))+
  geom_col(aes(x=Technology,y=value,fill=Subcomponent))+
  facet_wrap(~paste0("2016-",Year))+
  labs(x=NULL,y="Weight changes (kg)")+
  theme_milovanoff(legend_position="right")+
  scale_fill_milovanoff(breaks=unique(plot_dt$Subcomponent),
                        guide=guide_legend(title="Component",reverse=FALSE))+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1))

fig_cap="Cumulative primary and secondary weight changes due to feature content increases over the periods 2016-2030 and 2016-2050"
fig_num=fig_num+1
```


In total, feature content increases the vehicle curb weight of ICEV-G cars by `r format(sum(subset(plot_area,Scenario=="BAU" & Size=="Car" & Technology=="ICEV-G" & Year==2030)[,"value"]),digits=0)` kg in 2030 and `r format(sum(subset(plot_area,Scenario=="BAU" & Size=="Car" & Technology=="ICEV-G" & Year==2050)[,"value"]),digits=0)` kg in 2050 compared to 2016 designs.  

Figure SI.`r fig_num+1` presents the cumulative primary and secondary weight changes due to battery technology improvements in plug-in electric vehicles over the period 2016-2030. These results do not account for the effects of increasing feature content or lightweighting scenarios and follow the iterative method previously described.  

```{r tot_mass_sav_bat_ev,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap), fig.width=6, fig.height=3}
source("outputs/functions/read_f.R")
bat_svg <- do.call(read_simulation_f,list(function_tbc="fleet_mc_proj_f",sim_tbc="sim2",dts_names="bat_svg"))
sec_svg <- do.call(read_simulation_f,list(function_tbc="fleet_mc_proj_f",sim_tbc="sim2",dts_names="sec_svg"))
pwt_svg <- do.call(read_simulation_f,list(function_tbc="fleet_mc_proj_f",sim_tbc="sim2",dts_names="pwt_svg"))

#cum_ftr_wgt is the cumulative weight from 2015 to 2030 due to feature content
cum_bat_wgt <- subset(rbind(bat_svg,sec_svg,pwt_svg),Subcomponent!="Total"&Scenario%in%c("BAU")&`2030`!=0&(grepl("BEV",Technology) | grepl("PHEV",Technology)) & Case=="Low")

for (r in 1:nrow(cum_bat_wgt)){
  cum_bat_wgt[r,as.character(2016:2050)]<-cumsum(t(cum_bat_wgt[r,as.character(2016:2050)]))
}
ids_names<-colnames(cum_bat_wgt)[!grepl(pattern="[[:digit:]]{1}",colnames(cum_bat_wgt))]
plot_dt <- subset(melt(cum_bat_wgt, id.vars = ids_names,variable.name = "Year"),Subcomponent!="Total")
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_dt),c("value")),response = "value")
plot_area<-aggregate(data = plot_dt,agg.formula,FUN=sum)
plot_area$Year <- as.numeric(as.character(plot_area$Year))
#Format
plot_area$Subcomponent<-factor(plot_area$Subcomponent,levels=unique(plot_dt$Subcomponent))
ggplot(subset(plot_area,Year%in%c(2030)))+
  geom_col(aes(x=Technology,y=value,fill=Subcomponent))+
  facet_wrap(~Size)+
  labs(x=NULL,y="2016-2030 Cumulative \n weight changes (kg)")+
  theme_milovanoff(legend_position="right")+
  scale_fill_milovanoff(breaks=unique(plot_dt$Subcomponent),
                        guide=guide_legend(title="Component",reverse=TRUE))+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1))

fig_cap="Cumulative weight changes due to battery technology improvements over the period 2016-2030"
fig_num=fig_num+1
```


The expected improvements in battery technologies and in fuel consumption could reduce the curb weight of BEV300 light-trucks by `r format(-sum(subset(cum_bat_wgt,Scenario=="BAU" & Size=="Light truck" & Technology=="BEV300")[,"2030"]),digits=0)` kg in 2030 compared to 2016 designs after secondary weight changes, powertrain and secondary battery resizing. The vast majority of the results are due to the doubling in energy density for battery technologies by 2030 assumed by default in the model.        
  
  
####Overall primary and secondary weight changes due to lightweighting
  
Figure SI.`r fig_num+1` contains the overall weight changes due to lightweighting in the 2030 model-year vehicle designs compared to 2016 model-year vehicles. Figure SI.`r fig_num+1` accounts for material substitutions and the iterative secondary weight changes, powertrain and secondary battery resizing method. It does not account for the primary battery resizing due to technological improvements or the feature content weight increases.  
  
```{r tot_mass_sav, fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap), fig.height=5, fig.width=8}
source("outputs/functions/read_f.R")
fleet_mc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_mc_proj_f",fast_mode="y"))
pr_svg<-fleet_mc_proj_f_res[["pr_svg"]]
sec_svg<-fleet_mc_proj_f_res[["sec_svg"]]
pwt_svg<-fleet_mc_proj_f_res[["pwt_svg"]]
bat_svg<-fleet_mc_proj_f_res[["bat_svg"]]
tot_svg<-pr_svg
tot_svg[,as.character(2016:2030)]<-pr_svg[,as.character(2016:2030)] + sec_svg[,as.character(2016:2030)] + pwt_svg[,as.character(2016:2030)] + bat_svg[,as.character(2016:2030)]

cum_tot_svg<-tot_svg
cum_pwt_svg<-pwt_svg
cum_sec_svg<-sec_svg
cum_bat_svg<-bat_svg
cum_pr_svg<-pr_svg
for (r in 1:nrow(tot_svg)){
  cum_tot_svg[r,as.character(2016:2030)]<-cumsum(t(tot_svg[r,as.character(2016:2030)]))
  cum_pr_svg[r,as.character(2016:2030)]<-cumsum(t(pr_svg[r,as.character(2016:2030)]))
  cum_sec_svg[r,as.character(2016:2030)]<-cumsum(t(sec_svg[r,as.character(2016:2030)]))
  cum_pwt_svg[r,as.character(2016:2030)]<-cumsum(t(pwt_svg[r,as.character(2016:2030)]))
  cum_bat_svg[r,as.character(2016:2030)]<-cumsum(t(bat_svg[r,as.character(2016:2030)]))
}
cum_pr_svg[,"Data"]<-"Material substitution"
cum_sec_svg[,"Data"]<-"Secondary weight changes without resizing"
cum_pwt_svg[,"Data"]<-"Powertrain resizing"
cum_bat_svg[,"Data"]<-"Secondary battery resizing"
#Aggregated dataframe with all savings
cum_svg<-rbind(cum_pr_svg,cum_sec_svg,cum_pwt_svg,cum_bat_svg)
#Other parameters
year_tbc<-as.character(2030)
col_names<-c(colnames(cum_svg)[!grepl(pattern="[[:digit:]]{1}",colnames(cum_svg))],year_tbc)
cum_svg<-cum_svg[cum_svg$Subcomponent=="Total",col_names]
#lw_cum_svg contains savings only due to lightweighting
lw_cum_svg<-cum_svg
#Get savings due to lightweighting.
param_col<-c("Size","Technology","Subcomponent","Data")
for (c in which(lw_cum_svg$Scenario!="BAU")){
  #ref_row is the row that contains the BAU results
  ref_row<-which(sapply(1:nrow(cum_svg),function(x)paste(cum_svg[x,param_col],collapse=",")) %in% paste(cum_svg[c,param_col],collapse=",")&cum_svg$Scenario=="BAU")
  #Substract the BAU savings
  lw_cum_svg[c,year_tbc]<-cum_svg[c,year_tbc]-cum_svg[ref_row,year_tbc]
}


plot_col<-subset(lw_cum_svg,!Scenario%in%c("BAU","Adapted Aluminum Maximum"))
lw_order<-c("Steel Intensive","Aluminum Intensive","Aluminum Maximum")
plot_col$Scenario<-factor(plot_col$Scenario,levels=lw_order)
svg_order<-c("Material substitution","Secondary weight changes without resizing","Powertrain resizing","Secondary battery resizing")
plot_col$Data<-factor(plot_col$Data,levels=svg_order)

ggplot(plot_col)+
  geom_col(aes(x=Technology,y=`2030`,fill=Data),
           position=position_stack(reverse=TRUE)) +
  #geom_text(aes(x=Technology,y=`2030`,label=Relative,group=Data),position = position_stack(vjust = 0.5),size=4.5) +
  facet_grid(Size~`Scenario`,scales = "free_y") +
  labs(x=NULL,y="Overall mass savings \n due to lightweighting (kg)")+
  theme_milovanoff()+
        scale_fill_milovanoff(name="Type of savings",
                              guide=guide_legend(ncol=1))+
        theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1))

fig_cap="Overall weight savings due to lightweighting"
fig_num=fig_num+1

#Numerical values
#subset(plot_col,Technology%in%c("ICEV-G","BEV")&Size=="Car"&Data=="Primary savings",select=c(Scenario,Technology,Data,relative))

```


####Curb weight and material composition in 2030
  
Figures SI.`r fig_num+1` and SI.`r fig_num+2` presents the curb weights and material compositions by vehicle type and lightweighting scenario in 2030 compared to the initial design (i.e., 2015 design).  
  
```{r mat_comp_2030_car,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=7, fig.height=9}
#source
source("outputs/functions/read_f.R")
fleet_mc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_mc_proj_f",fast_mode="y"))
#Input files
Fleet_mat_comp_15to50<-fleet_mc_proj_f_res[["fleet_mt_comp_proj"]]
vehicle_technology <- read.csv("inputs/vehicle_technology.csv", stringsAsFactors = FALSE, check.names = FALSE)
#Format data
Fleet_mat_comp_15to50<-melt(Fleet_mat_comp_15to50, id=c("Scenario","Size", "Technology", "Material"), variable.name ="Year")
Fleet_mat_comp_15to50$Year<-as.numeric(as.character(Fleet_mat_comp_15to50$Year))
plot_col<-subset(Fleet_mat_comp_15to50,subset=Scenario!="Adapted Aluminum Maximum"&((Scenario=="BAU"&Year==2015)|(Year==2030))&Material!="Total")
plot_col$Scenario[plot_col$Scenario=="BAU"&plot_col$Year==2015]<-"2015 design"
plot_col$Scenario[plot_col$Scenario=="BAU"]<-"No lightweighting"

lw_order<-c("2015 design","No lightweighting","Steel Intensive","Aluminum Intensive","Aluminum Maximum")
plot_col$Scenario<-factor(plot_col$Scenario,levels=lw_order)

#Format
plot_col$Material[grepl("steel",plot_col$Material)] <- "Steel"
mat_order <- c("Steel","Cast Iron","HSS/AHSS","Cast Aluminum","Wrought Aluminum","Other")
plot_col$Material<-factor(plot_col$Material,levels=mat_order)

techno_order<-c("ICEV-G","ICEV-D","FFV","CNG","HEV","PHEV20","PHEV40","BEV100","BEV300","FCV")
plot_col$Technology<-factor(plot_col$Technology,levels=techno_order)

ggplot(subset(plot_col,Size=="Car"))+
  geom_col(aes(x=Scenario,y=value,fill=Material))+
  facet_wrap(~paste(Technology,Size), ncol=2,scales="free_y")+
  labs(y="Weight (kg)",x=NULL)+
  theme_milovanoff()+
  scale_fill_milovanoff(name="Material")+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        legend.position = "right",
        legend.direction="vertical")

fig_cap="2015 and 2030 curb weight and material composition by vehicle technology for cars"
fig_num=fig_num+1
```

```{r mat_comp_2030_lt,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=7, fig.height=9}
#RUN PREVIOUS CHUNK

ggplot(subset(plot_col,Size=="Light truck"))+
  geom_col(aes(x=Scenario,y=value,fill=Material))+
  facet_wrap(~paste(Technology,Size), ncol=2,scales="free_y")+
  labs(y="Weight (kg)",x=NULL)+
  theme_milovanoff()+
  scale_fill_milovanoff(name="Material")+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        legend.position = "right",
        legend.direction="vertical")

fig_cap="2015 and 2030 curb weight and material composition by vehicle technology for light trucks"
fig_num=fig_num+1
```

###SI.2.3.2 Projection of fuel consumption values

The fuel consumption values of the sixteen vehicle types are projected from 2016 to 2050. Using the fuel consumption values by vehicle type in 2015 as the initial values, annual fuel consumption improvements due to improvement in engine technologies and annual fuel consumption changes due to weight savings are presented as:
  
$${FC}_{y,t}={FC}_{y-1,t}+\Delta_{IMP}{FC}_{y,t}+\Delta_{LW}{FC}_{y,t}$$
  
with:

*  ${FC}_{y,t}$ and ${FC}_{y-1,t}$ the current and previous-year fuel consumption values;
*  $\Delta_{IMP}{FC}_{y,t}$ and $\Delta_{LW}{FC}_{y,t}$ the annual fuel consumption improvements and lightweighting for the model-year "y" of the vehicle type "t".  
The following sections describe the applied method and assumptions. 

####Fuel consumption improvements
The annual fuel consumption improvements are derived from the Annual Energy Outlook (AEO) 2018 [@EIA2018] and are adapted with the following steps:

*  The AEO 2018 projections include the fuel economy values (i.e., the inverse of the fuel consumption values, in Miles per Gallon) from 2016 to 2050 by vehicle technology and vehicle class (e.g., compact cars, small utility) [@EIA2018]. From those values, the relative annual changes are calculated and correspond to the annual changes of the average fuel economy value for a vehicle type relative to the previous year value.
*  Among those changes, it is necessary to distinguish the changes associated with transmission, aerodynamics, or engine improvements from the changes associated with mass reductions. In this manner, fuel consumption changes due to lightweighting are not double-counted. The key assumptions report associated with the AEO 2017 [@U.S.EnergyInformationAdministration2017] contains two standard technology matrices (i.e., one for cars and one for light trucks) that describe some sets of technological advances with the associated fuel efficiency changes, incremental costs, introduction year and horsepower changes for example. Part of those technological advances are implemented in the AEO projections based on some technical objectives and economic factors. However, the set of technological advances actually implemented by vehicle type is not provided in the AEO projections. Thus, the technological reasons behind the annual fuel consumption changes are unknown. To obtain the fuel consumption improvements without lightweighting, it is assumed that only the technological advances called "Mass Reduction" represent the lightweighting fuel efficiency changes. These improvements need to be subtracted to the overall fuel efficiency changes.
*  Fuel efficiency changes associated with "Mass Reduction" technologies possess five levels and have a maximum fuel efficiency change of 11.6% compared to the original fuel economy values of 2016. Three sensitivity scenarios are built to account for fuel efficiency changes due to mass reduction in the AEO 2018 projections: the "Low fuel consumption improvement" scenario assumes that the maximum fuel efficiency changes due to mass reduction are implemented in all vehicle types, that is 11.6% of fuel efficiency changes, the "Medium fuel consumption improvement" scenario assumes the second level of fuel efficiency changes due to mass reduction, that is 5.4%, and the "High fuel consumption improvement" scenario assumes no fuel efficiency changes due to mass reduction. The "Medium fuel consumption improvement" scenario is the scenario by default.
*  The overall relative fuel efficiency changes by vehicle type are calculated by considering the 2016 value and the minimum fuel economy value through 2016-2050. Then, the estimated fuel efficiency changes due to lightweighting (i.e., 5.4% by default) are subtracted to obtain the relative fuel efficiency changes due to fuel consumption improvements without lightweighting. The overall relative changes are converted in annual changes by considering the distribution changes provided by AEO projections. Finally, the annual relative changes are translated into absolute relative changes by considering the 2015 fuel consumption values by vehicle type calculated previously in the vehicle module.  

Figure SI.`r fig_num+1` contains the cumulative absolute improvements by vehicle type from 2016 to 2050 due to fuel consumption improvements in the Medium Fuel Consumption Improvements scenario (bars). Error bars represent the variations of the fuel consumption improvements from the No Improvements case to the High Fuel Consumption Improvements case. It is important to note that the values are not standardized in equivalent unit. The fuel consumption changes accross vehicle technologies are in L or kWh of the associated fuel type per 100km and are therefore not directly comparable.  

```{r fleet_fc_impro,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=9, fig.height=4}
source("functions/plots/cum_long_dtf_f.R")
source("outputs/functions/read_f.R")
fleet_fc_impro_dt<-do.call(read_simulation_f,list(function_tbc="fleet_fc_proj_f",sim_tbc="sim4",dts_names="fleet_fc_impro_dt"))
fleet_fc_impro_dt$value<-as.numeric(fleet_fc_impro_dt$value)
fleet_fc_impro_dt$Year<-as.numeric(fleet_fc_impro_dt$Year)
#Cumulative FC improvement
cum_fc_impro_sim<-cum_long_dtf_f(dtf=subset(fleet_fc_impro_dt,LWscen=="BAU"),cum_variable = "value",cum_param = "Year")
plot_bar<-subset(cum_fc_impro_sim,subset= LWscen=="BAU" & Year==2050 & Case=="Default improvements",select=-Case)
colnames(plot_bar)[colnames(plot_bar)=="value"]<-"def"
plot_bar[,"min"]<-subset(cum_fc_impro_sim,subset= LWscen=="BAU" & Year==2050 & Case=="No improvements",select=value)
plot_bar[,"max"]<-subset(cum_fc_impro_sim,subset= LWscen=="BAU" & Year==2050 & Case=="High improvements",select=value)

#Format for plot
plot_bar$Technology[plot_bar$Technology=="PHEV20" & plot_bar$`Fuel type`=="Gasoline"]<- "PHEV20 (CS mode)"
plot_bar$Technology[plot_bar$Technology=="PHEV20" & plot_bar$`Fuel type`=="Electricity"]<- "PHEV20 (CD mode)"
plot_bar$Technology[plot_bar$Technology=="PHEV40" & plot_bar$`Fuel type`=="Gasoline"]<- "PHEV40 (CS mode)"
plot_bar$Technology[plot_bar$Technology=="PHEV40" & plot_bar$`Fuel type`=="Electricity"]<- "PHEV40 (CD mode)"
plot_bar[plot_bar=="Gasoline"]<-"E10"
plot_bar[plot_bar=="Ethanol"]<-"E85"

ggplot(plot_bar)+
  geom_col(aes(x=Technology,y=def,fill=Size),
           position="dodge",
           width=1)+
  geom_errorbar(aes(x=Technology,ymin=min,ymax=max,group=Size),
                width=0.5,
                position=position_dodge(width=1),
                size=1.2)+
  facet_grid(.~paste(`Fuel type`,"\n",Unit),scales="free_x",space="free_x")+
  ylab("L/100k or kWh/100km")+
  theme_milovanoff()+
  scale_fill_milovanoff(name=NULL)+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=9),
        legend.margin=margin(t=0,unit="cm"))

fig_cap="2016-2050 cumulative absolute changes in fuel consumption values due to technological advancements with bounding cases"
fig_num=fig_num+1

#Numerical value
#subset(plot_bar,subset= LWscen=="BAU" & Year==2050 & Technology=="ICEV-G")
```

Figure SI.`r fig_num+1` presents the annual distribution of the fuel consumption changes due to technological advancements. According to the AEO 2018, fuel consumption changes occur before 2025 due to the CAFE standards that are currently in place until 2025 [@NHTSA2018]. Moreover, dips and peaks in annual improvements are due to temporal distributions as modeled by AEO 2018.  

```{r fleet_fc_impro_annual,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=8, fig.height=4}
source("outputs/functions/read_f.R")
fleet_fc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_fc_proj_f",fast_mode="y"))
fleet_fc_impro_dt<-fleet_fc_proj_f_res[["fleet_fc_impro_dt"]]
fleet_fc_impro_dt$value<-as.numeric(fleet_fc_impro_dt$value)
fleet_fc_impro_dt$Year<-as.numeric(fleet_fc_impro_dt$Year)
#Plot cumulative fc improvement
plot_dt<-subset(fleet_fc_impro_dt,subset= LWscen=="BAU")

plot_dt[plot_dt=="Gasoline"]<-"E10"
plot_dt[plot_dt=="Ethanol"]<-"E85"

ggplot(plot_dt)+
  geom_line(aes(x=Year,y=value,colour=Technology,linetype=Size),
            size=1.1)+
  facet_wrap(~paste(`Fuel type`,Unit),scales="free_y",nrow=2)+
  ylab("L/100k or kWh/100km")+
  theme_milovanoff()+
  scale_colour_milovanoff(name="Technology")+
  scale_linetype(name="Category")+
  theme(axis.text.x = element_text(angle=0,vjust=1,hjust=0.5),
        axis.title.x = element_blank(),
        strip.text.x = element_text(angle = 0))

fig_cap="2016-2050 absolute annual improvements in fuel consumption values due to technological advancements"
fig_num=fig_num+1
```

####Fuel consumption reductions due to vehicle lightweighting

The core objective of this study is to model the fuel consumption changes due to vehicle lightweighting $\Delta_{LW}{FC}_{y,t}$. The physics-based model developed by Kim and Wallington [-@Kim2016] is extensively used to calculate fuel reduction values (FRVs). A FRV is defined as a change of vehicle fuel consumption upon weight savings and is in L/(100 km 100 kg) or kWh/(100 km 100 kg). Combining FRV with weight savings estimates the fuel consumption changes due to vehicle lightweighting:
  
$$\Delta_{LW}{FC}_{y,t}=\Delta{CW}_{(y-1)->y,t}*{FRV}_{y,t}$$
with $\Delta_{LW}{FC}_{y,t}$ the annual fuel consumption changes due to lightweighting, $\Delta{CW}_{(y-1)->y,t}$ the annual vehicle curb weight changes and ${FRV}_{y,t}$ the fuel reduction value for the model-year "y" of the vehicle type "t".

In this study, fuel reduction values (FRVs) are computed annually by vehicle type.  It is important to note that the unit of FRV is fuel-specific to ensure physical coherence. Therefore, an ICEV-D has a FRV in L of diesel per 100 km and 100 kg and an ICEV-G has a FRV in L of gasoline per 100 km and 100 kg. FRVs can nevertheless be converted in liter of gasoline equivalent per 100 km and 100 kg to be compared. The following subsection describes the model and assumptions to compute the fuel reductions values (FRVs).

#####Fuel Reduction Value equations

The FRV calculations are fully derived from the equations set up by Kim and Wallington [-@Kim2016] with data taken from the Argonne National Laboratory [-@Moawad2016]. FRV corresponds to the ratio of the mass-dependent fuel consumed to the total fuel consumed multiplied by the normalized fuel consumption value (i.e., the fuel consumption per vehicle curb weight) on a given driving condition. This initial definition could be described by the following equation: 
    
$${FRV}_{y,t}=\frac{{Fw}_{y,t}}{{Ft}_{y,t}}*\frac{{FC}_{y,t}}{{CW}_{y,t}}*100$$
with ${FRV}_{y,t}$ the fuel reduction value, ${Fw}_{y,t}$ and ${Ft}_{y,t}$ the mass-dependent fuel consumption and the total fuel consumption (in L) associated with a driving test, ${FC}_{y,t}$ and ${CW}_{y,t}$ the fuel consumption (in L/100km or kWh/100km) and the curb weight (in kg) for the model-year "y" of the vehicle type "t".
It is noted that ${FC}_{y,t}$ and ${CW}_{y,t}$ may depend on ${FRV}_{y,t}$ if lightweighting is implemented and if some components are resized based on the fuel consumption value (for example battery in electric vehicles). To simplify the iteration process, it is assumed that ${FC}_{y,t}={FC}_{y-1,t}$, ${CW}_{y,t}={CW}_{y-1,t}$ and that the changes from y to y-1 are marginal and do not influence the FRV calculations.   
Some powertrain parameters such as engine displacement could be adjusted to keep equivalent performances with the mass reductions. As explained by Kim and Wallington [-@Kim2016], this factor does not affect battery-electric vehicles. In case of powertrain adjustments, the mass-dependent fuel consumption should include the frictional loss term ${Ff}_{y,t}$. By default in this study, the computed FRVs consider 50% of powertrain adjustments when possible. The FRV equation including powertrain adjustments therefore becomes:  
    
$${FRV^+}_{y,t}=\frac{{Fw}_{y,t}+{Ff}_{y,t}}{{Ft}_{y,t}}*\frac{{FC}_{y,t}}{{CW}_{y,t}}*100$$
with ${FRV^+}_{y,t}$ the fuel reduction value with powertrain adjustments,${Fw}_{y,t}$, ${Ff}_{y,t}$ and ${Ft}_{y,t}$ the mass-dependent, frictional loss and the total fuel consumptions (in L) associated with a driving test, ${FC}_{y,t}$ and ${CW}_{y,t}$ the fuel consumption and the curb weight for the model-year "y" of the vehicle type "t".  

To calculate $Fw$, $Fl$ and $Ft$, Kim and Wallington [-@Kim2016] offer a set of equations that require vehicle-specific coast-down coefficients (i.e., rolling, rotating and aerodynamic) as provided by the U.S. EPA. However, those coefficients are not available for an average fleet as needed in this study. Therefore another approach based on a set of equations provided by Kim and Wallington in an earlier study [-@Kim2013] are used. The equations do not consider model-specific coast-down coefficients but computed vehicle loads based on rotational mass factors, rolling resistance, aerodynamic drag coefficients and frontal areas among others. The parameters are estimated annually by vehicle type based on data from Moawad et al. [-@Moawad2016]. $Fw$, $Fl$ and $Ft$ are calculated for two driving tests, highway and city as described by Kim and Wallington [-@Kim2013], then combined with 55% of the city value and 45% of the highway value.  
The adapted equations are:
  
$${Fw}_{y,t}=\frac{{CW}_{y,t}}{{Hf}_{t}*\eta_{trans,y}*\eta_{eng,t,y}}*((1-\theta*\mu+\epsilon)*I_1+{CR}_{y}*g*I_2)$$

$${Ff}_{y,t}=\frac{{CW}_{y,t}}{{Hf}_{t}*\eta_{eng,t,y}}*0.5*f_{mep}\frac{D}{CW}(\frac{N}{V})*I_2$$
  
and
  
$${Ft}_{y,t}={FC}_{y,t}/100/10^3*I_2$$
with:

*  y the year and t the vehicle type.
*  ${Hf}_{t}$ the lower heating value of the fuel consumed by the vehicle type "t" (in J/L or 3.6E^06^ J/kWh for electricity).
*  $\eta_{eng,t,y}$ the engine efficiency which corresponds to the thermodynamic engine efficiency for combustion engine, electric motor conversion efficiency for electric motor and combination of both for hybrid considering the fraction of electric motor as given by Kim and Wallington [-@Kim2016].
*  Thermodynamic engine efficiencies for ICEV-G, HEV and PHEV are taken from Moawad et al. [-@Moawad2016] with a value of 0.38 in 2015 and 0.47 in 2050. Other vehicle types have different thermodynamic engine efficiencies as described in Moawad et al. [-@Moawad2016].
*  Electric motor conversion efficiencies are taken from Moawad et al. [-@Moawad2016] with a value of 0.92 in 2015 and 0.96 in 2050.
*  $\eta_{trans,y}$ the transmission efficiency taken from Moawad et al. [-@Moawad2016] with a value of 0.88 in 2015 and 0.91 in 2050.
*  $\theta$ the ratio of braking to kinetic energy taken from Kim and Wallington [-@Kim2016] with a value of 0.74 and 0.41 on city and highway respectively for BEV, PHEV, HEV and FCV.
*  $\mu$ the regenerative braking efficiency taken from Kim and Wallington [-@Kim2016] with a value of 0.8;
*  $\epsilon$ the rotational mass factor with a value of 0.1 [@Kim2013].
*  ${CR}_y$ the rolling resistance coefficient taken from Moawad et al. [-@Moawad2016] with values of 0.008 and 0.009 in 2015, 0.007 and 0.008 in 2050 for cars and light trucks respectively.
*  $g$ the gravitational acceleration (i.e., 9.8 m/s^2^).
*  $f_{mep}\frac{D}{CW}(\frac{N}{V})$ a constant with the friction mean effective pressure $f_{mep}$, the engine displacement $D$, the curb weight $CW$, the gear ratio $\frac{N}{V}$. This ratio is assumed constant with a value of 0.3325 J/(kg.m) derived from Kim and Wallington [-@Kim2013].
*  $I_1$, $I_2$, $I_3$, $I_4$, $I_5$ are the respective intregrals $\int avdt$, $\int vdt$, $\int v^3dt$, $\int v^2dt$, $\int dt$ associated with the driving test. Values are taken from Kim and Wallington [-@Kim2016].
*  Finally, when the parameters where given with a city and a highway values, the combination 0.55/0.45 is considered.    

The evolving parameters (i.e., $\eta_{eng,t,y}$, $\eta_{trans,y}$, and ${CR}_y$) from 2015 to 2050 assume the same distributions as described by Moawad et al. [-@Moawad2016] (i.e., values given in 2015, 2020, 2025, 2030 and 2045) plus linear evolutions between the years and constant values after 2045. It is noted that the bottom-approach to account for efficiency improvements may not provide the same results than the top-down approach on fuel consumption improvements taken from the AEO 2018 projections. We believe the two methods to be consistent as they affect different part of the models.    

In the previous equations, $Fw$, and $Ff$ use 2-cycle driving tests integration values. However, $Ft$ and $FC$ use 5-cycle driving tests adjusted values as provided by the U.S. EPA. Therefore, as such, the equations are not consistent. According to the U.S. EPA [-@UnitedStatesEnvironmentalProtectionAgency2016], the ratio of adjusted (5-cycle) combined fuel economy to unadjusted (2-cycle) combined fuel economy is 0.782 in 2016 (table 10.1 page 128). We assume that the unadjusted (2-cycle) $Fw$, and $Ff$ values have the same ratio and therefore multiply the previously estimated $Fw$, and $Ff$ values by $1/0.782=1.23$ to obtain the adjusted (5-cycle) $Fw$, and $Ff$ values.  

By default, in this study, the fuel reduction values are computed assuming 50% powertrain adjustments when possible (i.e., for conventional and hybrid vehicles). It means that the fuel reduction values used by default are the average of the fuel reduction values without powertrain adjustments and the values with powertrain adjustments. This ratio is altered in the sensitivity analysis.    

#####Computed fuel reduction values from 2015 to 2050

The fuel reduction values (FRVs) by vehicle type are computed from 2015 to 2050. Figure SI.`r fig_num+1` contains the adjusted (5-cycle) FRVs converted in liter of gasoline equivalent per 100 km and 100 kg in the No Lightweighting scenario (i.e., no vehicle primary weight savings from 2015 to 2050) and with default assumptions. PHEV possess two FRV, one for the CD mode and one for the CS mode. FRVs shown Figure SI.`r fig_num+1` includes 50% of powertrain adjustments.    

```{r frv_plot,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=8, fig.height=4}
source("outputs/functions/read_f.R")
fleet_fc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_fc_proj_f",fast_mode="y"))
fleet_frv_dt<-fleet_fc_proj_f_res[["fleet_frv_dt"]]
#Input
fuel_conv<-read.csv("inputs/fuel_conversion.csv", stringsAsFactors = FALSE, check.names = FALSE)
fleet_frv_dt$value<-as.numeric(fleet_frv_dt$value)
#Convert FRV in gasoline equivalent
for (fuel in unique(fleet_frv_dt$`Fuel type`)){
  fuel_conv_fact<-fuel_conv[fuel_conv$Fuel==fuel&fuel_conv$Data=="Conversion factor","value"]/fuel_conv[fuel_conv$Fuel=="Gasoline"&fuel_conv$Data=="Conversion factor","value"]
  fleet_frv_dt[fleet_frv_dt$`Fuel type`==fuel,"value"]<-fleet_frv_dt[fleet_frv_dt$`Fuel type`==fuel,"value"]*fuel_conv_fact
}
LWscen_tbc<-c("BAU")  
#Create plot data frame
plot_dt<-subset(fleet_frv_dt,LWscen==LWscen_tbc)
plot_dt$Year<-as.numeric(as.character(plot_dt$Year))

plot_dt[plot_dt=="Gasoline"]<-"E10"
plot_dt[plot_dt=="Ethanol"]<-"E85"

ggplot(plot_dt)+
  geom_line(aes(x=Year,y=value,linetype=Size,color=Technology),
            size=1.3)+
  facet_wrap(~paste(`Fuel type`),scales="free_y")+
  labs(y="FRV \n (L of gasoline eq./(100km.100kg))",x=NULL)+
  theme_milovanoff()+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name="Technology",guide=guide_legend(order=1))+
  scale_linetype(name="Category")

fig_cap="2016-2050 adjusted (5-cycle) fuel reduction values (FRV) by vehicle type converted in liter of gasoline equivalent"
fig_num=fig_num+1

#Numerical values
#subset(plot_dt,Technology=="ICEV-G"&Size=="Car"&Year%in%c(2016,2030))
```
  
Due to improvements in vehicle attributes (such as engine efficiency, transmission efficiency, etc.), the FRVs decrease drastically from 2015 to 2030 for all vehicle types and then slowly from 2030 to 2050. Moreover, Kim and Wallington [-@Kim2013] showed that FRVs increase with vehicle mass. We estimate that light trucks possess higher FRVs than cars. Table SI.`r tab_num+1` provides the computed fuel reductions values by vehicle type at the first year of the model (i.e., 2016) with and without the powertrain adjustments. Our default values are the means of the two values.  

```{r frv_plot_2015}
source("outputs/functions/read_f.R")
fleet_frv_dt<-do.call(read_simulation_f,list(function_tbc="fleet_fc_proj_f",sim_tbc="sim3",dts_names="fleet_frv_dt"))
table_dt<-subset(fleet_frv_dt,Year==2016&LWscen=="BAU",select=c(Size,Technology,`Fuel type`,value,frv_pwt_r))
table_dt$value<-as.numeric(table_dt$value)
#Input
fuel_conv<-read.csv("inputs/fuel_conversion.csv", stringsAsFactors = FALSE, check.names = FALSE)
#Convert FRV in gasoline equivalent
for (fuel in unique(table_dt$`Fuel type`)){
  fuel_conv_fact<-fuel_conv[fuel_conv$Fuel==fuel&fuel_conv$Data=="Conversion factor","value"]/fuel_conv[fuel_conv$Fuel=="Gasoline"&fuel_conv$Data=="Conversion factor","value"]
  table_dt[table_dt$`Fuel type`==fuel,"value"]<-table_dt[table_dt$`Fuel type`==fuel,"value"]*fuel_conv_fact
}
table_tbs<-table_dt[table_dt$frv_pwt_r==1,c("Size","Technology","Fuel type")]
table_tbs[,"FRV with powertrain adjustments"]<-table_dt[table_dt$frv_pwt_r==1,"value"]
table_tbs[,"FRV without powertrain adjustments"]<-table_dt[table_dt$frv_pwt_r==0,"value"]


table_tbs[table_tbs=="Gasoline"]<-"E10"
table_tbs[table_tbs=="Ethanol"]<-"E85"

colnames(table_tbs)[1]<-"Category"
tab_cap="Fuel Reduction Values (FRVs) by vehicle type in 2016 in L equivalent of gasoline per 100 km and 100 kg"
tab_num=tab_num+1
knitr::kable(table_tbs,
             digits = 2,
             row.names = FALSE,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
#sum(subset(table_dt,Size=="Car"&Technology=="ICEV-G",value))/2
#sum(subset(table_dt,Size=="Car"&Technology=="BEV",value))/2

```


Kim and Wallington [-@Kim2016] include, in their supporting information, a comparison between unadjusted (2-cycle) FRVs and adjusted (5-cycle) FRVs. Adjusted FRVs range for conventional vehicles from 0.29 to 0.48 (L/100kg.100km) with powertrain adjustments and from 0.21 to 0.29 (L/100kg.100km) without powertrain adjustments. Our values are coherent with their values.  
Finally, the sensitivity of FRVs due to vehicle efficiency improvements is presented in Figure SI.`r fig_num+1`. Values in columns are the default values by vehicle technology and category in 2020 and 2030. Top values are the values without vehicle efficiency improvements after 2016 and bottom values are the values with high vehicle efficiency improvements after 2016.  


```{r fleet_frv_sens,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=7, fig.height=4}
source("functions/plots/cum_long_dtf_f.R")
source("outputs/functions/read_f.R")
fleet_frv_dt<-do.call(read_simulation_f,list(function_tbc="fleet_fc_proj_f",sim_tbc="sim4",dts_names="fleet_frv_dt"))
fuel_conv<-read.csv("inputs/fuel_conversion.csv", stringsAsFactors = FALSE, check.names = FALSE)
fleet_frv_dt$value<-as.numeric(fleet_frv_dt$value)
fleet_frv_dt$Year<-as.numeric(fleet_frv_dt$Year)
#Convert FRV in gasoline equivalent
for (fuel in unique(fleet_frv_dt$`Fuel type`)){
  fuel_conv_fact<-fuel_conv[fuel_conv$Fuel==fuel&fuel_conv$Data=="Conversion factor","value"]/fuel_conv[fuel_conv$Fuel=="Gasoline"&fuel_conv$Data=="Conversion factor","value"]
  fleet_frv_dt[fleet_frv_dt$`Fuel type`==fuel,"value"]<-fleet_frv_dt[fleet_frv_dt$`Fuel type`==fuel,"value"]*fuel_conv_fact
}

years_tbp<-c(2020,2030)

plot_bar<-subset(fleet_frv_dt,subset= LWscen=="BAU" & Year%in%years_tbp & Case=="Default improvements",select=-Case)
colnames(plot_bar)[colnames(plot_bar)=="value"]<-"def"
plot_bar[,"max"]<-subset(fleet_frv_dt,subset= LWscen=="BAU" & Year%in%years_tbp & Case=="No improvements",select=value)
plot_bar[,"min"]<-subset(fleet_frv_dt,subset= LWscen=="BAU" & Year%in%years_tbp & Case=="High improvements",select=value)

#Format for plot
plot_bar$Technology[plot_bar$Technology=="PHEV20" & plot_bar$`Fuel type`=="Gasoline"]<- "PHEV20 (CS mode)"
plot_bar$Technology[plot_bar$Technology=="PHEV20" & plot_bar$`Fuel type`=="Electricity"]<- "PHEV20 (CD mode)"
plot_bar$Technology[plot_bar$Technology=="PHEV40" & plot_bar$`Fuel type`=="Gasoline"]<- "PHEV40 (CS mode)"
plot_bar$Technology[plot_bar$Technology=="PHEV40" & plot_bar$`Fuel type`=="Electricity"]<- "PHEV40 (CD mode)"


plot_bar[plot_bar=="Gasoline"]<-"E10"
plot_bar[plot_bar=="Ethanol"]<-"E85"

order_techno<-subset(plot_bar,Size=="Car"&Year==2030)[order(subset(plot_bar,Size=="Car"&Year==2030,def)),"Technology"]
plot_bar$Technology<-factor(plot_bar$Technology,levels=order_techno)

ggplot(plot_bar)+
  geom_col(aes(x=Technology,y=def,fill=Size),
           position="dodge",
           width=1)+
  geom_errorbar(aes(x=Technology,ymin=min,ymax=max,group=Size),
                width=0.5,
                position=position_dodge(width=1),
                size=1.2)+
  facet_grid(Year~.,scales="free_x",space="free_x")+
  ylab("L gasoline eq./(100km.100kg)")+
  theme_milovanoff()+
  scale_fill_milovanoff(name=NULL)+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        axis.title.x = element_blank(),
        axis.title.y = element_text(hjust=1),
        strip.text.x = element_text(size=9),
        legend.margin=margin(t=0,unit="cm"))

fig_cap="Fuel reduction values by vehicle technology and category in 2020 and 2030. Columns are default values and bars range from no improvements (top values) to high improvements (bottom values)."
fig_num=fig_num+1

#Numerical value
#subset(plot_bar,subset= LWscen=="BAU" & Technology=="ICEV-G")
```

####Fuel consumption values from 2015 to 2050

The combination of fuel consumption changes due to fuel consumption improvements and to lightweighting with the historical fuel consumption values provide the projected fuel consumption values by vehicle type and lightweighting scenario as presented in Figures SI.`r fig_num+1` and SI.`r fig_num+2`.  
 
```{r fleet_proj_fc_car, fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=8,fig.height=8}
source("outputs/functions/read_f.R")
fleet_fc_proj_f_res <- do.call(fun_res_f,list(fun_name="fleet_fc_proj_f",fast_mode="y"))
plot_dt<-fleet_fc_proj_f_res[["fleet_FC_dt"]]


#Format PHEV modes
plot_dt$Technology[plot_dt$Technology=="PHEV20" & plot_dt$`Fuel type`=="Gasoline"]<- "PHEV20 (CS mode)"
plot_dt$Technology[plot_dt$Technology=="PHEV20" & plot_dt$`Fuel type`=="Electricity"]<- "PHEV20 (CD mode)"
plot_dt$Technology[plot_dt$Technology=="PHEV40" & plot_dt$`Fuel type`=="Gasoline"]<- "PHEV40 (CS mode)"
plot_dt$Technology[plot_dt$Technology=="PHEV40" & plot_dt$`Fuel type`=="Electricity"]<- "PHEV40 (CD mode)"

plot_dt$Scenario[plot_dt$Scenario=="BAU"]<-"No Lightweighting"
plot_dt<-subset(plot_dt,Year>=2015&Scenario!="Adapted Aluminum Maximum")

lw_order<-c("No Lightweighting","Steel Intensive","Aluminum Intensive","Aluminum Maximum")
plot_dt$Scenario<-factor(plot_dt$Scenario,levels=lw_order)


ggplot(subset(plot_dt,Size=="Car"))+
  geom_line(aes(x=Year,y=Value,color=Scenario),
            size=1.1)+
  facet_wrap(~paste(Technology,Size,Unit),scales="free_y",ncol=2)+
  labs(y="Fuel Consumption (L or kWh/100km)",x=NULL)+
  theme_milovanoff(legend_position="bottom")+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name=NULL,
                          guide=guide_legend(ncol=4))


fig_num<-fig_num+1
fig_cap<-"Projected fuel consumption values by vehicle type for cars in the different lightweighting scenarios"
```

```{r fleet_proj_fc_lt, fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=8,fig.height=8}
#RUN PREVIOUS CHUNK

ggplot(subset(plot_dt,Size=="Light truck"))+
  geom_line(aes(x=Year,y=Value,color=Scenario),
            size=1.1)+
  facet_wrap(~paste(Technology,Size,Unit),scales="free_y",ncol=2)+
  labs(y="Fuel Consumption (L or kWh/100km)",x=NULL)+
  theme_milovanoff(legend_position="bottom")+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name=NULL,
                          guide=guide_legend(ncol=4))


fig_num<-fig_num+1
fig_cap<-"Projected fuel consumption values by vehicle type for light trucks in the different lightweighting scenarios"
```
  

#SI.3 Fleet module
  
The fleet module builds the annual stock of light-duty vehicles by vehicle type and age in the U.S. from 2015 to 2050. Then, the annual fleet kilometers traveled are estimated and combined with the fuel consumptions by vehicle type to compute the annual fleet fuel use. This section describes the underlying assumptions of the fleet module.

##SI.3.1 Light-duty fleet stock

The light-duty fleet stock projections by vehicle type is derived from a model developed by Bandivadekar [-@Bandivadekar2008]. The annual on-road population of light-duty vehicles is built according to three attributes, the vehicle age which is associated with the vehicle model-year, the vehicle technology and the vehicle category. Each year, the light-duty fleet stock is adjusted based on the previous year annual stock and annual estimates of scrapped and new vehicles. The following equation describes the dynamics of the fleet turnover.
  
$$Stock_{y,t,c}=Stock_{y-1,t,c}+Sales_{y,t,c}-Scrapped_{y,t,c}$$
  
With $Sales$ representing the incoming vehicles, $Scrapped$ representing the outgoing vehicles (i.e., scrapped vehicles) and $Stock$ the total number of vehicles for the vehicle technology "t", vehicle category "c" at year "y". The annual light-duty vehicle population by technology, category and age is called the vintage stock.  
The following subsections describe the assumptions to estimate the historical and projected vintage stocks.  

###SI.3.1.1 Historical vintage stocks

Historical vintage stocks need to be built prior to 2015 to initiate the model after 2015. Those historical vintage stocks contain the annual on-road light-duty vehicle population by age, and vehicle type. Historical stocks are built from 1970 to 2015 with data extracted from the VISION model [-@Zhou2014] (1970 - 2007) and from the Annual Energy Outlook (2007 to 2015) of the U.S. EIA [-@U.S.EnergyInformationAdministration2007; -@U.S.EnergyInformationAdministration2008; -@U.S.EnergyInformationAdministration2009; -@U.S.EnergyInformationAdministration2010; -@U.S.EnergyInformationAdministration2011; -@U.S.EnergyInformationAdministration2012; -@U.S.EnergyInformationAdministration2013; -@U.S.EnergyInformationAdministration2014; -@U.S.EnergyInformationAdministration2015; -@U.S.EnergyInformationAdministration2016; -@EIA2017; -@EIA2018]. Historical vintage stock are built from historical sales and stocks, annual estimates of scrapped vehicles and some adjustments.

####Survival rates

A survival rate represents the probability for a vehicle to stay operational in the fleet knowing it was operational in the previous year. Survival rates determine the number of surviving vehicles by vehicle type from one year to another and therefore the number of scrapped vehicles from one year to another.  
In the literature, survival or scrappage rates often represent the probability for a certain model-year vehicle to be operational and is therefore cumulative. The probability decreases with vehicle age [@Greene1981]. Those cumulative distributions are hereunder called cumulative survival rates. Mathematically, the survival rate considered here for a vehicle with a certain age $SR_{age}$ is a conditional probability as presented in the following set of equations:
  
$$SR_{age}=P((op,age)⁄(op,age-1))=\frac{P({op,age}∩{op,age-1})}{P(op,age-1)}$$
with  $P((op,age)⁄(op,age-1))$ the probability for the vehicle to be operational at age "age" knowing it was operational at age "age-1", and $P(op,age-1)$ the probability for the vehicle to be operational at age "age". If a vehicle is operational at age "age", it was operational at age "age-1", the equation therefore becomes:
  
$$SR_{age}=\frac{P(op,age)}{P(op,age-1)}$$
  
Several functions and distributions are available in the literature, as outlined by Bandivadekar [-@Bandivadekar2008]. The survival rates provided by the VISION model are used by default in the model [@Zhou2014]. The distributions are not cumulative and are different for cars and light trucks. The distributions stop at the age of 23 years, therefore, it is assumed that the survival rates after 23 years are held constant. Figure SI.`r fig_num+1` shows the survival rate distribution and the associated cumulative distribution.  

```{r survival_rate,fig.width=5,fig.height=3,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("functions/fleet_survival_rate_f.R")
fleet_survival_rate<-do.call(fleet_survival_rate_f,list(cumulative_rate="n",scrappage_rate="n"))
fleet_cum_survival_rate<-do.call(fleet_survival_rate_f,list(cumulative_rate="y",scrappage_rate="n"))
plot_dt<-rbind(fleet_survival_rate,fleet_cum_survival_rate)
ggplot(plot_dt)+
  geom_line(aes(x=Age,y=value,colour=Size),
            size=1.3)+
  facet_wrap(~Data,scale="fixed")+
  labs(x="Age",y="Survival rate")+
  theme_milovanoff()+
  scale_colour_milovanoff(guide=guide_legend(title="Category"))+
  theme(legend.position = "bottom",
        axis.title.y=element_blank())


fig_cap<-"Survival rates and cumulative survival rates"
fig_num<-fig_num+1
```

It can be noted that the survival rates for light-trucks increase after 23 years according to the VISION model. It therefore means that if a light-truck has survived more than 23 years, it is less likely to be scrapped from one year to another than before. The cumulative survival rate is still decreasing but with a slower pace after 23 years.  

####Vintage stock procedure

The historical vintage stocks are built with the following procedure:

*  The vintage stocks by vehicle type in 1970 are built from the survival rates and the total stock in 1970. The probability distribution to find a vehicle with a certain age in the fleet is built by dividing the cumulative survival rate distributions with the sum of the cumulative survival rates. Then, this probability distribution is multiplied by the on-road vehicle type stock in 1970 as provided by the VISION model [@Zhou2014].
*  From 1971 to 2015, the vintage stock by vehicle type is estimated based on the previous year vintage stock by vehicle type multiplied by the associated survival rates plus the vehicle sales.
*  The stock estimates are then adjusted to match the annual vehicle type stock. If the estimates are higher than the historical stocks, the vintage stock is proportionally adjusted with the following ratio: $Historical_{Stock}/Estimated_{Stock}$. If the estimates are lower than the historical stocks, the stock by age is adjusted only if the adjustment is not higher than the previous year stock of the previous age. Otherwise, the stock by age is capped at the previous year stock of the previous age. In the previous step, the annual sales by vehicle type are not adjusted.  

In the VISION and the U.S. EIA data, important discrepancies are found in the fleet stock values. For example, in the historical data provided by the U.S. EIA, the total light truck stock goes from 96 million in 2013 to 118 million, while the total car stock decreases from 129 to 120 million implying a 13 million vehicles increase in one year (in a market with 15 million annual sales). Similar inconsistencies are found in the VISION data from 2011 to 2012 and 2014 to 2015. It is believed that those discrepancies are due to changes in vehicle category definitions. These inconsistencies do not directly affect the total light-duty vehicle fleet stock after 2015 but drastically affect the 2015 vintage stock and lead to important discrepancies in the number of scrapped vehicles for the forthcoming years. To limit the effects of those inconsistencies, the following changes are made to the data:

*  From 1970 to 2006, the VISION data are considered. Then from 2007 to 2015 the U.S. EIA data from the Annual Energy Outlooks (AEO) are considered.
*  The 2013-2014 stock differences by vehicle category are calculated and distributed in the previous years. It is assumed that those differences are due to vehicles not accounted for before that should appear in the data.
*  It is assumed that those differences are distributed according to the light truck penetration distribution. Therefore, the stock for cars and light trucks are adapted from 1970 to 2013.
*  Finally, the technology stock shares by vehicle category (car vs. light truck) is kept constant and technology-specific stocks are adjusted to the new overall stocks.  

The previous procedure results in an increase of historical light-duty vehicle stock of 13 million in 2013 (first year of inconsistency) compared to the AEO 2014 data which is decreasing in the previous years to attain 1.9 million in 1970.  

####Vintage stock in 2015
By following the previous steps, vintage stocks by vehicle type are built up to 2015. Figure SI.`r fig_num+1` presents the vintage stock in 2015.  

```{r vint_stock_2015,fig.width=6,fig.height=3,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
fleet_vint_stock_f_res <- do.call(fun_res_f,list(fun_name="fleet_vint_stock_f",fast_mode="y"))

plot_col<-subset(fleet_vint_stock_f_res[[1]],Year==2015)
plot_col$Technology[grep("BEV",plot_col$Technology)]<-"BEV"
plot_col$Technology[grep("PHEV",plot_col$Technology)]<-"PHEV"
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_col),c("Value")),response = "Value")
plot_col<-aggregate(data = plot_col,agg.formula,FUN=sum)
#Format
plot_col$Age<-as.numeric(as.character(plot_col$Age))
ggplot(plot_col)+
  geom_col(aes(x=Age,y=Value/10^6,fill=Technology))+
  scale_fill_milovanoff()+
  labs(x="Age",y="On-road vehicles \n (Million unit)")+
  scale_y_continuous(expand=c(0,0))+
  scale_x_continuous(expand=c(0,0))+
  theme_milovanoff(legend_position = "right")+
  theme(plot.title=element_blank(),
        legend.position = c(0.85,0.6),
        legend.background = element_blank())

fig_cap<-"Vintage stock by vehicle type and age in 2015"
fig_num<-fig_num+1
```
  
Important dips in Figure SI.`r fig_num` are due to the U.S. economic recession in 2008 that significantly affected the new vehicle sales.

###SI.3.1.2 Projected vintage stocks

The projected vintage stocks are calculated based on the vintage stock procedure previously described. It is assumed that survival rate distributions are held constant in the future, and the annual light-duty vehicle stock and sales are taken from the AEO 2018 projections [@EIA2018]. The same adjustment procedure is used to match the total light-duty vehicle stocks modeled by the AEO 2018 projections. The following subsection described the different assumptions and scenarios built to obtain the projected vintage stocks.  
The AEO 2018 projections include several side cases and the "reference" case (REF) is considered by default. In addition, to assess a high penetration of electric vehicles, a scenario is built from the AEO 2018 reference case and adapting the Bloomberg Finance Energy outlook of electric vehicle [@BloombergFinanceEnergy2017].  

####Original AEO 2018 light-duty stock scenarios

The AEO 2018 [-@EIA2018] projections include a reference and side cases. The different cases try to capture the interactions between economic changes and energy supply and demand. In this study, three cases are considered: the reference case (REF), the high oil price case (HOP) and the low oil price case (LOP). HOP and LOP cases are considered because of the significant relationships between oil prices and light-duty vehicle stock. The HOP case assumes that the price of Brent crude reaches \$226 per barrel in 2040 (in 2016 dollars), compared to \$109 per barrel in the reference case and \$43 per barrel in the LOP case.  

```{r run_aeo_stock,include=FALSE}
#Source
source("functions/fleet_stock_f.R")
#Other parameters
first_yr=2015
last_yr=2050
#aeo_scen_tbc<-unique(stock_dt$`AEO scenario`)
aeo_scen_tbc<-c("REF","REF_BAU","REF_EV","LOP","LOP_BAU","LOP_EV","HOP","HOP_BAU","HOP_EV")
#aeo_scen_tbc<-c("REF","LOP","HOP")
fleet_stock <- NULL
fleet_scrap <- NULL
fleet_new <- NULL
for (aeo_scen in aeo_scen_tbc){
  fleet_stock_f_res <- do.call(fleet_stock_f,list(aeo_scen=aeo_scen,first_yr=first_yr))
  tmp_st <- fleet_stock_f_res[[1]]
  tmp_st[,"AEO"] <- aeo_scen
  tmp_scrap <- fleet_stock_f_res[[2]]
  tmp_scrap[,"AEO"] <- aeo_scen
  tmp_new <- fleet_stock_f_res[[3]]
  tmp_new[,"AEO"] <- aeo_scen
  #Output
  fleet_stock<-rbind(fleet_stock,tmp_st)
  fleet_scrap<-rbind(fleet_scrap,tmp_scrap)
  fleet_new<-rbind(fleet_new,tmp_new)
}

#Calculate relative value
for (aeo_scen in aeo_scen_tbc){
  for (year in unique(fleet_stock$Year)){
    fleet_stock[fleet_stock$AEO==aeo_scen & fleet_stock$Year==year,"Rel_value"]<-
      subset(fleet_stock,AEO==aeo_scen & Year==year)[,"Value"]/
      sum(subset(fleet_stock,AEO==aeo_scen & Year==year)[,"Value"])*100
    fleet_scrap[fleet_scrap$AEO==aeo_scen & fleet_scrap$Year==year,"Rel_value"]<-
      subset(fleet_scrap,AEO==aeo_scen & Year==year)[,"Value"]/
      sum(subset(fleet_scrap,AEO==aeo_scen & Year==year)[,"Value"])*100
    fleet_new[fleet_new$AEO==aeo_scen & fleet_new$Year==year,"Rel_value"]<-
      subset(fleet_new,AEO==aeo_scen & Year==year)[,"Value"]/
      sum(subset(fleet_new,AEO==aeo_scen & Year==year)[,"Value"])*100
  }
}
```

Figure SI.`r fig_num+1` represents the light-duty vehicle stock associated with the three cases in 2020, 2030, 2040 and 2050. In the low oil prices case (LOP), the fleet is larger than the reference case and the shares of alternative vehicles (such as hybrid or electric vehicles) are also lower. Conversely, in the high oil prices case (HOP), the light-duty vehicle stock is smaller than in the reference case but the shares of alternative vehicles are higher.  

```{r aeo_scen_stock_agg,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=6,fig.height=3}
#RUN CHUNK run_aeo_stock
aeo_scen_tbc<-c("REF","LOP","HOP")
year_tbc<-seq(2020,2050,10)
plot_col<-subset(fleet_stock,AEO%in%aeo_scen_tbc&Year%in%year_tbc)
#Aggregate BEV and PHEV
plot_col$Technology[grep("BEV",plot_col$Technology)]<-"BEV"
plot_col$Technology[grep("PHEV",plot_col$Technology)]<-"PHEV"
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_col),c("Value")),response = "Value")
plot_col<-aggregate(data = plot_col,agg.formula,FUN=sum)
#Format
plot_col$AEO<-factor(plot_col$AEO,levels=aeo_scen_tbc)

ggplot(plot_col)+
  geom_col(aes(x=AEO,y=Value/10^6,fill=Technology))+
  facet_wrap(~Year,ncol=4)+
  scale_y_continuous(expand = c(0.01,0),limits=c(NA,NA))+
  theme_milovanoff(legend_position = "right")+
  scale_fill_milovanoff()+
  labs(y="Light-duty vehicle stock \n (Million units)",x=NULL)+
  theme(axis.text.x = element_text(angle=45,hjust=1,vjust=1))

#Numerical results
#sum(subset(plot_col,Year==2050&AEO=="LOP",select=Value))
#Light truck share in stock
# aeo_scen="LOP"
# 1-sum(subset(plot_col,Year==2050&Size=="Car"&AEO==aeo_scen,select=Value))/sum(subset(plot_col,Year==2050&AEO==aeo_scen,select=Value))
#sum(subset(plot_col,Year==2050 & grepl("BEV",Technology) & AEO=="REF")[,"Rel_value"])
fig_cap<-"Light-duty vehicle stock projections based on the AEO 2018 for REF, HOP and LOP cases"
fig_num<-fig_num+1
```


Figure SI.`r fig_num+1` shows the stock of plug-in electric vehicles (i.e., Battery Electric Vehicles and Plug-in Hybrid Electric Vehicles) by electric range for the three considered AEO 2018 projection scenarios. Long-range electric vehicles will represent most of the electric vehicles in the future.   

```{r aeo_scen_stock_ev,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=6,fig.height=3}
#RUN CHUNK run_aeo_stock
aeo_scen_tbc<-c("REF","LOP","HOP")
year_tbc<-seq(2020,2050,10)
plot_col<-subset(fleet_stock,AEO%in%aeo_scen_tbc & Year%in%year_tbc & (grepl("BEV",Technology)|grepl("PHEV",Technology)))
#Format
plot_col$AEO<-factor(plot_col$AEO,levels=aeo_scen_tbc)

ggplot(plot_col)+
  geom_col(aes(x=AEO,y=Value/10^6,fill=Technology))+
  facet_wrap(~Year,ncol=4)+
  scale_y_continuous(expand = c(0.01,0),limits=c(NA,NA))+
  theme_milovanoff(legend_position = "right")+
  scale_fill_milovanoff()+
  labs(y="Light-duty vehicle stock \n (Million units)",x=NULL)+
  theme(axis.text.x = element_text(angle=45,hjust=1,vjust=1))

#Numerical results
#sum(subset(plot_col,Year==2050&AEO=="LOP",select=value))
#Light truck share in stock
# aeo_scen="REF"
# 1-sum(subset(plot_col,Year==2050&Size=="Car"&AEO==aeo_scen,select=value))/sum(subset(plot_col,Year==2050&AEO==aeo_scen,select=value))

fig_cap<-"Light-duty plug-in electric vehicle stock projections based on the AEO 2018 for REF, HOP and LOP cases"
fig_num<-fig_num+1
```


Figure SI.`r fig_num+1` shows the annual light truck shares in the light duty vehicle stock for the three AEO 2018 cases. The light truck share represents the relative on-road stock of light trucks in the light-duty fleet stock.   

```{r aeo_scen_lt_share,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=4,fig.height=3}
#RUN CHUNK run_aeo_stock
aeo_scen_tbc<-c("REF","LOP","HOP")
plot_line<-subset(fleet_stock,AEO%in%aeo_scen_tbc & Size=="Light truck")
plot_line$AEO<-factor(plot_line$AEO,levels=aeo_scen_tbc)

agg.formula<-reformulate(termlabels = setdiff(colnames(plot_line),c("Technology","Rel_value","Value")),response = "Rel_value")
plot_line<-aggregate(data = plot_line,agg.formula,FUN=sum)
ggplot(plot_line)+
  geom_line(aes(x=Year,y=`Rel_value`,colour=AEO),
            size=1.3)+
  scale_y_continuous(limits=c(0,NA))+
  theme_milovanoff()+
  scale_colour_milovanoff(name="Case")+
  labs(y="Light-truck share \n in new sales (%)",x=NULL)

fig_cap<-"Light-truck shares in the light-duty vehicle stock"
fig_num<-fig_num+1
```

Figure SI.`r fig_num+1` contains the technology market shares of the new light duty sales in the three AEO cases until 2050. The annual technology market share is the annual share of vehicle technologies in the new sales.  

```{r aeo_scen_sales_agg,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=6,fig.height=3}
#RUN CHUNK run_aeo_stock
aeo_scen_tbc<-c("REF","LOP","HOP")
year_tbc<-seq(2020,2050,10)
plot_col<-subset(fleet_new,AEO%in%aeo_scen_tbc & Year%in%year_tbc)
#Aggregate BEV and PHEV
plot_col$Technology[grep("BEV",plot_col$Technology)]<-"BEV"
plot_col$Technology[grep("PHEV",plot_col$Technology)]<-"PHEV"
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_col),c("Value")),response = "Value")
plot_col<-aggregate(data = plot_col,agg.formula,FUN=sum)
#Format
plot_col$AEO<-factor(plot_col$AEO,levels=aeo_scen_tbc)

ggplot(plot_col)+
  geom_col(aes(x=AEO,y=Value/10^6,fill=Technology))+
  facet_wrap(~Year,ncol=4)+
  scale_y_continuous(expand = c(0.01,0),limits=c(NA,NA))+
  theme_milovanoff(legend_position = "right")+
  scale_fill_milovanoff()+
  labs(y="Light-duty vehicle sales \n (Million units)",x=NULL)+
  theme(axis.text.x = element_text(angle=45,hjust=1,vjust=1))

fig_cap<-"Light-duty vehicle technology market shares in the sale projections for REF, HOP and LOP AEO 2018 cases"
fig_num<-fig_num+1

```


Figure SI.`r fig_num+1` presents the market shares of electric vehicles by electric range for the three considered AEO 2018 projection scenarios. Long-range electric vehicles (i.e., BEV300 and PHEV40) will be the predominant vehicles sold in the market.  

```{r aeo_scen_sales_ev,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=6,fig.height=3}
#RUN CHUNK run_aeo_stock
aeo_scen_tbc<-c("REF","LOP","HOP")
year_tbc<-seq(2020,2050,10)
plot_col<-subset(fleet_new,AEO%in%aeo_scen_tbc & Year%in%year_tbc & (grepl("BEV",Technology)|grepl("PHEV",Technology)))

#Format
plot_col$AEO<-factor(plot_col$AEO,levels=aeo_scen_tbc)

ggplot(plot_col)+
  geom_col(aes(x=AEO,y=Value/10^6,fill=Technology))+
  facet_wrap(~Year,ncol=4)+
  scale_y_continuous(expand = c(0.01,0),limits=c(NA,NA))+
  theme_milovanoff(legend_position = "right")+
  scale_fill_milovanoff()+
  labs(y="Light-duty vehicle sales \n (Million units)",x=NULL)+
  theme(axis.text.x = element_text(angle=45,hjust=1,vjust=1))

fig_cap<-"Light-duty electric vehicle technology market shares in the sale projections for REF, HOP and LOP AEO 2018 cases"
fig_num<-fig_num+1

```


####Alternative AEO 2018 light-duty stock scenarios

Among all AEO 2018 cases, the HOP case contains the highest technology market share of electric vehicles (i.e., PHEV, HEV, and BEV). According to this case, around `r format(sum(subset(fleet_new,AEO=="HOP" & Year==2030 & (grepl("BEV",Technology)|grepl("HEV",Technology)),'Rel_value')),digits=0)`% of the new sales are hybrid or electric in 2030 and `r format(sum(subset(fleet_new,AEO=="HOP"&Year==2050&(grepl("BEV",Technology)|grepl("HEV",Technology)),'Rel_value')),digits=0)`% in 2050.  
As one of the paper's objectives is to assess more intense penetration of alternative vehicles, this study also develops alternative scenarios based on the AEO 2018 cases and by adapting the Bloomberg New Energy Finance (BNEF) Electric Vehicle Outlook of 2017 [@BloombergFinanceEnergy2017].  
The alternative scenarios are built by default using the reference case (REF) of the AEO 2018. The High EV Penetration case looks at a high penetration of BEV in the light-duty fleet stock and the No Change case assess a constant technology market share scenario after 2015.  

#####High EV penetration case

The High EV Penetration case adapts the scenario developed in the BNEF Electric Vehicle Outlook of 2017 [@BloombergFinanceEnergy2017]. In this report, electric vehicles account for 530 million out of the world's 1.63 billion vehicles (33%) by 2040 and represent 54% of the new sales. Figure SI.`r fig_num+1` shows the technology market share of EV adapted from the BNEF Outlook for the new sales in the U.S. until 2040.  

```{r bnef_ev,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=5,fig.height=2}
bnef_ev<-read.csv("inputs/bnef_ev.csv",stringsAsFactors = FALSE,check.names = FALSE)
colnames(bnef_ev)[1]<-"Year"
bnef_ev[,"Light truck"]<-bnef_ev[,"Light truck"]*bnef_ev[,"EV % of new car sales"]/100
bnef_ev[,"Car"]<-bnef_ev[,"Car"]*bnef_ev[,"EV % of new car sales"]/100
#Format
plot_dt<-melt(subset(bnef_ev,select=c("Year","Light truck","Car")),id.vars="Year",variable.name = "Data")
ggplot()+
  geom_area(data=plot_dt,aes(x=Year,y=value,fill=Data))+
  labs(y="EV share in \n new sales (%)",x=NULL)+
  theme_milovanoff(legend_position = "right")+
  scale_fill_milovanoff(name=NULL)

fig_cap<-"EV market share in the U.S. light-duty vehicle according to the BNEF"
fig_num<-fig_num+1
```

The High EV Penetration case is built based on the projected BNEF technology market shares included in Figure SI.`r fig_num`, the reference AEO 2018 case (REF) and the following assumptions and steps. The first set of steps create the projected new sales by vehicle type.

*  The BNEF projections are available until 2040. It is assumed that the EV market shares are held constant after 2040.
*  It is assumed that only BEVs are considered in the EV penetration. This assumption potentially exaggerates the total number of alternative vehicles as projected by BNEF as hybrid and plug-in hybrid vehicles could also be considered in their numbers.
*  The market shares among BEV and PHEV according to ranges are kept constant. It means that we adjust the total sales of BEV or PHEV but keep the market share of long-range BEV (i.e., BEV300) constant compared to short-range BEV (i.e., BEV100).
*  If the annual BNEF EV technology market shares by category are lower than the AEO case technology market shares of BEV, the AEO case data are kept.
*  Otherwise, the BNEF EV technology market shares by category are considered by ensuring that it does not contradict the light-truck and car market shares in the AEO case. If it does, the light-truck share of EV is increased.
*  Once the BEV technology market shares are updated, the other technologies are proportionally adjusted (i.e., they keep the same relative market share without BEV).
*  Then, by assuming that the light-duty fleet sales and the light-truck and car shares of the AEO case are kept unchanged, the number of new sales by technology are estimated.  

Once the new sales are updated with the previous steps, the light-duty vehicle vintage stocks from 2015 to 2050 are adapted by technology with the following steps:

*  Based on the initial vintage stock in 2015 and the projected sales, the light-duty vehicle stocks are projected until 2050 without being adjusted to the AEO case total stock.
*  Then the stocks of light-duty vehicles are adjusted by category to match the total light-duty vehicle stock of the AEO case. This adjustment is done by keeping the vehicle technology stock distribution of the first unadjusted estimated stock.  

The outputs of the previous steps are vintage fleet stocks from 2015 to 2050 derived from the AEO 2018 reference case which account for High EV Penetrations as provided by BNEF.

#####No Change case

The hypothetical No Change case is also built to assess the impact of alternative vehicles penetration as originally included in the AEO 2018 reference case. The scenario is based on the AEO 2018 case and assume constant technology market share after 2015. A similar procedure than previously described in the High EV Penetration case is followed. The total light-duty vehicle stocks of the No Change match the total light-duty vehicle stocks of the AEO 2018 references case to ensure comparability.  

#####Alternative scenarios stock results

Figure SI.`r fig_num+1` shows the light-duty vehicle stocks from 2020 to 2050 by vehicle technology for the three stock scenarios (i.e., Original, No Change, High EV penetration) in the default case (i.e., REF case). As presented in the figure, the total light-duty vehicle stocks are similar across the scenarios.  

```{r alt_aeo_scen_stock,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap),fig.width=6,fig.height=3.5}
#RUN CHUNK run_aeo_stock
aeo_scen_tbc<-c("REF","REF_BAU","REF_EV")
year_tbc<-seq(2020,2050,10)
plot_col<-subset(fleet_stock,AEO%in%aeo_scen_tbc & Year%in%year_tbc)
#Aggregate BEV and PHEV
plot_col$Technology[grep("BEV",plot_col$Technology)]<-"BEV"
plot_col$Technology[grep("PHEV",plot_col$Technology)]<-"PHEV"
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_col),c("Value")),response = "Value")
plot_col<-aggregate(data = plot_col,agg.formula,FUN=sum)

plot_col[,"Case"]<-plot_col[,"AEO"]
plot_col[grep("_",plot_col[,"Case"]),"Case"]<-substring(plot_col[grep("_",plot_col[,"Case"]),"Case"],0,as.numeric(regexpr(pattern="_",plot_col[grep("_",plot_col[,"Case"]),"Case"]))-1)
plot_col[,"Scenario"]<-plot_col[,"AEO"]
plot_col[!grepl("_",plot_col[,"Scenario"]),"Scenario"]<-"Original"
plot_col[grep("_EV",plot_col[,"Scenario"]),"Scenario"]<-"High EV"
plot_col[grep("_BAU",plot_col[,"Scenario"]),"Scenario"]<-"No Change"

plot_col$Scenario<-factor(plot_col$Scenario,levels=c("Original","High EV","No Change"))

ggplot(plot_col)+
  geom_col(aes(x=Scenario,y=Value/10^6,fill=Technology))+
  facet_wrap(~Year,ncol=4)+
  theme_milovanoff(legend_position="right")+
  scale_fill_milovanoff()+
  scale_y_continuous(expand=c(0,0))+
  labs(y="Light-duty vehicle stock \n (Million units)",x=NULL)+
  theme(axis.text.x = element_text(angle=45,hjust=1,vjust=1))

#Numerical values
#aeo_scen="REF"
#sum(subset(plot_col,grepl("BEV",Technology)&AEO==aeo_scen&Year==2050,select=Value))/sum(subset(plot_col,AEO==aeo_scen&Year==2050,select=Value))

fig_cap<-"Light-duty vehicle stock projections for REF AEO 2018 case in the original, High EV Penetration and No Change cases"
fig_num<-fig_num+1
```

In this study, the default case is the Original REF as presented in Figure SI.`r fig_num`. The High EV Penetration and No Change cases are derived from the REF case. When different cases are compared, the original scenarios are used (e.g., Original REF compared to Original LOP or Original HOP).

####Vintage fleet stocks from 2015 to 2050

Figure SI.`r fig_num+1` contains the vintage stocks by vehicle type and age in 2020, 2030, 2040 and 2050 with the average light-duty vehicle age in the reference case and original scenario.  

```{r vint_fleet_stock_proj,fig.height=4,fig.width=8,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
fleet_vint_stock_f_res <- do.call(fun_res_f,list(fun_name="fleet_vint_stock_f",fast_mode="y"))
year_tbc<-c(2020,2030,2040,2050)
plot_col<-subset(fleet_vint_stock_f_res[[1]],Year%in%year_tbc)
#Aggregate BEV and PHEV
plot_col$Technology[grep("BEV",plot_col$Technology)]<-"BEV"
plot_col$Technology[grep("PHEV",plot_col$Technology)]<-"PHEV"
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_col),c("Value")),response = "Value")
plot_col<-aggregate(data = plot_col,agg.formula,FUN=sum)

plot_col$Age<-as.numeric(as.character(plot_col$Age))
#Compute the average age of the light-duty fleet
dt_col<-c("Year","Value")
plot_label<-setNames(data.frame(matrix(0,ncol = length(dt_col), nrow = 0),stringsAsFactors = FALSE,check.names = FALSE),dt_col)
for (year in year_tbc){
  average_age<-sum(plot_col$Age[plot_col$Year==year]*plot_col$Value[plot_col$Year==year])/sum(plot_col$Value[plot_col$Year==year])
  plot_label[nrow(plot_label)+1,]<-c(year,average_age)
}
ggplot(plot_col)+
  geom_col(aes(x=Age,y=Value/10^6,fill=Technology))+
  geom_label(data=plot_label,aes(x=22,y=14,label=paste("Average age:\n", format(Value+1,digits=3),"years")))+
  facet_wrap(~Year)+
  scale_fill_milovanoff()+
  labs(x="Age",y="Light-duty vehicle stock \n (Million units)")+
  theme_milovanoff(legend_position = "right")

fig_cap<-"Vintage stock by vehicle type and age in 2020, 2030, 2040 and 2050 and average light-duty fleet age"
fig_num<-fig_num+1
```

####Light-duty fleet stocks from 2015 to 2050

Figure SI.`r fig_num+1` contains the light-duty fleet stock by vehicle type from 2015 to 2050 in the default case.  

```{r proj_fleet_stock, fig.height=3, fig.width=6, fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#RUN CHUNK run_aeo_stock
plot_col<-subset(fleet_stock, AEO=="REF")
#Aggregate BEV and PHEV
plot_col$Technology[grep("BEV",plot_col$Technology)]<-"BEV"
plot_col$Technology[grep("PHEV",plot_col$Technology)]<-"PHEV"
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_col),c("Value")),response = "Value")
plot_col<-aggregate(data = plot_col,agg.formula,FUN=sum)
ggplot(plot_col)+
  geom_col(aes(x=Year,y=Value/10^6,fill=Technology))+
  scale_fill_milovanoff()+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))+
  labs(x=NULL,y="Light-duty vehicle stock \n (Million units)")+
  theme_milovanoff(legend_position = "right")

fig_cap<-"Light-duty fleet stock by vehicle type from 2015 to 2050"
fig_num<-fig_num+1
```


##SI.3.2 Projected fleet kilometers traveled

Once the annual vintage stocks are obtained, they are converted into annual fleet kilometers traveled. The annual fleet kilometers traveled correspond to the annual distance traveled by the light-duty vehicles and are available by vehicle type and age. In this model, fleet kilometers traveled are based on the age-specific distributions of annual vehicle kilometers traveled and annual growth rates to account for increasing use of the light-duty vehicles.  

###SI.3.2.1 VKT distributions per vehicle

The Transportation Energy Data Book [@Davis2016] provides the age-specific distributions of annual kilometer traveled for cars and light trucks (Figure SI.`r fig_num+1`). The distributions account for a higher use of newer vehicles and for a higher use of light-trucks.  

```{r annual_vkt,fig.height=3,fig.width=5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
annual_mileage<-read.csv("inputs/annual_mileage_TEDB.csv", stringsAsFactors = FALSE, check.names = FALSE)
conv<-read.csv("inputs/conversion_units.csv", stringsAsFactors = FALSE, check.names = FALSE,row.names = 1)
plot_line<-melt(annual_mileage,id.vars="Vehicle age",variable.name="Data")
plot_line$value<-plot_line$value*conv["km","1 mile"]

ggplot(plot_line)+
  geom_line(aes(x=`Vehicle age`,y=value,colour=Data),
            size=1.3)+
  theme_milovanoff()+
  scale_x_continuous(expand=c(0,0))+
  scale_colour_milovanoff(name="Category")+
  labs(y="VKT per year")
fig_cap<-"Annual Vehicle Kilometer Traveled by age distribution and category"
fig_num<-fig_num+1
```

###SI.3.2.2 VKT growth rate

As shown in the Transportation Energy Data Book [@Davis2016], the annual vehicle kilometers distributions have evolved in the past. In this model, a VKT growth rate is applied to account for increase in the annual kilometers traveled by vehicles. The growth rates applied by the VISION model are used [@Zhou2014] and presented in Figure SI.`r fig_num+1` relative to the 2015 values. It therefore means that the annual VKT distributions of 2030 are the annual VKT distributions of 2015 multiplied by 1.13. This corresponds to an annual growth rate of 0.82% which is in the range of values mentioned by the U.S. EPA in their joint technical support document with the U.S Department of Transportation (i.e., 0.5%-1.2% depending on the accounting method) [-@U.S.EnvironmentalProtectionAgency2012].  

```{r vkt_growth_rate,fig.height=3,fig.width=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
vkmt_growth_f<-function(y){
      growth_rate=0.008
      years_to_zero_growth=200
      discount_rate=-growth_rate/(years_to_zero_growth*0.8)
      ref_y=2015
      t=ifelse(ref_y>y,0,y-ref_y)
      return(exp(growth_rate*(t)+discount_rate*(t)^2))
}
dt_col<-c("Year","Growth rate")
plot_line<-setNames(data.frame(matrix(0,ncol = length(dt_col), nrow = length(2015:2050)),stringsAsFactors = FALSE,check.names = FALSE),dt_col)
plot_line[,"Year"]<-2015:2050
plot_line[,"Growth rate"]<-vkmt_growth_f(plot_line[,"Year"])

ggplot(plot_line)+
  geom_point(aes(x=Year,y=`Growth rate`),
            size=1.3)+
  geom_line(aes(x=Year,y=`Growth rate`),
            size=1.0)+
  theme_milovanoff()+
  labs(y="Annual VKT growth rate \n (relative to 2015 values)")

fig_cap<-"Growth rate relative to 2015 VKT distributions"
fig_num<-fig_num+1
```

###SI.3.2.3 Annual fleet kilometers traveled by technology type

The annual fleet kilometers traveled are calculated by technology type with the following equation:
  
$${FKT}_{t,y}=(\sum_{age} {VKT}_{t,age} \times {Stock}_{t,age}) \times {GrowthRate}_{y} $$
with ${FKT}_{t,y}$ the fleet kilometers traveled at year "y" for vehicle type "t", ${VKT}_{t,age}$ the vehicle kilometers traveled of vehicle "t" of age "age", ${Stock}_{t,age}$ the stock of vehicle type "t" of age "age" and ${GrowthRate}_{y}$ the vkt growth rate at year "y".  

Figure SI.`r fig_num+1` presents the resulting annual fleet kilometers traveled by vehicle technology. 

```{r annual_fkt,fig.height=3,fig.width=6,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
fleet_vkmt_f_res <- do.call(fun_res_f,list(fun_name="fleet_vkmt_f",fast_mode="y"))
plot_col<-fleet_vkmt_f_res[["fleet_vkmt"]]
plot_col$Technology[grep("BEV",plot_col$Technology)]<-"BEV"
plot_col$Technology[grep("PHEV",plot_col$Technology)]<-"PHEV"
agg.formula<-reformulate(termlabels = setdiff(colnames(plot_col),c("Value")),response = "Value")
plot_col<-aggregate(data = plot_col,agg.formula,FUN=sum)

ggplot(plot_col)+
  geom_col(aes(x=Year,y=Value/10^12,fill=Technology))+
  scale_fill_milovanoff()+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  labs(y=expression(atop("Fleet kilometers traveled","(X 10"^12*" km per year)")),x=NULL)+
  theme_milovanoff(legend_position = "right")
  
fig_cap<-"Annual Fleet Kilometers Traveled by technology"
fig_num<-fig_num+1
```


##SI.3.3 Projected fleet fuel use

Annual fuel usages are computed from the fuel consumption values by vehicle type and the annual kilometers traveled by vehicle type. For PHEV, the utility factors are computed annually based on the range of the PHEV and are used to calculate the amount of electricity and E10 used from the respective fuel consumption and the annual fleet kilometers traveled of PHEV.  

```{r fleet_fuel_use, fig.height=8,fig.width=8,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Called list
source("outputs/functions/read_f.R")
fleet_fuel_u_f_res <- do.call(fun_res_f,list(fun_name="fleet_fuel_u_f",fast_mode="y"))
fuel_use_techno<-fleet_fuel_u_f_res[["fuel_use"]]
ids_names<-colnames(fuel_use_techno)[!grepl(pattern="[[:digit:]]{1}",colnames(fuel_use_techno))]
plot_dt<-melt(fuel_use_techno,id.vars = ids_names,variable.name = "Year")
plot_dt$Year<-as.numeric(as.character(plot_dt$Year))
plot_dt$Scenario[plot_dt$Scenario=="BAU"]<-"No Lightweighting"

lw_order<-c("No Lightweighting","Steel Intensive","Aluminum Intensive","Aluminum Maximum")
plot_dt$Scenario<-factor(plot_dt$Scenario,levels=lw_order)

plot_line<-subset(plot_dt,Scenario!="Adapted Aluminum Maximum")

plot_line[plot_line=="Gasoline"]<-"E10"
plot_line[plot_line=="Ethanol"]<-"E85"

ggplot(plot_line)+
  geom_line(aes(x=Year,y=value,color=Scenario),
            size=1.1)+
  facet_wrap(~paste0(Fuel," (",Unit,")"),scales = "free",ncol=2)+
  scale_x_continuous(expand=c(0,0))+
  labs(y="Annual fuel use (L or kWh)",x=NULL)+
  theme_milovanoff()+
  scale_colour_milovanoff(name="Lightweighting scenario",
                          guide=guide_legend(nrow=2))

fig_cap<-"Annual light-duty fleet fuel use by fuel type and lightweighting scenario"
fig_num<-fig_num+1
```

#SI.4 Automotive Material Flow module

The automotive material flow module estimates the annual amount of recovered materials from scrapped vehicles and the demand of secondary and primary materials of new vehicles based on the recycling content of the scrapped materials. The main methodology and scenarios are based on Modaresi et al. [-@Modaresi2014].  
Figure SI.`r fig_num+1` presents the flows of material considered in the Automotive Material Flow module. Every year, vehicles are scrapped. Based on the vehicle type, age and material composition of the scrapped vehicles, the amount of scrapped material "m" in year "y" is calculated by material (${Scrap}_{y,m}$). The scrapped materials are recovered into the same materials (${Rec}_{y,m}$), lost ($Losses$) and recovered into other materials (${Rec}_{y,m'}$.  
Every year, new vehicles are manufactured. Based on the vehicle type and material composition of the new vehicles, the amount of embodied materials are calculated by material (${Emb}_{y,m}$). The embodied materials represent the quantity of material embodied in the vehicles. However, the amount of supplied materials in the manufacturing process (${Sup}_{y,m}$) is greater than the amount of embodied material due to the process scrap generated in the manufacturing stage (${PScrap}_{y,m}$). The process scrap materials are recovered into recovered material. The material supply is met by primary material, internal secondary material and external secondary material if necessary.     

```{r amf_framework}
fig_cap="Automotive Material Flow framework. Red boundary represents processes that occur annually. Blue boundary represents one material category (i.e., HSS/AHSS, cast iron, mild steel and other steels, wrought aluminum, cast aluminum, and others)"
fig_num<-fig_num+1
```

![`r paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)`](figures_reports/amf_figure.png)

##SI.4.1 Automotive Material Flow equations

The following section describes the mathematical equations to obtain the quantity of primary, internal secondary and external secondary materials.  

$${Scrap}_{y,m}=\sum_{t=1:16}\sum_{age}({Comp}_{t,age,m}*{ScrapVeh}_{t,age,y})$$  

$${Emb}_{y,m}=\sum_{t=1:16}({Comp}_{t,age=0,m}*{NewVeh}_{t,y})$$  

$${PScrap}_{y,m}=\frac{{Emb}_{y,m}*{PSR}_{m}}{1-{PSR}_{m}}$$  

$${Sup}_{y,m}={Emb}_{y,m}+{PScrap}_{y,m}=\frac{{Emb}_{y,m}}{1-{PSR}_{m}}$$  

$${Rec}_{y,m}={PScrap}_{y,m}+\sum_{m'}({Scrap}_{y,m'}*{RR}_{m',m})$$   

$${Prim}_{y,m}=({Sup}_{y,m}-{Rec}_{y,m})*{PrimS}_{y,m}$$  

$${ExSec}_{y,m}=({Sup}_{y,m}-{Rec}_{y,m})*{ExSecS}_{y,m}$$  

with:  

*  $m$ the material, $y$ the year, $t$ the vehicle type and $age$ the vehicle age;
*  ${Scrap}_{y,m}$ the quantity of scrapped material from the scrapped vehicles;
*  ${Comp}_{t,age,m}$ the vehicle material composition;
*  ${ScrapVeh}_{t,age,y}$ the number of scrapped vehicles;
*  ${Emb}_{y,m}$ the quantity of embodied material in the new vehicles;
*  ${NewVeh}_{t,y}$ the number of new vehicles;
*  ${PScrap}_{y,m}$ the quantity of process scrap material from the manufacturing process;
*  ${PSR}_{m}$ the process scrap rate. This rate is in kg of process scrap per kg of manufactured material;
*  ${Sup}_{y,m}$ the quantity of supplied material to manufacture the new vehicles including the process scrap;
*  ${Rec}_{y,m}$ the quantity of recovered material from all the scrapped materials and the new scrap material. It equals the quantity of internal secondary material;
*  ${RR}_{m',m}$ the recovery rate of material $m$ from scrapped material $m'$. This rate is in kg of material per kg of scrapped material;
*  ${Prim}_{y,m}$ the quantity of primary material to supply;
*  ${PrimS}_{y,m}$ the share of primary material in the material to supply once internal secondary material is used;
*  ${ExSec}_{y,m}$ the quantity of external secondary material to supply;
*  ${ExSecS}_{y,m}$ the share of external secondary material in the material to supply once the internal secondary material is used.  



##SI.4.2 Automotive Material Flow inputs

From the previous equations, the following inputs are needed: The process scrap rates by material (${PSR}_{m}$), the recovery rates from the scrapped materials by material (${RR}_{m',m}$) and the primary and external secondary shares (${PrimS}_{y,m}$ and ${ExSecS}_{y,m}$).   
The process scrap rates are taken from the Aluminum Association for "Wrought Aluminum" [-@TheAluminumAssociation2013] and from Modaresi et al. [-@Modaresi2014] for the other materials. The primary and external secondary shares are taken from Modaresi et al. [-@Modaresi2014]. Process scrap rates and primary and external shares are kept constant. Table SI.`r tab_num+1` contains the values of process scrap rates.  

```{r new_scrap_rate}
nw_scrap_rt <-read.csv("inputs/new_scrap_rate.csv",stringsAsFactors = FALSE,check.names = FALSE)
table_dt<-nw_scrap_rt[,c(2,3)]
colnames(table_dt)[2]<-"Process Scrap Rate"

tab_cap="Process scrap rates in kg of process scrap by kg of manufactured material. Source: Modaresi et al."
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```
  
The model preferentially uses internal secondary material (${Rec}_{y,m}$) when available. Remaining materials are sourced from a mix of primary (${PrimS}_{y,m}$) and external secondary (${ExSecS}_{y,m}$) materials. The relative shares of these two sources are held constant at the values provided in Table SI.`r tab_num+1`.  

```{r prim_sec_shares}
prim_sec_share <-read.csv("inputs/prim_sec_share.csv",stringsAsFactors = FALSE,check.names = FALSE)
table_dt<-prim_sec_share[,c(2,3,4)]
colnames(table_dt)[c(2,3)]<-c("Primary share","External secondary share")

tab_cap="Primary and external secondary shares in material supply once internal secondary materials are used"
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```


Recovery rates are also taken from Modaresi et al. [-@Modaresi2014] and are dynamically computed from 2015 to 2050. In 2015, the recovery rates by scrapped material and recovered material are presented in Table SI.`r tab_num+1`. It should be noted that "Cast Iron" and "Steel" are currently recovered in "Construction steel" (i.e., downcycling) and that "Wrought Aluminum" is downcycled in "Cast Aluminum". For all scrapped materials, the overall recovery rates are 0.86 in 2015, which means that 86% of the scrapped materials are recovered either as usable material in the automotive sector (e.g., Cast Aluminum) or in the construction sector (e.g., Construction Steel).  

```{r rr_2015}
rec_rate_hist <-read.csv("inputs/recovery_rate_hist.csv",stringsAsFactors = FALSE,check.names = FALSE)
table_dt<-subset(rec_rate_hist,Year==2015,-Scenario)

colnames(table_dt)[colnames(table_dt)=="Mild steel and other steels"]="Steel"
table_dt[table_dt[,1]=="Mild steel and other steels",1]="Steel"

tab_cap="Recovery rates by scrapped material in 2015"
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap),
             row.names = FALSE)
```


From 2016 to 2050, two scenarios are built from Modaresi et al. [-@Modaresi2014]. By default, the “Business As Usual” scenario considers improvements in the total recovery rates of the scrapped materials but no improvements in the material recycling processes. It therefore means that, in the BAU scenario, “Steel” and “Cast Iron” are downcycled into construction steel and “Wrought Aluminum” into “Cast Aluminum”. Figure SI.`r fig_num+1` presents the recovery rates from 2015 to 2050 for Cast and Wrought Aluminum in the BAU scenario.   

```{r bau_rr,fig.height=2.5,fig.width=6,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("functions/rec_rate_f.R",local = TRUE)
recovery_rt <-do.call(rec_rate_f,list(rec_scen="BAU"))
recovery_rt$Year<-as.numeric(recovery_rt$Year)

plot_dt<-subset(recovery_rt,Year>=2015&`Scrapped material`%in%c("Cast Aluminum","Wrought Aluminum"))

ggplot(plot_dt)+
  geom_line(aes(x=Year,y=value,colour=`Recovered material`),
            size=1.2)+
  facet_wrap(~paste("Scrapped material: \n",`Scrapped material`))+
  labs(y="Recovery rates \n (kg rec./kg scrapped)",x=NULL)+
  theme_milovanoff()+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name=NULL)+
  guides(color= guide_legend(title="Recovered material",
                             ncol=2))

fig_cap<-"Recovery rates for scrapped Cast and wrought Aluminum from 2015 to 2050 in the BAU scenario"
fig_num<-fig_num+1
```


The “Closed Loop” scenario considers the same improvements in the total recovery rates of the scrapped materials but also improvements in the material recycling processes to achieve a 95% recycling of automotive scrapped materials by 2050 [-@Modaresi2014]. In this scenario, it is assumed that "Wrought aluminum" is gradually recycled in "Wrought Aluminum"" and "Cast aluminum" is recycled in "Cast aluminum" [-@Modaresi2014]. "Cast Iron" and "Steel" are also gradually recovered in the same materials. Figure SI.`r fig_num+1` presents the recovery rates in the "Closed Loop" scenario.  

```{r cl_rr,fig.height=5,fig.width=7,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("functions/rec_rate_f.R",local = TRUE)
recovery_rt <-do.call(rec_rate_f,list(rec_scen="CL100"))
recovery_rt$Year<-as.numeric(recovery_rt$Year)

plot_dt<-subset(recovery_rt,Year>=2015)

ggplot(plot_dt)+
  geom_line(aes(x=Year,y=value,colour=`Recovered material`),
            size=1.2)+
  facet_wrap(~paste("Scrapped material: \n",`Scrapped material`))+
  labs(y="Recovery rates \n (kg recovered/kg scrapped)",x=NULL)+
  theme_milovanoff()+
  theme(strip.text = element_text(size=10))+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff()+
  guides(color= guide_legend(title="Recovered material",
                             ncol=2))

fig_cap<-"Recovery rates for scrapped Cast and wrought Aluminum from 2015 to 2050 in the Closed Loop scenario"
fig_num<-fig_num+1
```

##SI.4.3 Automotive Material Flow results

Figure SI.`r fig_num+1` shows the annual primary and secondary supplies in the No Lightweighting, Steel Intensive and Aluminum Maximum scenarios as well as the "Business-as-usual" case for the Automotive Material Flow.  

```{r amf_res,fig.height=6,fig.width=7,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}

source("outputs/functions/read_f.R")
fleet_mfa_f_res <- do.call(fun_res_f,list(fun_name="fleet_mfa_f",fast_mode="y"))
mat_dem_dt<-fleet_mfa_f_res[["mat_dem_dt"]]
dt_l<-c("mat_prim_dt","mat_sec_dt")
dt_names<-c("Primary material","Secondary material")
plot_col<-NULL
for (i in 1:length(dt_l)){
  dt<-dt_l[i]
  tmp_dt<-fleet_mfa_f_res[[dt]]
  #Format to melt
  ids_names<-colnames(tmp_dt)[!grepl(pattern="[[:digit:]]{1}",colnames(tmp_dt))]
  tmp_dt<-melt(tmp_dt, id.vars = ids_names,variable.name = "Year")
  tmp_dt$Year<-as.numeric(as.character(tmp_dt$Year))
  tmp_dt[,"Type"]<-dt_names[i]
  plot_col<-rbind(plot_col,tmp_dt)
}

LWscen_tbc<-c("BAU","Steel Intensive","Aluminum Maximum")
mat_tbc<-c("HSS/AHSS","Mild steel and other steels","Wrought Aluminum" ,"Cast Aluminum")
years_tbc<-c(2015,2030,2050)
plot_col<-subset(plot_col,Scenario%in%LWscen_tbc& Year%in%years_tbc & Material %in% mat_tbc)
plot_col$Scenario[plot_col$Scenario=="BAU"]<-"No Lightweighting"
lwscen_order<-c("No Lightweighting","Steel Intensive","Aluminum Maximum")
plot_col$Scenario<-factor(plot_col$Scenario,levels=lwscen_order)
plot_col$Material[grep("steel",plot_col$Material)]<-"Other steels"
plot_col$Material[plot_col$Material=="Cast Aluminum"]<-"Cast \n Aluminum"
plot_col$Material[plot_col$Material=="Wrought Aluminum"]<-"Wrought \n Aluminum"
ggplot(plot_col)+
  geom_col(aes(x=Scenario,y=value/10^9,fill=Type))+
  facet_grid(Material~Year,scales = "free_y")+
  labs(y="Annual material demand (Mt/yr.)")+
  theme_milovanoff()+
  scale_fill_milovanoff(name="Type of supply")+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle=40,vjust=1,hjust=1))

fig_cap<-"Annual primary and secondary material supplies by lightweighting scenario in the BAU scenario for the Automotive Material Flow module"
fig_num<-fig_num+1
```


Figure SI.`r fig_num+1` shows the primary material production and the internal secondary material recovery in the two automotive material flow scenarios. The "Closed loop" scenario increases the quantity of internal secondary recovery over time except for cast aluminum. Indeed, cast aluminum is assumed to be recycled into wrought aluminum in the "Closed loop" scenario this decreases the quantity of primary aluminum but increase slightly the quantity of primary cast aluminum produced.  

```{r fleet_mfa_sim,  fig.width=8, fig.height=6.5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Extract and compile simulation
source("outputs/functions/read_f.R")
mat_prim_dt<-do.call(read_simulation_f,list(function_tbc="fleet_mfa_f",sim_tbc="sim1",dts_names="mat_prim_dt"))
ids_names<-colnames(mat_prim_dt)[!grepl(pattern="[[:digit:]]{1}",colnames(mat_prim_dt))]
tmp_dt<-melt(mat_prim_dt, id.vars = ids_names,variable.name = "Year")
tmp_dt$Year<-as.numeric(as.character(tmp_dt$Year))
tmp_dt[,"Type"]<-"Primary material production"
plot_line<-tmp_dt
mat_int_sec_dt<-do.call(read_simulation_f,list(function_tbc="fleet_mfa_f",sim_tbc="sim1",dts_names="mat_int_sec_dt"))
ids_names<-colnames(mat_int_sec_dt)[!grepl(pattern="[[:digit:]]{1}",colnames(mat_int_sec_dt))]
tmp_dt<-melt(mat_int_sec_dt, id.vars = ids_names,variable.name = "Year")
tmp_dt$Year<-as.numeric(as.character(tmp_dt$Year))
tmp_dt[,"Type"]<-"Internal secondary material recovery"
plot_line<-subset(rbind(plot_line,tmp_dt),!Material%in%c("Other","Cast Iron"))
#Format
LWscen_tbc<-c("BAU","Steel Intensive","Aluminum Maximum")
plot_line<-subset(plot_line,Scenario%in%LWscen_tbc)
plot_line$Scenario[plot_line$Scenario=="BAU"]<-"No Lightweighting"
lwscen_order<-c("No Lightweighting","Steel Intensive","Aluminum Maximum")
plot_line$Scenario<-factor(plot_line$Scenario,levels=lwscen_order)
plot_line$Material[grep("steel",plot_line$Material)]<-"Other steels"

ggplot(plot_line)+
  geom_line(aes(x=Year,y=value/10^9,colour=Type,linetype=Case),
            size=1.2)+
  facet_grid(Scenario~Material)+
  labs(y="Material production or recovery (Mt/yr)")+
  theme_milovanoff()+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name=NULL,
                          guide=guide_legend(title=NULL,
                                             nrow=1))+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size=rel(0.8),vjust=0.5,hjust=0.6))+
  guides(linetype=guide_legend(title="Automotive material flow scenario"))

fig_cap<-"Primary material production and internal secondary material recovery of cast aluminum, HSS/AHSS, other steels and wrought Aluminum from 2015 to 2050 in three lightweighting scenarios and in the two Automotive Material Flow scenarios"
fig_num<-fig_num+1
```
  
Finally, Figure SI.`r fig_num+1` contains the shares of primary and secondary materials from 2016 to 2050 in three lightweighting scenarios and in the two automotive material flow scenarios (i.e., Business-as-usual and Closed loop). It is noted that share of primary material in "Cast Aluminum" increases in the closed loop compared to the business-as-usual. As previously described, this is due to a hypothetical recycling of cast components into wrought components that decreases the overall share of primary material in the aluminum components.  

```{r fleet_mfa_share_sim,  fig.width=8, fig.height=6.5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Extract and compile simulation
source("outputs/functions/read_f.R")
mat_prim_share_dt<-do.call(read_simulation_f,list(function_tbc="fleet_mfa_f",sim_tbc="sim1",dts_names="mat_prim_share_dt"))
ids_names<-colnames(mat_prim_share_dt)[!grepl(pattern="[[:digit:]]{1}",colnames(mat_prim_share_dt))]
tmp_dt<-melt(mat_prim_share_dt, id.vars = ids_names,variable.name = "Year")
tmp_dt$Year<-as.numeric(as.character(tmp_dt$Year))
tmp_dt[,"Type"]<-"Primary material production"
plot_line<-tmp_dt

mat_sec_share_dt<-do.call(read_simulation_f,list(function_tbc="fleet_mfa_f",sim_tbc="sim1",dts_names="mat_sec_share_dt"))
ids_names<-colnames(mat_sec_share_dt)[!grepl(pattern="[[:digit:]]{1}",colnames(mat_sec_share_dt))]
tmp_dt<-melt(mat_sec_share_dt, id.vars = ids_names,variable.name = "Year")
tmp_dt$Year<-as.numeric(as.character(tmp_dt$Year))
tmp_dt[,"Type"]<-"Internal secondary material recovery"
plot_line<-subset(rbind(plot_line,tmp_dt),!Material%in%c("Other","Cast Iron"))

#Format
LWscen_tbc<-c("BAU","Steel Intensive","Aluminum Maximum")
plot_line<-subset(plot_line,Scenario%in%LWscen_tbc)
plot_line$Scenario[plot_line$Scenario=="BAU"]<-"No Lightweighting"
lwscen_order<-c("No Lightweighting","Steel Intensive","Aluminum Maximum")
plot_line$Scenario<-factor(plot_line$Scenario,levels=lwscen_order)
plot_line$Material[grep("steel",plot_line$Material)]<-"Other steels"

ggplot(plot_line)+
  geom_line(aes(x=Year,y=value,colour=Type,linetype=Case),
            size=1.2)+
  facet_grid(Scenario~Material)+
  labs(y="Material share")+
  theme_milovanoff()+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name=NULL,
                          guide=guide_legend(title=NULL,
                                             nrow=1))+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size=rel(0.8),vjust=0.5,hjust=0.6))+
  guides(linetype=guide_legend(title="Automotive material flow scenario"))

fig_cap<-"Share of primary material and secondary material of cast aluminum, HSS/AHSS, other steels and wrought Aluminum from 2015 to 2050 in three lightweighting scenarios and in the two Automotive Material Flow scenarios"
fig_num<-fig_num+1

#Numerical values
#subset(plot_line,Year==2030&Scenario=="Aluminum Maximum"&Material=="Wrought Aluminum")
```


#SI.5 Life cycle GHG emissions module

Finally, the LCA module converts the results of the previous modules into life cycle GHG emissions. The goal of the module is to estimate the life cycle GHG emissions associated with the U.S. light-duty fleet. The boundaries encompass the life cycle stages of the vehicles and their fuels and are presented in Figure SI.`r fig_num+1`. Figure SI.`r fig_num+1` also summarizes the data sources.    

```{r lca_boundaries}
fig_cap="Life cycle boundaries with sources. Each life cycle phase includes several processes and the arrows represent the links between the phases."
fig_num<-fig_num+1
```


![`r paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)`](figures_reports/lca_boundaries.png)


The dynamic inventories of the vehicle life cycle stages are built with the following assumptions:

*  All the vehicle upstream processes (i.e., material production of steel and aluminum components, manufacturing and assembly) occur at the vehicle sales year.
*  The fuel production and use phases occur along the vehicle lifetime in the fleet and simultaneously.
*  The end-of-life stage takes place when the vehicles are scrapped.  

The GHG emissions are estimated using the 100-year Global Warming Potential of the IPCC2013 5^th^ assessment report [@Stocker2013]. The aggregated processes presented Figure SI.`r fig_num` include the life cycle stages associated with the processes except for the stages explicitly shown elsewhere in the boundaries (e.g., Wrought Aluminum manufacturing process includes the life cycle inventories of rolling, stamping and extruding wrought aluminum components but does not include the primary or secondary productions of aluminum). It is noted that other materials than steel, cast iron and aluminum are not accounted in the life cycle GHG emissions. They are not expected to vary in mass across the lightweighting scenario and represent less than 3% of the vehicle-life cycle GHG emissions [@ArgonneNationalLaboratory2017].  

For the production emissions of new vehicles, we do not account for the production emissions associated with exported vehicles and assume the production emissions of imported vehicles are equivalent to those of locally produced vehicles. In 2017, around 17.1 million vehicles were sold in the U.S., 2 million vehicles were exported, 8.3 million vehicles imported and 10.8 million vehicles locally produced[@InternationalTradeAdministration2018].  

We use a "Recycled content" approach, as is used in the GREET model[@ArgonneNationalLaboratory2017], for the emissions calculations. This means that secondary materials are assumed to be free from primary material burdens and recycling of scrapped materials is not included and does not generate any credits. We include the industrial processes required to convert scrap materials from vehicles into secondary materials for vehicle production but surplus recovered aluminum and steel do not provide any credits. This approach may overestimate some material production emissions as some materials, such as steel, may be recovered into construction steel and may displace other materials. However, estimating the displaced production from recycling is a challenging task that goes beyond the scope of this study[@Zink2016].  
Three different sources and methods are used to estimate the emission factors: the GREET model version 2017 [@ArgonneNationalLaboratory2017], literature data and finally from ecoinvent version 3.3 [@Wernet2016].    

##SI.5.1 Static life cycle GHG emission factors

Table SI.`r tab_num+1` contains the life cycle GHG emission factors kept static from 2016 to 2050 in the study. The emission factors sourced GREET are taken from the GREET model version 2017 [@ArgonneNationalLaboratory2017] with the associated names (e.g., "GREET: Cast Iron" is the emission factor of "Cast Iron" production in the GREET model).   

The life cycle GHG emission factor of battery production is derived from a study by Kim et al. [-@Kim2016a]. The factor is applied to HEVs, BEVs, PHEVs and FCVs.   

The emission factors of "Mild steel and other steels" primary production, secondary production and manufacturing are taken from the USCB model [@Geyer2017] developed for World Auto Steel. Manufacturing emission factor of steel is estimated by assuming 78% of "flat carbon steel", 22% of "long & special steel" and a fraction of hot rolled coil steel in flat steel of 0.25 (the rest is hot-dip galvanized steel). Finally, it is assumed that the life cycle emission factor of primary HSS/AHSS production is the same as primary conventional steel production [@Kim2010]. This assumption is based on a note at the end of a study by Kim and al. [-@Kim2010]: "World Auto Steel communicated its understanding that the difference in the industry average carbon intensity between HSS and primary steel is not expected to exceed 5%". Sensitivity to this assumption is assessed by taking a high ratio of 1.1 (i.e., 10% increase) in SI 6.5. Emission factors of secondary production and manufacturing of HSS/AHSS are assumed the same as for conventional steel.  

Emission factors of aluminum primary production and of electricity production are estimated separately and dynamically as they possess high spatial and temporal variations [@McMillan2009a]. It is noted that "other materials" are not accounted in the life cycle GHG emissions as we believe it does not vary across the scenarios.  

```{r ef_static}
#GREET EF
source("functions/lca_ef_greet_f.R",local=TRUE)
lca_ef_greet<-do.call(lca_ef_greet_f,list())
table_greet<-subset(lca_ef_greet,select=-Source)
#Inputs 
process_name<-read.csv("inputs/LCA_process.csv",stringsAsFactors = FALSE)
#Add reference in GREET
for (r in 1:nrow(table_greet)){
  table_greet[r,"Source"]<-paste("GREET:",subset(process_name,subset=Phase==table_greet[r,"Phase"]&Process==table_greet[r,"Process"],select=GREET))
}

#Lit EF
source("functions/lca_ef_lit_f.R",local=TRUE)
lca_ef_lit<-do.call(lca_ef_lit_f,list())
##Battery EF
table_ev_bat_dt<-lca_ef_lit[1,]
table_ev_bat_dt[,"Technology"]<-NULL
table_ev_bat_dt[,"Source"]<-"Kim et al."
##Steel and HSS EF
table_lit_ef<-subset(lca_ef_lit,!grepl("Battery",Phase),-Technology)
table_lit_ef[,"Source"]<-"UCSB"
table_lit_ef[table_lit_ef$Phase=="Primary Material Production"&table_lit_ef$Process=="HSS/AHSS","Source"]<-"UCSB with ratio from Kim, McMillan, Keoleian and Skerlos"

#Append all tables
table_dt<-rbind(table_greet,table_ev_bat_dt,table_lit_ef)
#Format
colnames(table_dt)[colnames(table_dt)=="GWP100"]<-"Emission factors"
table_dt[,"Unit"]<-paste0("kg CO2 eq.",substring(table_dt[,"Unit"],3,20))
table_dt[table_dt=="Gasoline"]<-"E10"
table_dt[table_dt=="Ethanol"]<-"E85"


tab_cap="Life cycle emission factors kept constant in the model from various sources"
tab_num=tab_num+1
knitr::kable(table_dt,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap),
             row.names = FALSE,
             digits=2)
```


##SI.5.2 Life cycle GHG emission factors of electricity production

Life cycle GHG emission factors of electricity production in the U.S. are computed annually from 2015 to 2050 from the "Electricity Generation by electricity market region" of the AEO 2018 [@EIA2018] and the life cycle inventories of electricity production in the U.S. of ecoinvent version 3.3 [@Wernet2016]. The three previously described AEO cases are considered (reference REF, low-oil prices LOP and high-oil prices HOP cases). Figure SI.`r fig_num+1` shows the U.S. grid mix by sources and the life cycle GHG emission factors of electricity production in the U.S. in 2015, 2030 and 2050.   

```{r us_elec_mix,fig.width=7, fig.height=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Source
source("functions/lca_ef_elec_f.R",local=TRUE)
#Input
us_elec_mix <- read.csv("inputs/us_elec_mix.csv", stringsAsFactors = FALSE, check.names = FALSE)
plot_col <- subset(us_elec_mix,Source!="Total")
aeo_scen_tbc<-c("REF","HOP","LOP")

#Create dataset with EF
dt_col<-c("AEO","Year","Unit","value")
ef_elec_dt<-setNames(data.frame(matrix(0,ncol = length(dt_col), nrow = 0),stringsAsFactors = FALSE,check.names = FALSE),dt_col)
for (aeo_scen in aeo_scen_tbc){
  ef_value<-do.call(lca_ef_elec_f,list(aeo_scen=aeo_scen))
  ef_value[,"AEO"]<-aeo_scen
  ef_elec_dt<-rbind(ef_elec_dt,ef_value)
}

plot_point<-subset(ef_elec_dt,subset=Year%in%c(2016,2030,2050))
ggplot()+
  geom_col(data=subset(plot_col,subset=Year%in%c(2016,2030,2050)),aes(x=Aeo_case,y=rel_Value*100,fill=Source))+
  geom_point(data=plot_point,aes(x=AEO,y=value*100,shape="Emission Factor"))+
  facet_wrap(~Year)+
  labs(y="Annual U.S. Grid Mix (%)",x=NULL)+
  scale_y_continuous(sec.axis = sec_axis(~./100,name=expression(atop("Grid mix Emission Factor","(kg CO"[2]*" eq. / kWh)"))),expand=c(0.01,0))+
  scale_fill_milovanoff(name="Source")+
  scale_shape(name=NULL)+
  theme_milovanoff(legend_position = "right")+
  theme(axis.title.y.right =element_text(angle=90,vjust=1.1),
        axis.text.x = element_text(angle=40,hjust=1,vjust=1))

fig_cap<-"Annual U.S. grid mix by source and annual U.S. life cycle GHG emission factor of electricity production in 2015, 2030 and 2050 by AEO scenario (REF=reference case, LOP=Low-oil price case and HOP=High-oil price case)"
fig_num<-fig_num+1
```

Life cycle GHG emission factors do not vary greatly between the AEO cases (e.g., `r format(subset(plot_point,AEO=="HOP" & Year==2050)[,"value"]*100,digits=3)` and `r format(subset(plot_point,AEO=="LOP" & Year==2050)[,"value"]*100,digits=3)` kg CO~2~ eq. per MWh in the high-oil price and low-oil price cases in 2050, respectively) and reduce by `r format((1-subset(plot_point,AEO=="REF" & Year==2050)[,"value"]/subset(plot_point,AEO=="REF" & Year==2016)[,"value"])*100,digits=3)`% from 2016 to 2050 (e.g., from `r format(subset(plot_point,AEO=="REF" & Year==2016)[,"value"]*100,digits=3)` to `r format(subset(plot_point,AEO=="REF" & Year==2050)[,"value"]*100,digits=3)` kg CO~2~ eq. per MWh in the reference case).   

##SI.5.3 Life cycle GHG emission factor of primary aluminum consumption

The life cycle GHG emission factors of primary aluminum consumption in the U.S. are calculated from 2015 to 2050. First, the life cycle GHG emission factors of primary aluminum production are calculated for the ten producing regions defined by the ecoinvent database [@Wernet2016] from 2015 to 2050. Then, the U.S. consumption mixes of primary aluminum by producing region are computed from the trade data of UN Comtrade [@resourcetradeearth] and the production data of USGS [@U.S.GeologicalSurvey2018]. Finally, the life cycle GHG emission factors of primary aluminum consumption in the U.S. are computed from 2015 to 2050.  

###SI.5.3.1 Life cycle GHG emission factors of primary aluminum production

The GHG emission factors of primary aluminum production possess the life cycle boundaries described in Figure SI.`r fig_num+1`.  

```{r lca_prim_alu_boundaries}
fig_cap="Life cycle boundary of primary aluminum production"
fig_num<-fig_num+1
```

![`r paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)`](figures_reports/lca_prim_alu_boundaries.png)


The GHG emission factors of primary aluminum production are regionally computed in the following producing regions as defined by the ecoinvent database and the International Aluminium Institute: CA-QC (Canada, North America); CN (China); IAI Area 1 (Africa); IAI Area 2, without Quebec (U.S. and Mexico, North America); IAI Area 3	(South America); IAI Area 4&5 without China	(Asia without China); IAI Area 8 (Gulf Cooperation Council); UN-EUROPE (Europe) and UN-OCEANIA	(Oceania). The inventories of aggregated processes presented in blue in Figure SI.`r fig_num` are derived from the ecoinvent database version 3.3 [@Wernet2016] and are region specific. The following changes are made to the original ecoinvent process inputs:   

*  Electricity production processes are computed from the region-specific life cycle inventories of electricity medium voltage production of the ecoinvent database and the mixes taken from the International Aluminium Institute electricity mixes by region. The 2015 mixes (Figure SI.`r fig_num+1`) are considered and kept constant until 2050.  


```{r elec_input_alu,fig.width=7, fig.height=5.5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
iai_elec_mix<-read.csv("inputs/primary_alu/electricity/elec_mix_IAI_2000-2015.csv",stringsAsFactors = FALSE,check.names = FALSE)
ids_names<-c("Year","Region")
plot_col<-melt(subset(iai_elec_mix,Year%in%2015&Region!="RoW"),id.vars = ids_names,variable.name = "Source")
source("functions/lca_elec_alu_ind_f.R",local=TRUE)
lca_elec_alu_ind_f_res<-do.call(lca_elec_alu_ind_f,list())
plot_point<-subset(lca_elec_alu_ind_f_res[["ef_elec_alu_ind"]],Year%in%2015&Region!="RoW")
plot_point$value<-as.numeric(plot_point$value)
breaks_reg<-c("CA-QC","CN","IAI Area 1","IAI Area 2, without Quebec","IAI Area 3","IAI Area 4&5 without China","UN-EUROPE","UN-OCEANIA","IAI Area 8")
labels_reg<-c("Canada","China (Asia)","Africa","Rest of North America","South America","Rest of Asia","Europe","Oceania","Gulf Cooperation Council")
plot_col$Source<-gsub("electricity production, ","",plot_col$Source)

ggplot()+
  geom_col(data=plot_col,aes(x=Region,y=value*100,fill=Source))+
  geom_point(data=plot_point,aes(x=Region,y=value*50,shape="Electricity production \n emission factor"),
             size=2)+
  theme_milovanoff(legend_position = "right")+
  labs(y="Electric grid mix for aluminum industries (%)",x=NULL)+
  scale_y_continuous(sec.axis = sec_axis(~./50,name=expression("Grid mix Emission Factor (kg CO"[2]*" eq. / kWh)")),expand=c(0.01,0))+
  scale_x_discrete(breaks=breaks_reg,labels=labels_reg)+
  scale_fill_milovanoff(name="Source",guide=guide_legend())+
  scale_shape(name=NULL)+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        axis.title.y.right =element_text(angle=90,vjust=1.1))

fig_cap<-"Electric grid mix for aluminum industries by producing region and source. From International Aluminium Institute."
fig_num<-fig_num+1
```


*  The inputs of the processes presented in the LCA boundary are derived from the ecoinvent unit processes and are region specific. They are kept constant from 2015 to 2050 except for the electricity consumption of the aluminum smelting process (i.e., the electricity input of the aluminum liquid production process). The International Aluminium Institute provides the electric efficiency of the aluminum smelting process from 2000 to 2015 by producing region. Then, the electricity efficiency values are projected from 2015 to 2050 based on the linear regression of 2000-2015 values. Annual improvements for most of the producing regions are from 0.3% to 0.5%.  

Figure SI.`r fig_num+1` contains the life cycle GHG emission factors of primary aluminum production by region from 2015 to 2050.

```{r prim_alu_lca,fig.width=6, fig.height=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
lca_prod_prim_alu_f_res <- do.call(fun_res_f,list(fun_name="lca_prod_prim_alu_f",fast_mode="y"))
plot_line<-subset(lca_prod_prim_alu_f_res[["ef_prod_alu"]], Region!="RoW"&value!=0)
breaks_reg<-c("CA-QC","CN","IAI Area 1","IAI Area 2, without Quebec","IAI Area 3","IAI Area 4&5 without China","UN-EUROPE","UN-OCEANIA","IAI Area 8")
labels_reg<-c("Canada","China","Africa","Rest of North America","South America","Rest of Asia","Europe","Oceania","GCC")
ggplot(plot_line)+
  geom_line(aes(x=Year,y=value,colour=Region,linetype=ifelse(Year>2016,"Projection","Historic")),
            size=1.2)+
  labs(y=expression("Prim. aluminum production (kg CO"[2]*"eg. / kg)"),x=NULL)+
  theme_milovanoff(legend_position = "right")+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name="Region",
                          breaks=breaks_reg,
                          labels=labels_reg,
                          guide=guide_legend(order=2,ncol=1))+
  scale_linetype(name=NULL,
                 guide=guide_legend(order=1,keywidth=unit(1,"cm")))+
  theme(axis.title.y = element_text(hjust=0.81,vjust=0))
  

fig_cap<-"GHG emission factors of primary aluminum production by producing region from 2000 to 2050."
fig_num<-fig_num+1
```

###SI.5.3.2 U.S. consumption mix of primary aluminum by producing region

In 2015, the United States produced 1587 kilotons (kt) of primary aluminum and imported for consumption 4560 kt of crude and semi manufactures aluminum products [@U.S.GeologicalSurvey2018]. As shown previously, the primary aluminum produced in other regions possesses very different emission factors than the primary aluminum produced in the U.S. To calculate the emission factors of the primary aluminum consumed in the U.S. from 2015 to 2050, a region-specific material flow of primary aluminum consumption is built in the U.S. The following method and assumption are regarded:

*  From 2000 to 2016, primary aluminum production volumes in the U.S. are taken from the U.S. Geological Survey (USGS) data [@U.S.GeologicalSurvey2018].
*  From 2000 to 2016, imports of primary aluminum in the U.S. are derived from the UN Comtrade database [@resourcetradeearth]. The considered commodity is the commodity number 76.01 with the HS code entitled “Unwrought Aluminium”. The amounts of traded aluminum are aggregated by producing region.
*  From 2000 to 2016, the consumption mixes of primary aluminum in the U.S. by producing region are calculated by dividing the U.S. production and imports by region with the sum of the production and imports. Figure SI.`r fig_num+1` shows the U.S. consumption mixes by producing regions from 2000 to 2016. It should be noted that the U.S. primary aluminum production plummeted in 2016 at 841 kt which drastically changed the consumption mix.  

```{r mfa_prim_alu_hist,fig.width=7, fig.height=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("outputs/functions/read_f.R")
mfa_prim_alu_f_res <- do.call(fun_res_f,list(fun_name="mfa_prim_alu_f",fast_mode="y"))
alu_cons_reg<-mfa_prim_alu_f_res[["alu_cons_reg"]]
#Format to plot
alu_cons_reg[,"Region"]<-rownames(alu_cons_reg)
ids_names<-colnames(alu_cons_reg)[!grepl(pattern="[[:digit:]]{1}",colnames(alu_cons_reg))]
plot_dt<-melt(alu_cons_reg,id.vars = ids_names,variable.name = "Year")
plot_dt$Year<-as.numeric(as.character(plot_dt$Year))
breaks_reg<-c("CA-QC","CN","IAI Area 1","IAI Area 2, without Quebec","IAI Area 3","IAI Area 4&5 without China","UN-EUROPE","UN-OCEANIA","IAI Area 8")
labels_reg<-c("Canada","China","Africa","Rest of North America","South America","Rest of Asia","Europe","Oceania","GCC")
ggplot(subset(plot_dt,Year<=2016&value!=0&Region!="RoW"))+
  geom_col(aes(x=Year,y=value*100,fill=Region),
           position = "fill")+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0),
                     breaks=seq(0,1,0.25),
                     labels=seq(0,100,25))+
  labs(y=expression("U.S. prim. alumium consumption mix (%)"),x=NULL)+
  theme_milovanoff(legend_position = "right")+
  scale_fill_milovanoff(name="Region",
                        breaks=breaks_reg,
                        labels=labels_reg,
                        guide=guide_legend(ncol=1))+
  theme(axis.title.y = element_text(hjust=0.81,vjust=0))
fig_cap<-"U.S. Consumption mix of primary aluminum by region from 2000 to 2015"
fig_num<-fig_num+1
```


*  Then, from 2015 to 2050, three prospective scenarios are built. The "Constant" scenario assumes the same 2016 mix of producing regions from 2016 onward. The "local" scenario assumes an annual increase of 1% in the U.S. contribution as a producing region in the consumption mix. Finally, the "trends" scenario considers the three regions with the most important 2000-2016 changes in the consumption mixes and their overall trends. The regions are Canada, Gulf Cooperation Council countries and the U.S. with annual rates of 1.5%/yr, 0.6%/yr and -1.8%/yr. Those trends are kept from 2017 onward. In the "local" and "trends" scenarios, the unchanged regions are proportionally adapted to obtain 100% consumption mixes. By default, the model employs the “constant” scenario, while the other two are examined further in the sensitivity analysis in SI.6.5.  

###SI.5.3.3 Emission factors of primary aluminum consumption in the U.S.

The GHG emission factors of primary aluminum consumption in the U.S. are computed by multiplying the regional GHG emission factors of primary aluminum production by the regional contribution ratio in the consumption mix. Figure SI.`r fig_num+1` shows the emission factors of primary aluminum consumption in the U.S. from 2015 to 2050 for the three developed scenarios.  

```{r ef_primary_alu_cons,  fig.width=6, fig.height=3.5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Extract and compile simulation
source("outputs/functions/read_f.R")
lca_ef_prim_alu<-do.call(read_simulation_f,list(function_tbc="lca_ef_prim_alu_f",sim_tbc="sim1",dts_names="lca_ef_prim_alu"))
plot_line<-subset(lca_ef_prim_alu)


ggplot()+
  geom_line(data=subset(plot_line,Year>=2016),aes(x=Year,y=value,colour=Case,linetype="Projection"),
            size=1.2)+
  geom_line(data=subset(plot_line,Year<=2016&Case=="Constant"),aes(x=Year,y=value,linetype="Historic"),
            colour="black",
            size=1.2)+
  labs(y=expression(atop("U.S. emission factors of aluminum","consumption (kg CO"[2]*"eg./kg)")),x=NULL)+
  theme_milovanoff()+
  scale_x_continuous(expand=c(0.01,0))+
  scale_colour_milovanoff(name="Aluminum consumption scenario")+
  scale_linetype(name=NULL,
                 guide=guide_legend(order=1,
                                    keywidth = unit(1,"cm")))+
  theme(axis.title.y = element_text(vjust=0,hjust=0.8))

fig_cap<-"Emission factors of primary aluminum consumption in the U.S. from 2000 to 2050. Plain line represents the historical values (2000-2016). Dotted lines represent projections (2017-2050)."
fig_num<-fig_num+1
```


#SI.6 Additional Results

The following section contains additional results. 

##SI.6.1 Vehicle-based life cycle GHG emissions

Vehicle-based life cycle assessments are built in this study as a basis of the fleet-based assessment. In traditional product-based LCA, the products are compared on an equivalent basis called functional unit, which ensures the product functional equivalency.  Fleet-based assessments, however, depict the fleet as having multiple vehicle characteristics.   
Figure SI.`r fig_num+1` presents the vehicle-based life cycle GHG emissions of conventional and alternative vehicles for the 2015 and lightweighted models. The Aluminum Maximum scenario is the lightweighting scenario.    

```{r fig_veh_lca,  fig.width=7, fig.height=6,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Extract and compile simulation
source("outputs/functions/read_f.R")
stat_LCI<-do.call(read_simulation_f,list(function_tbc="vehicle_lca_f",sim_tbc="sim2",dts_names="stat_LCI"))
lcia<-"GWP100"
stat_LCI<-subset(stat_LCI,subset=LCIA==lcia)
agg.formula<-reformulate(termlabels = setdiff(colnames(stat_LCI),c("Process","Phase","value")),response = "value")
stat_LCI_tot<-aggregate(data = stat_LCI,agg.formula,FUN=sum)
#Estimate GHG reduction (absolute and relative). Technology VS technology in the BAU
for (r in which(stat_LCI_tot$LWscen=="BAU")){
  ref_val<-max(stat_LCI_tot[stat_LCI_tot$Size==stat_LCI_tot[r,"Size"]&stat_LCI_tot$Case==stat_LCI_tot[r,"Case"]&stat_LCI_tot$i_year==stat_LCI_tot[r,"i_year"]&stat_LCI_tot$LWscen==stat_LCI_tot[r,"LWscen"]&stat_LCI_tot$Technology=="ICEV-G","value"])
  stat_LCI_tot[r,paste0("value","_svg")]<-stat_LCI_tot[r,"value"]-ref_val
  stat_LCI_tot[r,paste0("value","_rel_svg")]<-stat_LCI_tot[r,paste0("value","_svg")]/ref_val
}
#Estimate GHG reduction (absolute and relative). Lightweighted VS conven in Aluminum Maximum
for (r in which(stat_LCI_tot$LWscen!="BAU")){
  ref_val<-max(stat_LCI_tot[stat_LCI_tot$Size==stat_LCI_tot[r,"Size"]&stat_LCI_tot$Case==stat_LCI_tot[r,"Case"]&stat_LCI_tot$i_year==stat_LCI_tot[r,"i_year"]&stat_LCI_tot$Technology==stat_LCI_tot[r,"Technology"]&stat_LCI_tot$LWscen=="BAU","value"])
  stat_LCI_tot[r,paste0("value","_svg")]<-stat_LCI_tot[r,"value"]-ref_val
  stat_LCI_tot[r,paste0("value","_rel_svg")]<-stat_LCI_tot[r,paste0("value","_svg")]/ref_val
}
#Technology to compare
LWscen_tbc<-c("BAU","Aluminum Maximum")
techno_tbc<-c("ICEV-G","HEV","PHEV20","PHEV40","BEV100","BEV300")
#techno_tbc<-c("ICEV-G","BEV")
size_tbc<-c("Car","Light truck")
#size_tbc<-c("Light truck")
case_tbc<-c("Curent Lightweighting")
phase_order<-c("Primary Material Production","Secondary Material Production","Battery production and assembly","Manufacturing","Fuel Production","Fuel Use","End of Life")
#case_tbc<-unique(stat_LCI_tot$Case)
#Format plot_col and text
plot_col<-subset(stat_LCI,subset= Technology %in% techno_tbc & Size %in% size_tbc & Case %in% case_tbc & LWscen %in% LWscen_tbc)
plot_col[,"x_axis"]<-paste(plot_col[,"Technology"],plot_col[,"LWscen"])
#plot_col[,"x_axis"]<-gsub(" BAU","",plot_col[,"x_axis"])
plot_col[,"x_axis"]<-factor(plot_col[,"x_axis"],levels=as.character(sapply(techno_tbc,function(x)paste(x,LWscen_tbc))))
plot_col$Phase<-factor(plot_col$Phase,levels=phase_order)

plot_text<-subset(stat_LCI_tot,subset= Technology %in% techno_tbc & Size %in% size_tbc& Case %in% case_tbc& LWscen %in% LWscen_tbc)
plot_text[,"x_axis"]<-paste(plot_text[,"Technology"],plot_text[,"LWscen"])
#plot_text[,"x_axis"]<-gsub(" BAU","",plot_text[,"x_axis"])
#Create y_start and y_end of arrows
plot_text[,"y_start"]<-0
for (r in which(plot_text$LWscen=="BAU")){
  ref_val<-max(plot_text[plot_text$Size==plot_text[r,"Size"]&plot_text$Case==plot_text[r,"Case"]&plot_text$Technology=="ICEV-G","value"])
  plot_text[r,"y_start"]<-ref_val
}
for (r in which(plot_text$LWscen!="BAU")){
  ref_val<-max(plot_text[plot_text$Size==plot_text[r,"Size"]&plot_text$Case==plot_text[r,"Case"]&plot_text$Technology==plot_text[r,"Technology"]&plot_text$LWscen=="BAU","value"])
  plot_text[r,"y_start"]<-ref_val
}
plot_text[,"y_end"]<-plot_text[,"value"]

ggplot(plot_col)+
  geom_col(aes(x=x_axis,y=value/10^3,group=Phase,fill=Phase),
           width=0.7)+
  geom_text(data=subset(plot_text,value_svg!=0),
            aes(x=x_axis,y=(y_start)/10^3,label=paste0(format(value_svg/10^3,digits=1),"t"),colour=LWscen),
            vjust = .1,
            hjust = 0,
            size=3.5,
            show.legend = FALSE)+
  geom_segment(data=subset(plot_text,value_svg!=0),
               aes(x=x_axis,xend=x_axis,y=y_start/10^3,yend=y_end/10^3,colour=LWscen),
               arrow = arrow(length=unit(0.2,"cm")),
               lineend = "square",
               size=0.75)+
  facet_wrap(~Size,ncol=1,scales="free_y")+
  theme_milovanoff()+
  labs(x=NULL,y=expression("Life cycle GHG emissions (t CO"[2]*" eq.)"),title=NULL)+
  coord_cartesian(clip="off")+
  scale_y_continuous(expand=c(0.1,0))+
  scale_fill_milovanoff(guide=guide_legend(ncol=3))+
  scale_colour_milovanoff(breaks = c("Aluminum Maximum", "BAU"),
                          labels = c("Lightweighting","Alternative powertrain"),
                          name = NULL,
                          guide=guide_legend(order=1))+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1),
        legend.box.margin = margin(r=1,unit="cm"))
  
#ggsave("Rplots/vehicle_lca.png",width=10,height=10,dpi=300,units=c("in"))
fig_cap<-"Life cycle GHG emissions of conventional and alternative vehicles in current and lightweighted designs with Aluminum Maximum scenario"
fig_num<-fig_num+1
```


Figure SI.`r fig_num+1` presents the life cycle GHG emission changes due to lightweighting by vehicle type and the associated GHG payback time for the vehicles produced in 2015. The GHG payback time of lightweighting corresponds to the duration that the GHG emission savings during vehicle use offset the increased GHG emissions during production of lightweighted vehicles. 

```{r fig_dyn_vh_lca,  fig.width=6, fig.height=4,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("functions/plots/pay_back_time_f.R")
source("functions/plots/cum_long_dtf_f.R")
#Extract and compile simulation
source("outputs/functions/read_f.R")
dyn_LCI <- do.call(read_simulation_f,list(function_tbc="vehicle_lca_f",sim_tbc="sim2",dts_names="dyn_LCI"))
#Aggregate per phase
agg.formula<-reformulate(termlabels = setdiff(colnames(dyn_LCI),c("Process","Phase","value")),response = "value")
dyn_LCI_tot<-aggregate(data = dyn_LCI,agg.formula,FUN=sum)
#Case to consider
case_tbc<-"Curent Lightweighting"
LWscen_tbc<-setdiff(unique(dyn_LCI_tot$LWscen),"Adapted Aluminum Maximum")
techno_tbp<-c("ICEV-G","HEV","PHEV20","PHEV40","BEV100","BEV300")
size_tbp<-c("Car","Light truck")
cum_dyn_LCI_tot<-do.call(cum_long_dtf_f,list(dtf=subset(dyn_LCI_tot,LWscen%in%LWscen_tbc & Technology%in%techno_tbp & Size%in%size_tbp & Case%in%case_tbc),cum_variable="value",cum_param="Age"))
#Parameters to be plotted
pay_back_dt<-do.call(pay_back_time_f,list(dtf=cum_dyn_LCI_tot,y_axis="value",x_axis="Age",i_x_val=1,f_x_val="last",ref_var="LWscen",ref_case="BAU"))


plot_point<-subset(pay_back_dt)

ggplot(plot_point)+
  geom_point(aes(x=Payback,y=`Final changes`/10^3,colour=Technology,shape=LWscen),
             size=3)+
  facet_wrap(~Size,scales = "free_x")+
  theme_milovanoff()+
  labs(y=expression(atop("GHG changes due to lightweighting",
                         "(t CO"[2]*" eq.)")),
       x="Payback time (years)")+
  scale_colour_milovanoff(name=NULL,
                          guide=guide_legend(nrow=1))+
  scale_shape_manual(name=NULL,
                     values=c(15:17),
                     guide=guide_legend())+
  theme(axis.title.y = element_text(hjust=0.8,vjust=0))
  

fig_cap<-"Payback time and GHG emission reductions due to lightweighting for vehicle-based life cycle assessment by technology and category"
fig_num<-fig_num+1
```
  

Figure SI.`r fig_num+1` presents the life cycle GHG emission changes due to lightweighting by vehicle type divided by the lifetime kilometers traveled.   

```{r fig_veh_lca_vkt,  fig.width=6, fig.height=5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#input
vkmt_lifetime <- read.csv("inputs/vkmt_lifetime.csv", stringsAsFactors = FALSE, check.names = FALSE)
#Extract and compile simulation
source("outputs/functions/read_f.R")
stat_LCI<-do.call(read_simulation_f,list(function_tbc="vehicle_lca_f",sim_tbc="sim2",dts_names="stat_LCI"))
lcia<-"GWP100"
case_tbc<-"Curent Lightweighting"
stat_LCI<-subset(stat_LCI,Case%in%case_tbc)
agg.formula<-reformulate(termlabels = setdiff(colnames(stat_LCI),c("Process","Phase","value")),response = "value")
stat_LCI_tot<-aggregate(data = stat_LCI,agg.formula,FUN=sum)
#Estimate GHG reduction (absolute and relative). Lightweighted VS conven in Aluminum Maximum
for (r in which(stat_LCI_tot$LWscen!="BAU")){
  techno<-stat_LCI_tot[r,"Technology"]
  size<-stat_LCI_tot[r,"Size"]
  vkt<-as.numeric(subset(vkmt_lifetime,Size==size&Technology==techno,Value))
  ref_val<-max(stat_LCI_tot[stat_LCI_tot$Size==stat_LCI_tot[r,"Size"]&stat_LCI_tot$Case==stat_LCI_tot[r,"Case"]&stat_LCI_tot$i_year==stat_LCI_tot[r,"i_year"]&stat_LCI_tot$Technology==techno&stat_LCI_tot$LWscen=="BAU","value"])
  stat_LCI_tot[r,paste0("value","_svg")]<-stat_LCI_tot[r,"value"]-ref_val
  stat_LCI_tot[r,paste0("value","_rel_svg")]<-stat_LCI_tot[r,paste0("value","_svg")]/ref_val
  stat_LCI_tot[r,paste0("value","_svg_vkt")]<-stat_LCI_tot[r,paste0("value","_svg")]/vkt
}
#Technology to compare
LWscen_tbc<-setdiff(unique(stat_LCI_tot$LWscen),c("BAU","Adapted Aluminum Maximum"))
#techno_tbc<-c("ICEV-G","HEV","PHEV","BEV")
techno_tbc<-unique(stat_LCI_tot$Technology)
techno_order<-stat_LCI_tot$Technology[stat_LCI_tot$LWscen=="Aluminum Maximum"&stat_LCI_tot$Size=="Car"][order(stat_LCI_tot$value_svg_vkt[stat_LCI_tot$LWscen=="Aluminum Maximum"&stat_LCI_tot$Size=="Car"])]
#techno_tbc<-c("ICEV-G","BEV")
size_tbc<-c("Car","Light truck")
#Format plot_col and text
plot_col<-subset(stat_LCI_tot,subset= Technology %in% techno_tbc & Size %in% size_tbc & Case %in% case_tbc & LWscen %in% LWscen_tbc)
plot_col$Technology<-factor(plot_col$Technology,levels=techno_order)

ggplot(plot_col)+
  geom_col(aes(x=Technology,y=value_svg_vkt*10^3,group=Size,fill=Size),
           position = position_dodge())+
  facet_wrap(~LWscen,ncol=1,scales="free_y")+
  theme_milovanoff()+
  labs(y=expression(atop("Life cycle GHG changes due to lightweighting","(g CO"[2]*" eq. per VKT)")),x=NULL)+
  scale_y_continuous(expand=c(0.04,0.0))+
  scale_fill_milovanoff(guide=guide_legend(title="Category"))+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1))


#ggsave("Rplots/vehicle_lca.png",width=10,height=10,dpi=300,units=c("in"))
fig_cap<-"Life cycle GHG emission reductions due to lightweighting per vehicle kilometers traveled over the lifetime by technology and category"
fig_num<-fig_num+1
```

It can be noted that the fleet-scale lightweighting GHG emission mitigation potentials are lower than the vehicle-scale lightweighting potentials (i.e., -8 g CO2 eq. per Fleet KT over a 20-year period for Aluminum Maximum applied to the U.S. light-duty fleet compared to -`r format(subset(plot_col,Technology=="ICEV-G" & Size=="Car" & LWscen=="Aluminum Maximum")[,"value_svg_vkt"]*1000,digits=3)` g CO2 eq. of reductions per VKT for a conventional car using gasoline over a vehicle lifetime). The major differences between the fleet-scale and the vehicle-scale results are the gradual adoption of lightweighting in the new vehicles and the gradual penetration of new vehicles in the fleet.  

##SI.6.2 Fleet life cycle GHG emissions


Figure SI.`r fig_num+1` contains the annual GHG emissions by phase of the U.S. light-duty fleet for the No Lightweighting, Steel Intensive, Aluminum Intensive and Aluminum Maximum scenarios.  

```{r fig_fleet_ghg_lw, fig.width=7, fig.height=5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Plot functions
source("functions/plots/arrows_ribbon_f.R")
source("outputs/functions/read_f.R")
fleet_lca_f_res <- do.call(fun_res_f,list(fun_name="fleet_lca_f",fast_mode="y"))
dyn_LCI_phase<-fleet_lca_f_res[["dyn_LCI_phase"]]
emi_inv<-"GWP100"
LWscen_tbc<-c("BAU","Steel Intensive","Aluminum Intensive","Aluminum Maximum")
year_tbc<-c(2020,2030,2040,2050)
dyn_LCI_phase<-subset(dyn_LCI_phase,LWscen%in%LWscen_tbc)
dyn_LCI_phase$LWscen[dyn_LCI_phase$LWscen=="BAU"]<-"No Lightweighting"
#Contribution analysis of phases
for (i in 1:nrow(dyn_LCI_phase)) {
  for (col in emi_inv) {
  dyn_LCI_phase[i, paste0(col, "_rel")] <- dyn_LCI_phase[i, col] /
  sum(dyn_LCI_phase[dyn_LCI_phase$LWscen == dyn_LCI_phase$LWscen[i]
  &dyn_LCI_phase$Year == dyn_LCI_phase$Year[i], col])
  }
}
phase_order<-c("Primary Material Production","Secondary Material Production","Battery production and assembly","Manufacturing","Fuel Production","Fuel Use","End of Life")
dyn_LCI_phase$Phase<-factor(dyn_LCI_phase$Phase,level=phase_order)
lwscen_order<-c("No Lightweighting","Steel Intensive","Aluminum Intensive","Aluminum Maximum")
dyn_LCI_phase$LWscen<-factor(dyn_LCI_phase$LWscen,level=lwscen_order)
#Plot the total annual Fleet GHG emissions for all scenarios
plot_col<-subset(dyn_LCI_phase,Year%in%year_tbc)

ggplot(plot_col)+
  geom_col(data=plot_col,
           aes(x=LWscen,y=get(emi_inv)/10^12,fill=Phase),
           position="stack",
           alpha=0.75)+
  facet_wrap(~Year,ncol=4)+
  theme_milovanoff()+
  labs(y=expression(atop("Annual fleet GHG emissions","(Gt CO"[2]*" eq. per year)")),x=NULL)+
  scale_fill_milovanoff(
                    guide=guide_legend(ncol=3))+
  scale_y_continuous(expand = c(0.02,0),limits=c(NA,NA))+
  theme(axis.text.x = element_text(angle=40,vjust=1,hjust=1))
#ggsave("Rplots/paper_plots/fig3.png",height = 9,width = 10,units="in")
fig_num<-fig_num+1
fig_cap<-"Annual fleet GHG emissions by life cycle phase for No Lightweighting, Steel Intensive, Aluminum Intensive, and Aluminum Maximum scenarios in 2020, 2030, 2040, 2050"

#subset(dyn_LCI_phase,Year==2016&LWscen=="No Lightweighting",select=c(Phase,GWP100,GWP100_rel))
#subset(dyn_LCI_phase,Year==2025,select=c(Phase,GWP100,GWP100_rel))
```

  
```{r table_fig_fleet_ghg_lw, eval=FALSE, include=FALSE}
#Determine the scneairo with deepest annual GHGs reduction
dt_col<-c("Year","Lowest Scenario","Annual GHGs reduciton (Gt CO2)","Annual % reduction")
annual_low_scen<-setNames(data.frame(matrix(0,ncol = length(dt_col), nrow = 0),stringsAsFactors = FALSE,check.names = FALSE),dt_col)
temp_dt<-subset(plot_arrows,LWscen!="BAU")
for (year in unique(temp_dt$Year)){
  scenario<-temp_dt$LWscen[temp_dt$Year==year][which.min(temp_dt$delta_y[temp_dt$Year==year])]
  rel_red<-temp_dt$rel_delta_y[temp_dt$Year==year][which.min(temp_dt$delta_y[temp_dt$Year==year])]
  red<-temp_dt$delta_y[temp_dt$Year==year][which.min(temp_dt$delta_y[temp_dt$Year==year])]
  annual_low_scen[nrow(annual_low_scen)+1,]<-c(year,scenario,red/10^12,rel_red)
}
knitr::kable(annual_low_scen,
             caption="Scenario with deepest annual GHGs reduction")
knitr::kable(plot_text,
             caption="Life cycle contribution in the Aluminum Maximum scenario")
```


Figure SI.`r fig_num+1` presents the annual GHG emission changes by phase due to lightweighting in the Aluminum Maximum scenario. 

```{r fleet_ghg_changes_phase,fig.height=5, fig.width=8,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Functions to plot
source("functions/plots/delta_long_dtf_f.R")
source("functions/plots/cum_long_dtf_f.R")
source("functions/plots/pay_back_time_f.R")
source("outputs/functions/read_f.R")
fleet_lca_f_res <- do.call(fun_res_f,list(fun_name="fleet_lca_f",fast_mode="y"))
dyn_LCI_phase<-fleet_lca_f_res[["dyn_LCI_phase"]]
LWscen_tbc<-"Aluminum Maximum"
dyn_LCI_phase<-subset(dyn_LCI_phase,LWscen%in%c(LWscen_tbc,"BAU"))

#Delta
delta_dyn_LCI_phase<-do.call(delta_long_dtf_f,list(dtf=dyn_LCI_phase,x_axis="Year",y_axis="GWP100",ref_var="LWscen",ref_case="BAU",out_var=NULL))
#Aggregate
agg.formula<-reformulate(termlabels = setdiff(colnames(delta_dyn_LCI_phase),c("GWP100","Phase","delta_GWP100")),response = "delta_GWP100")
delta_dyn_LCI_tot<-aggregate(data = delta_dyn_LCI_phase,agg.formula,FUN=sum)

year_tbc<-2015:2050
plot_col<-subset(delta_dyn_LCI_phase,LWscen%in%LWscen_tbc&Year%in%year_tbc)
plot_line<-subset(delta_dyn_LCI_tot,LWscen%in%LWscen_tbc&Year%in%year_tbc)

ggplot(plot_line)+
  geom_col(data=plot_col,aes(x=Year,delta_GWP100/10^9,fill = Phase))+
  geom_line(data=plot_line,aes(x=Year,delta_GWP100/10^9,color="Total annual changes"),
            size=2)+
  theme_milovanoff()+
  labs(y=expression(atop("GHG changes due to lightweighting","(Mt CO"[2]*" eq.)")),x=NULL)+
  scale_fill_milovanoff(name="Phase",
                        guide=guide_legend(ncol=3))+
  scale_colour_manual(name=NULL,
                      guide=guide_legend(order=1,
                                         keywidth = unit(1,"cm")),
                      values="black")+
  scale_y_continuous(expand = c(0.01,0))+
  scale_x_continuous(expand = c(0.01,0))+
  theme(legend.box.margin = margin(r=2,unit="cm"))
  


  
fig_cap<-"Annual GHG changes due to lightweighting in the Aluminum Maximum scenario by phase"
fig_num<-fig_num+1
```


##SI.6.3 Influence of factors on fleet-scale impact of lightweighting


Figure SI.`r fig_num+1` contains the annual life cycle GHG emission changes due to lightweighting for the Aluminum Maximum and Adapted Aluminum Maximum scenarios in the reference and High EV Penetration fleet stock cases.  

```{r fig_adapted_lw_alt,  fig.height=4, fig.width=5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
source("functions/plots/delta_long_dtf_f.R")
source("functions/plots/cum_long_dtf_f.R")
source("outputs/functions/read_f.R")
dyn_LCI_tot<-do.call(read_simulation_f,list(function_tbc="fleet_lca_f",sim_tbc="sim2",dts_names="dyn_LCI_tot"))
cum_dyn_LCI_tot<-cum_long_dtf_f(dtf = dyn_LCI_tot,cum_variable = "GWP100",cum_param = "Year")
#Calculate the GHGs emissions changes comapred to BAU in all cases
delta_lci_tot<-delta_long_dtf_f(dtf=dyn_LCI_tot,x_axis="Year",y_axis="GWP100",ref_var="LWscen",ref_case="BAU")
delta_cum_tot<-delta_long_dtf_f(dtf=cum_dyn_LCI_tot,x_axis="Year",y_axis="GWP100",ref_var="LWscen",ref_case="BAU")

LWscen_tbc<-c("Aluminum Maximum","Adapted Aluminum Maximum")
case_tbc<-c("Reference","High EV penetration")

#LWscen_tbc<-unique(dyn_LCI_tot$LWscen)
plot_line<-subset(delta_lci_tot,LWscen%in%LWscen_tbc&Case%in%case_tbc)
plot_line$LWscen[plot_line$LWscen=="Adapted Aluminum Maximum"]<-"Adapted Aluminum Maximum"
plot_line$LWscen[plot_line$LWscen=="Aluminum Maximum"]<-"Complete Aluminum Maximum"
plot_line$LWscen<-factor(unique(plot_line$LWscen),levels=c("Complete Aluminum Maximum","Adapted Aluminum Maximum"))

y_val<-"GWP100"
ggplot(data=plot_line)+
  geom_line(aes(x=Year,y=delta_GWP100/10^9,colour=Case,linetype=LWscen),
            size=1.2)+
  scale_y_continuous(limit=c(NA,NA))+
  scale_x_continuous(expand=c(0,0))+
  labs(y=expression(atop("GHG changes due to lightweighting","(Mt CO"[2]*" eq. per year)")),x=NULL)+
  scale_colour_milovanoff(guide=guide_legend(title="Fleet stock case",
                                             ncol=1,
                                             order=1))+
  scale_linetype(guide=guide_legend(title="Lightweighting scenario",
                                    keywidth=unit(1,"cm"),
                                    ncol=1,
                                    order=2))+
  theme_milovanoff()+
  theme(axis.title.y = element_text(hjust=1),
        legend.box.margin = margin(r=2.5,unit="cm"))

fig_cap<-"Annual GHG changes due to lightweighting for the complete and adapted Aluminum Maximum scenarios in the reference and High EV Penetration cases"
fig_num<-fig_num+1

#Numerical values
#subset(delta_cum_tot,Year==2050&LWscen%in%LWscen_tbc)
#subset(delta_cum_tot,Year==2050&LWscen=="Adapted Aluminum Maximum",delta_GWP100)/subset(delta_cum_tot,Year==2050&LWscen=="Aluminum Maximum",delta_GWP100)
```


Figure SI.`r fig_num+1` shows the fleet GHG emissions in different oil price cases and the GHG emission changes due to fuel consumption improvements, alternative powertrain penetration and lightweighting (with Aluminum Maximum).  

```{r fleet_ghg_oil,fig.width=8,fig.height=5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Functions to plot
source("functions/plots/arrows_ribbon_f.R")
source("functions/plots/pay_back_time_f.R")
source("functions/plots/cum_long_dtf_f.R")
#Extract and compile simulation
source("outputs/functions/read_f.R")
sim_tbc<-paste0("sim",c(1,12,13))
y_limits<-c(1,NA)
x_limits<-c(2017,2050)
label_years<-c(2050)
emi_inv<-"GWP100"
y_val<-emi_inv
plot_line<-NULL
plot_ribbon<-NULL
lwscen_to_delete<-c("BAU","Aluminum Intensive","Adapted Aluminum Maximum","Steel Intensive")
for (r in 1:length(sim_tbc)){
  sim=sim_tbc[r]
  dyn_LCI_tot<-do.call(read_simulation_f,list(function_tbc="fleet_lca_f",sim_tbc=sim,dts_names="dyn_LCI_tot"))
  dyn_LCI_tot[,"Simulation"]<-dyn_LCI_tot$aeo_scen
  dyn_LCI_tot[grep("_",dyn_LCI_tot$aeo_scen),"Simulation"]<-substring(dyn_LCI_tot$aeo_scen[grep("_",dyn_LCI_tot$aeo_scen)],0,as.numeric(regexpr(pattern="_",dyn_LCI_tot$aeo_scen[grep("_",dyn_LCI_tot$aeo_scen)]))-1)
  #Rename LWscen
  dyn_LCI_tot$LWscen[dyn_LCI_tot$LWscen=="BAU"&dyn_LCI_tot$Case=="No Change"]<-"Baseline without technological changes"
  dyn_LCI_tot$LWscen[dyn_LCI_tot$LWscen=="BAU"&dyn_LCI_tot$Case=="Fuel consumption improvements"]<-"Baseline with technological changes"
  dyn_LCI_tot$Case[dyn_LCI_tot$Case=="Alternative powertrain and fuel penetration"]<-"Alternative powertrain \n and fuel penetration"
  #plot_line
  plot_line<-rbind(plot_line,subset(dyn_LCI_tot,!LWscen%in%lwscen_to_delete))
  if (length(which(dyn_LCI_tot$LWscen%in%lwscen_to_delete&grepl("lightweighting",dyn_LCI_tot$Case,ignore.case = TRUE)))!=0){
    dyn_LCI_tot<-dyn_LCI_tot[-which(dyn_LCI_tot$LWscen%in%lwscen_to_delete&grepl("lightweighting",dyn_LCI_tot$Case,ignore.case = TRUE)),]
  }
  delta_tot<-arrows_ribbon_f(dtf=dyn_LCI_tot,x_axis="Year",y_axis=emi_inv,var_color="Case",ref_var="order")
  #Output
  plot_ribbon<-rbind(plot_ribbon,delta_tot)
}
case_limit_legend<-setdiff(unique(plot_ribbon$Case),"No Change")
color_fill<-palette_milovanoff[c(4,5,3)]
#Plot the total annual Fleet GHG emissions for all scenarios
ggplot(data=plot_ribbon)+
  geom_ribbon(data=subset(plot_ribbon,Case%in%case_limit_legend),
                aes(x=Year,ymin=y_end/10^12,ymax=y_start/10^12,fill=Case),
                alpha=0.5)+
    geom_line(data=subset(plot_line,grepl("Baseline",LWscen)),
              aes(x=Year,y=get(y_val)/10^12,linetype=LWscen),
              colour="black",
              size=1.33,
              alpha=0.75)+
    geom_line(data=subset(plot_line,!grepl("Baseline",LWscen)),
              aes(x=Year,y=get(y_val)/10^12,colour=LWscen),
              size=1.33,
              alpha=0.75)+
  geom_segment(data=subset(plot_ribbon,Year %in% label_years),
                     aes(x=Year,xend=Year,yend=(y_end/10^12*1.01),y=(y_start/10^12*0.99)),
                     arrow = arrow(length=unit(0.2,"cm")),
                     lineend = "square",
                     size=0.75)+
  geom_label_repel(data=na.omit(subset(plot_ribbon,Year %in% label_years)),
                   aes(x=Year,y=(y_start+y_end)/2/10^12,label=paste(format(delta_y/10^9,digits=2),"Mt")),
                   size=5,
                   fill="white",
                   box.padding=0.15,
                   nudge_x = -2,
                   angle=0)+
  facet_wrap(~Simulation)+
  theme_milovanoff()+
  labs(y=expression("Fleet GHG emissions (Gt CO"[2]*" eq./yr)"),x=NULL)+
  scale_x_continuous(limits=x_limits,expand = c(0.01,0))+
  scale_y_continuous(limits=y_limits,expand = c(0.01,0))+
  scale_colour_manual(values=palette_milovanoff[3],
                      guide = "none")+
  scale_fill_manual(values=color_fill,
                    guide = guide_legend(title=NULL,
                                             title.hjust = 0,
                                             ncol=1,
                                             direction="vertical",
                                             order=2))+
  scale_linetype(guide = guide_legend(title=NULL,
                                      ncol=1,
                                      direction="vertical",
                                      order=1))+
  theme(panel.spacing.x = unit(0.5,"cm"),
        legend.box.margin = margin(r=1,unit="cm"),
        legend.box = "horizontal",
        legend.key.width = unit(0.5,"cm"))

fig_cap<-"Annual fleet GHG emissions in high oil prices (HOP), low oil prices (LOP) and reference (REF) cases with GHG emission changes due to fuel consumption improvements, alternative powertrain and Aluminum Maximum lightweighting"
fig_num<-fig_num+1
```


Figure SI.`r fig_num+1` presents the 2016-2030 and 2016-2050 cumulative GHG changes in the primary and secondary material production phases due to closing the loop of the automotive material flow. The results are shown for the No Lightweighting scenario and the Aluminum Maximum, Aluminum Intensive and Steel Intensive lightweighting scenarios.  

```{r fleet_phase_closed_loop_cum,fig.height=3, fig.width=6,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Functions to plot
source("functions/plots/delta_long_dtf_f.R")
source("functions/plots/cum_long_dtf_f.R")
source("functions/plots/pay_back_time_f.R")
#Extract and compile simulation
source("outputs/functions/read_f.R")
dyn_LCI_phase<-do.call(read_simulation_f,list(function_tbc="fleet_lca_f",sim_tbc="sim22",dts_names="dyn_LCI_phase"))
dyn_LCI_phase$LWscen[dyn_LCI_phase$LWscen=="BAU"]<-"No Lightweighting"

LWscen_tbc<-setdiff(unique(dyn_LCI_phase$LWscen),"Adapted Aluminum Maximum")

cum_lci_phase<-do.call(cum_long_dtf_f,list(dtf=subset(dyn_LCI_phase,LWscen%in%c(LWscen_tbc,"BAU")),cum_variable="GWP100",cum_param="Year"))
year_tbc<-c(2030,2050)
#Delta
delta_dyn_LCI_phase<-do.call(delta_long_dtf_f,list(dtf=subset(cum_lci_phase,Year%in%year_tbc),x_axis="Year",y_axis="GWP100",ref_var="Case",ref_case="BAU",out_var=NULL))
#Aggregate
agg.formula<-reformulate(termlabels = setdiff(colnames(delta_dyn_LCI_phase),c("GWP100","Phase","delta_GWP100")),response = "delta_GWP100")
delta_dyn_LCI_tot<-aggregate(data = delta_dyn_LCI_phase,agg.formula,FUN=sum)

case_tbc<-"Closed loop"
plot_col<-subset(delta_dyn_LCI_phase,Case%in%case_tbc&delta_GWP100!=0)
plot_line<-subset(delta_dyn_LCI_tot,Case%in%case_tbc)

lwscen_order<-c("No Lightweighting","Steel Intensive","Aluminum Intensive","Aluminum Maximum")
plot_line$LWscen<-factor(plot_line$LWscen,levels=lwscen_order)
plot_col$LWscen<-factor(plot_col$LWscen,levels=lwscen_order)

ggplot(plot_line)+
  geom_col(data=plot_col,aes(x=LWscen,delta_GWP100/10^12,fill = Phase))+
  geom_point(data=plot_line,aes(x=LWscen,delta_GWP100/10^12),
            color="black",
            size=2)+
  coord_flip()+
  facet_wrap(~paste0("2016-",Year))+
  theme_milovanoff()+
  labs(y=expression("Cumulative changes due to automotive material loop closing (Gt CO"[2]*" eq.)"),x=NULL)+
  scale_fill_milovanoff(guide=guide_legend(title=NULL,
                                       nrow=1))+
  scale_y_continuous(expand = c(0.01,0))+
  theme(axis.text.x = element_text(hjust=0.9,vjust=1,angle=30),
        axis.title.x = element_text(hjust=1,size=rel(0.9)),
        panel.spacing.x = unit(0.4, "cm"))
  


  
fig_cap<-"2016-2030 and 2016-2050 cumulative GHG emission changes due to closing the automotive material loop by lightweighting scenario"
fig_num<-fig_num+1
```


##SI.6.4 Pace and timing of U.S. light-duty fleet lightweighting

Decreasing the implementation period of the lightweighting scenarios decrease the GHG payback time of lightweighting for the Aluminum Maximum and Aluminum Intensive scenarios. In addition, it increases the absolute cumulative GHG emission reductions due to lightweighting over the period 2016-2050. Figure SI.`r fig_num+1` shows the temporal distribution of cumulative GHG emission changes due to Aluminum Maximum lightweighting and the associated GHG payback time by life cycle stage for a 2-year, 8-year, 14-year and 20-year lightweighting implementation period. In all cases, lightweighting starts in 2016.    

```{r ghgpayback_period,fig.height=5, fig.width=8,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Functions to plot
source("functions/plots/delta_long_dtf_f.R")
source("functions/plots/cum_long_dtf_f.R")
source("functions/plots/pay_back_time_f.R")
#Extract and compile simulation
source("outputs/functions/read_f.R")
dyn_LCI_phase<-do.call(read_simulation_f,list(function_tbc="fleet_lca_f",sim_tbc="sim23",dts_names="dyn_LCI_phase"))
dyn_LCI_phase$lw_first_yr<-as.numeric(dyn_LCI_phase$lw_first_yr)
dyn_LCI_phase$lw_last_yr<-as.numeric(dyn_LCI_phase$lw_last_yr)
dyn_LCI_phase[,"lw_period"]<-dyn_LCI_phase$lw_last_yr-dyn_LCI_phase$lw_first_yr

LWscen_tbc<-"Aluminum Maximum"
#Cumulative
cum_dyn_LCI_phase<-do.call(cum_long_dtf_f,list(dtf=subset(dyn_LCI_phase,LWscen%in%c(LWscen_tbc,"BAU")),cum_variable="GWP100",cum_param="Year"))
#Aggreagate
agg.formula<-reformulate(termlabels = setdiff(colnames(cum_dyn_LCI_phase),c("Phase","GWP100")),response = "GWP100")
cum_dyn_LCI_tot<-aggregate(data = cum_dyn_LCI_phase,agg.formula,FUN=sum)
#Compute the lightweighting GHG pay-back time
lw_pay_back_dt<-pay_back_time_f(dtf=cum_dyn_LCI_tot,y_axis="GWP100",x_axis="Year",i_x_val=2016,ref_var="LWscen",ref_case="BAU")
#Delta
delta_dyn_LCI_phase<-do.call(delta_long_dtf_f,list(dtf=cum_dyn_LCI_phase,x_axis="Year",y_axis="GWP100",ref_var="LWscen",ref_case="BAU",out_var=NULL))
#Aggregate
agg.formula<-reformulate(termlabels = setdiff(colnames(delta_dyn_LCI_phase),c("GWP100","Phase","delta_GWP100")),response = "delta_GWP100")
delta_dyn_LCI_tot<-aggregate(data = delta_dyn_LCI_phase,agg.formula,FUN=sum)

lw_period_tbc<-seq(2,24,by=6)
year_tbc<-2015:2025
plot_col<-subset(delta_dyn_LCI_phase,LWscen%in%LWscen_tbc&lw_period%in%lw_period_tbc&Year%in%year_tbc)
plot_line<-subset(delta_dyn_LCI_tot,LWscen%in%LWscen_tbc&lw_period%in%lw_period_tbc&Year%in%year_tbc)
plot_text<-subset(lw_pay_back_dt,LWscen%in%LWscen_tbc&lw_period%in%lw_period_tbc)

ggplot(plot_line)+
  geom_col(data=plot_col,aes(x=Year,delta_GWP100/10^9,fill = Phase))+
  geom_line(data=plot_line,aes(x=Year,delta_GWP100/10^9),
            color="black",
            size=2)+
  geom_label_repel(data=plot_text,aes(x=lw_first_yr+Payback-1,y=0,label=paste("GHG payback time: \n",format(Payback,digits=2),"years")),
                   nudge_y = -300)+
  facet_wrap(~paste0(lw_first_yr,"-",lw_last_yr," (",lw_period," years)"),nrow=1)+
  theme_milovanoff()+
  labs(y=expression(atop("Cumulative changes due to lightweighting","(Mt CO"[2]*" eq.) by implementation period")),x=NULL)+
  scale_fill_milovanoff(guide=guide_legend(title="Phase",
                                           nrow=3))+
  scale_y_continuous(expand = c(0.01,0))+
  theme(legend.box.margin = margin(r=1.5,unit="cm"),
        axis.text.x = element_text(angle=40,vjust=1,hjust=1))
  


  
fig_cap<-"Temporal distribution of the cumulative GHG emission changes due to Aluminum Maximum lightweighting by life cycle stage for a 2-year, 8-year, 14-year and 20-year lightweighting implementation period and GHG payback time by implementation period"
fig_num<-fig_num+1
```


##SI.6.5 Sensitivity analysis


A single-factor sensitivity analysis is conducted on some of the parameters outlined in the method sections. The sensitivity analysis consists of changing one variable at a time while keeping other variables constant at default values. Table SI.`r tab_num+1` contains the list of assessed variables. The variables are divided into three categories. The "lightweighting submodule" category contains the variables associated with the technical implementation of lightweighting. The "Projection Uncertainties" category" contains the variables related to the projection models. Finally, the "Vehicle Characteristics" category contains the variables associated with the vehicle models. 

```{r sens_var_description}
attribute_value <- read.csv("architecture/attribute_value.csv",stringsAsFactors = FALSE, check.names = FALSE)
attribute_value[,"Category"] <- NA
sens_analysis <- as.data.frame(read_excel("outputs/sens_analysis.xlsx",sheet = "sens_analysis"))
arg_list<-unique(attribute_value$Attribute)
sens_tc<-paste0("sens",1:4)
for (arg in arg_list){
  if (any(grepl(arg,sens_analysis[sens_analysis$Sensitivity %in% sens_tc,"Attributes"]))){
    attribute_value[attribute_value$Attribute==arg,"Category"]<-as.character(subset(sens_analysis, Sensitivity %in% sens_tc &  grepl(arg,Attributes),select=`Sensitivity name`))
  } else {
    attribute_value <- subset(attribute_value,!Attribute%in%arg)
  }
}
#Edits
attribute_value[attribute_value[,"All"]=="1;2;3;4","All"]<-"1: Car->Car & Light-truck->SUV; 2: Car->Car & Light-truck->PUT; 3: Car->SUV & Light-truck->SUV; 4: Car->SUV & Light-truck->PUT"
tab_cap="Variable descriptions of single-factor sensitivity analysis"
tab_num=tab_num+1
knitr::kable(attribute_value[,c("Description","Category","Default","All")],
             row.names = FALSE,
             caption=paste0(ifelse(tab_name,paste0("Table SI.",tab_num,": "),""),tab_cap))
```


Figure SI.`r fig_num+1` represents the 2016-2050 cumulative GHG changes due to Aluminum Maximum, Aluminum Intensive and Steel Intensive lightweighting scenarios. The ranges represent the results for the bounding cases per variable.  

```{r fleet_lca_sens_analysis_alu_max, fig.height=5, fig.width=8,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}

source("functions/plots/tornado_f.R")
tornado_f_res <- do.call(tornado_f,list(function_tbc="fleet_lca_f",scen_tbc="def",sens_tbc=paste0("sens",c(1:4)),dts_names="dyn_LCI_tot",y_axis="GWP100",x_axis="Year",x_val=2050,var_tbc = "LWscen",case_ref="BAU",var_to_sum="n",cumulative="y"))

scen_order <- c("Steel Intensive","Aluminum Intensive","Aluminum Maximum")
plot_bar <- subset(tornado_f_res[["tornado_dtf"]],LWscen%in%scen_order)
plot_bar$LWscen <- factor(plot_bar$LWscen,levels=scen_order)
attr_order <- c(subset(plot_bar, LWscen=="Aluminum Maximum")[order(subset(plot_bar, LWscen=="Aluminum Maximum")$delta,decreasing=TRUE),"Attribute_name"][1:10],"Emission factor for HSS production","Prospective U.S. electricity mixes for BEV and PHEV")
plot_bar <- subset(plot_bar,Attribute_name%in%attr_order)
plot_bar$Attribute_name <- factor(plot_bar$Attribute_name,levels=attr_order)

ggplot(plot_bar)+
  geom_errorbar(aes(x=Attribute_name,ymin=y_start/10^12,ymax=y_end/10^12,colour=LWscen,group=LWscen),
                position = position_dodge(width=0.7),
                size=1.3)+
  geom_point(aes(y=def/10^12,x=Attribute_name,shape="Default changes",group=LWscen),
             position = position_dodge(width=0.7),
             size=1.5)+
  coord_flip()+
  theme_milovanoff()+
  labs(y=expression("Gt CO"[2]*" eq."),x=NULL)+
  scale_y_continuous(limits=c(NA,NA),expand = c(0.05,0))+
  scale_colour_milovanoff(guide= guide_legend(reverse = TRUE,title=NULL,ncol=3))+
  scale_shape(name=NULL)+
  theme(legend.box.margin = margin(t=-0.5,r=5,unit="cm"),
        legend.box = "vertical",
        legend.title.align = 0.5)


        
  
fig_cap<-"Single-factor sensitivity analysis on the cumulative GHG emission changes due to lightweighting in the Aluminum Maximum scenario"
fig_num<-fig_num+1


#Discussion
# attribute_value_min <- tornado_f_res[["attribute_value_min"]]
# attribute_value_max <- tornado_f_res[["attribute_value_max"]]
val5 <- subset(plot_bar,Sens_attribute=="ef_elec_impro" & LWscen=="Aluminum Maximum")[,"y_start"]/subset(plot_bar,Sens_attribute=="ef_elec_impro" & LWscen=="Aluminum Maximum")[,"def"]-1

val3 <- subset(plot_bar,Sens_attribute=="mfa_alu_proj" & LWscen=="Aluminum Maximum")[,"y_start"]/subset(plot_bar,Sens_attribute=="mfa_alu_proj" & LWscen=="Aluminum Maximum")[,"def"]-1
val4 <- 1-subset(plot_bar,Sens_attribute=="mfa_alu_proj" & LWscen=="Aluminum Maximum")[,"y_end"]/subset(plot_bar,Sens_attribute=="mfa_alu_proj" & LWscen=="Aluminum Maximum")[,"def"]
```



```{r disc_elec, message=FALSE, warning=FALSE, paged.print=FALSE}
source("outputs/functions/read_f.R")
source("functions/plots/delta_long_dtf_f.R")
source("functions/plots/cum_long_dtf_f.R")
sim="sim28"
dyn_LCI_tot <- do.call(read_simulation_f,list(function_tbc="fleet_lca_f",sim_tbc=sim,dts_names="dyn_LCI_tot"))
cum_dyn_tot<-do.call(cum_long_dtf_f,list(dtf=dyn_LCI_tot,cum_variable="GWP100",cum_param="Year"))
delta_cum_dts<-delta_long_dtf_f(dtf=cum_dyn_tot,x_axis="Year",y_axis="GWP100",ref_var="LWscen",ref_case="BAU")

plot_point <- subset(delta_cum_dts,Year==2050)
val1 <- subset(plot_point,LWscen=="Aluminum Maximum" & ef_elec_impro=="y")[,"delta_GWP100"]
val2 <- subset(plot_point,LWscen=="Aluminum Maximum" & ef_elec_impro=="n")[,"delta_GWP100"]
```

The results have a low sensitivity to changes in the prospective U.S. electricity mixes for BEV and PHEV electrical usages compared to current values. To be specific, prospective U.S. electricity mixes for BEV and PHEV electrical usages do not influence the cumulative GHG emission changes due to lightweighting in the Adapted Aluminum Maximum scenario as battery electric vehicles are not lightweighted and the electrical energy use is therefore not reduced by lightweighting. Even in the other lightweighting scenarios (when battery electric vehicles are lightweighted), the electricity mix has only a small influence on the GHG emission changes associated with lightweighting. In the AEO 2018 projections, the electricity emission factors are expected to decrease from 2018 onwards (see Figure SI-48). For comparison, as depicted in Figure SI-`r fig_num`, a case with constant electricity mixes from 2018 onwards has `r format(val5*100,digits=1)`% higher cumulative GHG emissions reductions from lightweighting compared to a case with the prospective electricity mixes of the AEO 2018 projections (i.e., from `r format(subset(plot_bar,Sens_attribute=="ef_elec_impro" & LWscen=="Aluminum Maximum")[,"def"]/10^12,digits=3)` Gt CO~2~ eq. to `r format(subset(plot_bar,Sens_attribute=="ef_elec_impro" & LWscen=="Aluminum Maximum")[,"y_start"]/10^12,digits=3)` Gt CO~2~ eq.in the Aluminum Maximum scenario from 2016 to 2050). Indeed, the higher the electricity GHG emissions factor, the greater are the emission reductions associated with lightweighting electric vehicles. The sensitivity of this factor is slightly larger in a case of High EV Penetration, with `r format((val2/val1-1)*100,digits=1)`% more reductions in the Aluminum Maximum lightweighting scenario over the period 2016-2050 in a case with constant emission factors from 2018 onwards.  

The prospective U.S. consumption mixes of primary aluminum affect the cumulative GHG emission changes of aluminum lightweighting. For Aluminum Maximum lightweighting, a scenario with higher contribution of U.S. aluminum production would bring -`r format(val4*100,digits=2)`% GHG emission reductions, and a scenario with continuing trends in aluminum production and imports would bring +`r format(val3*100,digits=2)`% GHG emission reductions compared to our default constant scenario. Indeed, according to the trends showed Figure SI.52 in SI.5.3.2, Canada and Gulf Cooperation Council countries have been increasing their shares in the U.S. aluminum consumption mixes. In addition, they possess lower electricity production GHG emission factors than the U.S. (Figure SI.50 in SI.5.3.1) and ultimately lower primary aluminum production GHG emission factors (Figure SI.51 in SI.5.3.2).  

Figure SI.`r fig_num+1` represents the lowest and highest 2016-2030 and 2016-2050 cumulative GHG emission changes due to lightweighting by lightweighting scenario based on the best and worst cases outlined in the single-factor analysis.  

```{r sens_abal, fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap), fig.height=3, fig.width=6}
source("functions/plots/cum_long_dtf_f.R")
source("functions/plots/delta_long_dtf_f.R")
source("outputs/functions/read_f.R")
min_max_dts <- do.call(read_min_max_f,list(function_tbc="fleet_lca_f",
                            scen_tbc="def",
                            paste0("sens",c(1:4)),
                            dts_names="dyn_LCI_tot",
                            y_axis="GWP100",
                            x_axis="Year",
                            x_val=2050,
                            var_tbc = "LWscen",
                            case_ref="BAU",
                            case_tbs="Aluminum Maximum",
                            var_to_sum="n",
                            cumulative="y"))

cum_dts<-cum_long_dtf_f(dtf=min_max_dts,cum_variable="GWP100",cum_param = "Year")
delta_cum_dts<-delta_long_dtf_f(dtf=cum_dts,x_axis="Year",y_axis="GWP100",ref_var="LWscen",ref_case="BAU")

LWscen_tbc<-c("Steel Intensive","Aluminum Intensive","Aluminum Maximum")
year_tbc<-c(2030,2050)  
plot_bar <- subset(delta_cum_dts,Year%in%year_tbc & Case=="def" & LWscen%in%LWscen_tbc)[,c("LWscen","Year","delta_GWP100")]
plot_bar[,"min"] <- subset(delta_cum_dts,Year%in%year_tbc & Case=="min" & LWscen%in%LWscen_tbc)[,"delta_GWP100"]
plot_bar[,"max"] <- subset(delta_cum_dts,Year%in%year_tbc & Case=="max" & LWscen%in%LWscen_tbc)[,"delta_GWP100"]

plot_bar$LWscen<-factor(plot_bar$LWscen,levels=LWscen_tbc)

ggplot(plot_bar)+
  geom_errorbar(aes(x=LWscen,ymin=min/10^12,ymax=max/10^12,color=LWscen),
                width = 0.5,
                size=1.5)+
  geom_point(aes(x=LWscen,y=delta_GWP100/10^12),size=2,shape=19)+
  coord_flip()+
  facet_wrap(~paste0("2016-",Year))+
  theme_milovanoff()+
  labs(y=expression(atop("Cumulative GHG changes due to lightweighting","(Gt CO"[2]*" eq.)")),x=NULL)+
  scale_y_continuous(limits=c(NA,NA),expand = c(0.05,0))+
  scale_colour_milovanoff(guide=guide_legend(title=NULL,
                                             nrow=1))+
  theme(legend.box.margin = margin(r=2,t=-0.5,unit="cm"),
        axis.title.x = element_text(vjust=1))
        
#Numerical results
abs_red <- subset(delta_cum_dts,LWscen=="Aluminum Maximum" & Year==2050 & Case=="min")[,"delta_GWP100"]/10^12
val <- subset(delta_cum_dts,LWscen=="Aluminum Maximum" & Year==2050 & Case=="min")[,"GWP100"]/10^12
rel_val <- 1-val/(val-abs_red)

fig_cap<-"Cumulative GHG emission changes due to lightweighting by lightweighting scenario in the worst, best and default cases outlined by the single-factor sensitivity analysis"
fig_num<-fig_num+1
```


##SI.6.6 Interactions between GHG emission reduction measures

The implementation order of the GHG emission reduction measures (i.e., fuel consumption improvements, alternative powertrain/fuel penetration and lightweighting) in the simulations matters. Figure SI.`r fig_num+1` shows the contribution of fuel consumption improvements, alternative powertrain and lightweighting using the "Aluminum Maximum" scenario in the 2016-2050 cumulative GHG emission changes compared to a baseline without technological changes (i.e., without fuel consumption improvements, alternative powertrain and lightweighting). Each simulation represents an order of measures modeled. For example, "Technological imp. -> Lightweighting -> Alt. vehicle" means that the model first computes the cumulative GHG emissions without any solution, then the cumulative GHG emissions with fuel consumption improvements alone and calculate the changes; then with fuel consumption improvements and lightweighting and calculate the changes with the previous cases; finally with fuel consumption improvements, lightweighting and alternative powertrain and fuel penetration and calculates the changes with the previous case. 

```{r fleet_cum_overlap,fig.width=8,fig.height=5,fig.cap=paste0(ifelse(fig_name,paste0("Figure SI.",fig_num,": "),""),fig_cap)}
#Functions to plot
source("functions/plots/arrows_ribbon_f.R")
source("functions/plots/pay_back_time_f.R")
source("functions/plots/cum_long_dtf_f.R")
#Extract and compile simulation
source("outputs/functions/read_f.R")
sim_tbc<-paste0("sim",c(1,11,16,17,24,25))
sim_name_tbc<-c("Alt. vehicle -> fuel cons. imp. -> Lightweighting",
                "fuel cons. imp.. -> Alt. vehicle -> Lightweighting",
                "Alt. vehicle -> Lightweighting -> fuel cons. imp.",
                "Lightweighting -> Alt. vehicle -> fuel cons. imp.",
                "Lightweighting -> fuel cons. imp. -> Alt. vehicle",
                "fuel cons. imp. -> Lightweighting -> Alt. vehicle")
lwscen_tbc<-"Aluminum Maximum"
y_limits<-c(1,NA)
x_limits<-c(2017,2050)
years_tbc<-c(2050)
emi_inv<-"GWP100"
tot_colors<-brewer.pal(3+4,"Set1")[4:7]
plot_ribbon<-NULL
for (r in 1:length(sim_tbc)){
  sim=sim_tbc[r]
  dyn_LCI_tot<-do.call(read_simulation_f,list(function_tbc="fleet_lca_f",sim_tbc=sim,dts_names="dyn_LCI_tot"))
  if (length(which(dyn_LCI_tot$LWscen!=lwscen_tbc&grepl("lightweighting",dyn_LCI_tot$Case,ignore.case = TRUE)))!=0){
    dyn_LCI_tot<-dyn_LCI_tot[-which(dyn_LCI_tot$LWscen!=lwscen_tbc&grepl("lightweighting",dyn_LCI_tot$Case,ignore.case = TRUE)),]
  }
  dyn_LCI_tot[,"Simulation"]<-sim_name_tbc[r]
  cum_dyn_LCI_tot<-cum_long_dtf_f(dtf=dyn_LCI_tot,cum_variable = emi_inv,cum_param = "Year")
  delta_tot<-arrows_ribbon_f(dtf=subset(cum_dyn_LCI_tot,Year%in%years_tbc),x_axis="Year",y_axis=emi_inv,var_color="Case",ref_var="order")
  #Output
  plot_ribbon<-rbind(plot_ribbon,delta_tot)
}
#Factor
plot_ribbon$Simulation<-factor(plot_ribbon$Simulation,levels=unique(plot_ribbon$Simulation))
#Cumulative reductions
agg.formula<-reformulate(termlabels = c("Year","Simulation"),response = "delta_y")
plot_tot<-aggregate(data = plot_ribbon,agg.formula,FUN=sum)
cum_red<-format(unique(plot_tot$delta_y)/10^12,digits=3)
plot_title<-paste0("`Overall 2016-2050 cumulative changes compared to No Change: ",cum_red,"Gt CO`[2]*`eq.`")

ggplot(subset(plot_ribbon,Case!="No Change"))+
  geom_col(aes(x=Simulation,y=delta_y/10^12,fill=Case),
           position="dodge")+
  coord_flip()+
  theme_milovanoff()+
  labs(y=expression("2016-2050 Cumulative changes (Gt CO"[2]*" eq.)"),
       x=NULL,
       title=substitute(paste("Overall 2016-2050 cumulative changes compared to No Change: ",cum," Gt CO"[2]," eq."),
                        list(cum = cum_red)))+
  scale_fill_milovanoff(guide=guide_legend(title="GHG emission reduction measure",nrow=3))+
  scale_y_continuous(expand = c(0.01,0))+
  theme(plot.title = element_text(size=13,hjust=1),
        legend.box.margin = margin(r=5,unit="cm"))

  

fig_cap<-"2016-2050 cumulative GHG emission changes for fuel consumption improvements, alternative powertrain and fuel penetration, and Aluminum Maximum lightweighting by order of the simulations"
fig_num<-fig_num+1
```

The total cumulative change before and after the measures is `r cum_red` Gt CO~2~ eq. in all simulations. The cumulative changes of a single measure (for example lightweighting) are assessed on top of the other measures modeled (for example, fuel consumption improvements, alternative powertrain/fuel penetration). It is therefore implemented as the last measure (for example either "Alt. vehicle -> fuel cons. imp. -> Lightweighting" or "fuel cons. imp.. -> Alt. vehicle -> Lightweighting"). The order of the other modeled measures does not influence the GHG emission changes of the single assessed measure.  

#SI.7 Additional discussion

##SI.7.1 Emissions target for the U.S.  

```{r disc_7_1, include=FALSE}
source("outputs/functions/read_f.R")
dyn_LCI_tot<-do.call(read_simulation_f,list(function_tbc="fleet_lca_f",sim_tbc="sim26",dts_names="dyn_LCI_tot"))
#Calculate changes from 2016 to 2025
ghg_inc <- (subset(dyn_LCI_tot,Year==2025 & LWscen=="BAU")[,"GWP100"]-subset(dyn_LCI_tot,Year==2016 & LWscen=="BAU")[,"GWP100"])/10^9
```


In 2015, the United States submitted a Nationally Determined Contribution pledging to reduce GHG emissions in 2025 to 26-28% below 2005 levels. The total 2005 U.S. GHG inventory is estimated at 6.6 Gt CO~2~ eq. Therefore, the emissions target of the United States in 2025 corresponds to a level of 4.8 Gt CO~2~ eq. (i.e., 28% below). The 2016 U.S. GHG inventory are estimated at 5.8 Gt CO~2~ eq. The emissions target in 2025 is 1 Gt CO~2~ below the 2016 level (i.e., 17% reduction compared to 2016)[@U.S.EnvironmentalProtectionAgency2018]. The U.S. light-duty fleet GHG emissions in 2016 according to the U.S. EPA are 1.1 Gt CO~2~ eq. If we assume that all economic sectors have equivalent reductions, a 17% reduction in the U.S. light-duty fleet GHG emissions corresponds to a level of 0.913 Gt CO~2~ eq. in 2025 or a 187 Mt CO~2~ eq. reductions. Based on the reference total fleet stock estimations of the AEO 2018 and considering the same market share of vehicles than 2015, and the fuel consumption values of the 2015-model year vehicles, we estimate in our model that the baseline fleet GHG emissions increases by `r format(ghg_inc,digits=2)` Mt CO~2~ eq. in 2025 compared to 2016. Therefore, attaining the GHG emission target in 2025 in the reference fleet stock case of the AEO 2018 would require 187+`r format(ghg_inc,digits=2)`=`r format(187+ghg_inc,digits=2)` Mt CO~2~ eq. reductions compared to the baseline fleet GHG emissions.  


#References


